<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 5 章 数据操作 | 现代应用统计与 R 语言</title>
<meta name="author" content="黄湘云">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs/header-attrs.js"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/proj4js/proj4.js"></script><link href="libs/highcharts/css/motion.css" rel="stylesheet">
<script src="libs/highcharts/highcharts.js"></script><script src="libs/highcharts/highcharts-3d.js"></script><script src="libs/highcharts/highcharts-more.js"></script><script src="libs/highcharts/modules/stock.js"></script><script src="libs/highcharts/modules/map.js"></script><script src="libs/highcharts/modules/annotations.js"></script><script src="libs/highcharts/modules/data.js"></script><script src="libs/highcharts/modules/drilldown.js"></script><script src="libs/highcharts/modules/item-series.js"></script><script src="libs/highcharts/modules/offline-exporting.js"></script><script src="libs/highcharts/modules/overlapping-datalabels.js"></script><script src="libs/highcharts/modules/exporting.js"></script><script src="libs/highcharts/modules/export-data.js"></script><script src="libs/highcharts/modules/funnel.js"></script><script src="libs/highcharts/modules/heatmap.js"></script><script src="libs/highcharts/modules/treemap.js"></script><script src="libs/highcharts/modules/sankey.js"></script><script src="libs/highcharts/modules/dependency-wheel.js"></script><script src="libs/highcharts/modules/organization.js"></script><script src="libs/highcharts/modules/solid-gauge.js"></script><script src="libs/highcharts/modules/streamgraph.js"></script><script src="libs/highcharts/modules/sunburst.js"></script><script src="libs/highcharts/modules/vector.js"></script><script src="libs/highcharts/modules/wordcloud.js"></script><script src="libs/highcharts/modules/xrange.js"></script><script src="libs/highcharts/modules/tilemap.js"></script><script src="libs/highcharts/modules/venn.js"></script><script src="libs/highcharts/modules/gantt.js"></script><script src="libs/highcharts/modules/timeline.js"></script><script src="libs/highcharts/modules/parallel-coordinates.js"></script><script src="libs/highcharts/modules/bullet.js"></script><script src="libs/highcharts/modules/coloraxis.js"></script><script src="libs/highcharts/modules/dumbbell.js"></script><script src="libs/highcharts/modules/lollipop.js"></script><script src="libs/highcharts/modules/series-label.js"></script><script src="libs/highcharts/plugins/motion.js"></script><script src="libs/highcharts/custom/reset.js"></script><script src="libs/highcharts/modules/boost.js"></script><script src="libs/highchart-binding/highchart.js"></script><script src="libs/es6shim/es6shim.js"></script><script src="libs/es7shim/es7shim.js"></script><script src="libs/graphre/graphre.js"></script><script src="libs/nomnoml/nomnoml.js"></script><script src="libs/nomnoml-binding/nomnoml.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><link href="libs/dygraphs/dygraph.css" rel="stylesheet">
<script src="libs/dygraphs/dygraph-combined.js"></script><script src="libs/dygraphs/shapes.js"></script><script src="libs/moment/moment.js"></script><script src="libs/moment-timezone/moment-timezone-with-data.js"></script><script src="libs/moment-fquarter/moment-fquarter.min.js"></script><script src="libs/dygraphs-binding/dygraphs.js"></script><script src="libs/Dygraph.Plugins.Unzoom/unzoom.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/echarts-world/world.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis.css" rel="stylesheet">
<script src="libs/vis/vis.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><link href="libs/datatables-css/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding/datatables.js"></script><link href="libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core/js/jquery.dataTables.min.js"></script><script src="libs/jszip/jszip.min.js"></script><script src="libs/pdfmake/pdfmake.js"></script><script src="libs/pdfmake/vfs_fonts.js"></script><link href="libs/dt-ext-buttons/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-buttons/js/dataTables.buttons.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.flash.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.html5.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.colVis.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.print.min.js"></script><link href="libs/dt-ext-rowgroup/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-rowgroup/js/dataTables.rowGroup.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">现代应用统计与 R 语言</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li><a class="" href="chap-notations.html"><span class="header-section-number">2</span> 符号说明</a></li>
<li><a class="" href="chap-file-operations.html"><span class="header-section-number">3</span> 文件操作</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">4</span> 数据结构</a></li>
<li><a class="active" href="chap-data-manipulation.html"><span class="header-section-number">5</span> 数据操作</a></li>
<li><a class="" href="chap-data-transportation.html"><span class="header-section-number">6</span> 数据搬运</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">7</span> 数据可视化</a></li>
<li><a class="" href="chap-dynamic-documents.html"><span class="header-section-number">8</span> 动态文档</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">9</span> 交互图形</a></li>
<li><a class="" href="chap-interactive-data-tables.html"><span class="header-section-number">10</span> 交互表格</a></li>
<li><a class="" href="chap-interactive-shiny-app.html"><span class="header-section-number">11</span> 交互报表</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">12</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">13</span> 正则表达式</a></li>
<li><a class="" href="chap-text-analysis.html"><span class="header-section-number">14</span> 文本分析</a></li>
<li><a class="" href="chap-sampling-distributions.html"><span class="header-section-number">15</span> 抽样分布</a></li>
<li><a class="" href="chap-parameter-estimators.html"><span class="header-section-number">16</span> 参数估计</a></li>
<li><a class="" href="chap-hypothesis-test.html"><span class="header-section-number">17</span> 假设检验</a></li>
<li><a class="" href="chap-power-Analysis.html"><span class="header-section-number">18</span> 功效分析</a></li>
<li><a class="" href="chap-experimental-design.html"><span class="header-section-number">19</span> 试验设计</a></li>
<li><a class="" href="chap-linear-models.html"><span class="header-section-number">20</span> 线性模型</a></li>
<li><a class="" href="chap-generalized-linear-models.html"><span class="header-section-number">21</span> 广义线性模型</a></li>
<li><a class="" href="chap-case-study.html"><span class="header-section-number">22</span> 案例研究</a></li>
<li><a class="" href="chap-data-explorer.html"><span class="header-section-number">23</span> 数据探索</a></li>
<li><a class="" href="chap-survival-analysis.html"><span class="header-section-number">24</span> 生存分析</a></li>
<li><a class="" href="chap-time-series-analysis.html"><span class="header-section-number">25</span> 时序分析</a></li>
<li><a class="" href="chap-spatial-analysis.html"><span class="header-section-number">26</span> 空间分析</a></li>
<li><a class="" href="chap-spatial-modeling.html"><span class="header-section-number">27</span> 空间建模</a></li>
<li><a class="" href="chap-bayesian-models.html"><span class="header-section-number">28</span> 贝叶斯模型</a></li>
<li><a class="" href="chap-gradient-boosting-machine.html"><span class="header-section-number">29</span> 梯度提升机</a></li>
<li><a class="" href="chap-neural-network.html"><span class="header-section-number">30</span> 神经网络</a></li>
<li><a class="" href="chap-matrix-operations.html"><span class="header-section-number">31</span> 矩阵运算</a></li>
<li><a class="" href="chap-symbolic-computation.html"><span class="header-section-number">32</span> 符号计算</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">33</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="chap-other-softwares.html"><span class="header-section-number">B</span> 其它软件</a></li>
<li><a class="" href="chap-mixed-programming.html"><span class="header-section-number">C</span> 混合编程</a></li>
<li><a class="" href="chap-object-oriented-programming.html"><span class="header-section-number">D</span> 面向对象编程</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/masr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-data-manipulation" class="section level1" number="5">
<h1>
<span class="header-section-number">第 5 章</span> 数据操作<a class="anchor" aria-label="anchor" href="#chap-data-manipulation"><i class="fas fa-link"></i></a>
</h1>
<p><a href="https://github.com/Rdatatable/data.table">data.table</a> 大大加强了 <a href="https://github.com/wch/r-source">Base R</a> 提供的数据操作，<a href="https://github.com/nathaneastwood/poorman">poorman</a> 提供最常用的数据操作，但是不依赖 dplyr，<a href="https://github.com/ycphs/openxlsx">openxlsx</a> 可以读写 XLSX 文档，<a href="https://github.com/fstpackage/fst">fst</a>，<a href="https://github.com/apache/arrow/tree/master/r">arrow</a> 和 <a href="https://github.com/wesm/feather/tree/master/R">feather</a> 提供更加高效的数据读写性能。</p>
<p><a href="https://github.com/SebKrantz/collapse">collapse</a> 提供一系列高级和快速的数据操作，支持 Base R、dplyr、tibble、data.table、plm 和 sf 数据框结构类型。关键的特点有：1. 高级的统计编程，提供一系列统计函数支持在向量、矩阵和数据框上做分组和带权计算。</p>
<p>更多参考材料见<a href="https://atrebas.github.io/post/2019-03-03-datatable-dplyr/">A data.table and dplyr tour</a>，
<a href="https://raw.githack.com/uo-ec510-2020-spring/lectures/master/05-datatable/05-datatable.html">Big Data in Economics: Data cleaning and wrangling</a> 和 <a href="https://s3.amazonaws.com/assets.datacamp.com/img/blog/data+table+cheat+sheet.pdf">DataCamp’s data.table cheatsheet</a></p>
<div class="figure" style="text-align: center">
<span id="fig:tidyverse-vs-base-r"></span>
<img src="diagrams/tidyverse-vs-base-r.svg" alt="Tidyverse 和 Base R 的关系" width="55%"><p class="caption">
图 5.1: Tidyverse 和 Base R 的关系
</p>
</div>
<div id="sec-apply-family" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> apply 族<a class="anchor" aria-label="anchor" href="#sec-apply-family"><i class="fas fa-link"></i></a>
</h2>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:apply-functions">表 5.1: </span> apply 函数</caption>
<thead><tr class="header">
<th align="left">函数</th>
<th align="left">输入</th>
<th align="left">输出</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code></td>
<td align="left">矩阵、数据框</td>
<td align="left">向量</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code></td>
<td align="left">向量、列表</td>
<td align="left">列表</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code></td>
<td align="left">向量、列表</td>
<td align="left">向量、矩阵</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/mapply.html">mapply()</a></code></td>
<td align="left">多个向量</td>
<td align="left">列表</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/tapply.html">tapply()</a></code></td>
<td align="left">数据框、数组</td>
<td align="left">向量</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code></td>
<td align="left">列表</td>
<td align="left">矩阵</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/eapply.html">eapply()</a></code></td>
<td align="left">列表</td>
<td align="left">列表</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/rapply.html">rapply()</a></code></td>
<td align="left">嵌套列表</td>
<td align="left">嵌套列表</td>
</tr>
</tbody>
</table></div>
<p>除此之外，还有 <code><a href="https://rdrr.io/r/stats/dendrapply.html">dendrapply()</a></code> 专门处理层次聚类或分类回归树型结构， 而函数 <code><a href="https://rdrr.io/r/stats/kernapply.html">kernapply()</a></code> 用于时间序列的平滑处理</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Reproduce example 10.4.3 from Brockwell and Davis (1991) [@Brockwell_1991_Time]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/spectrum.html">spectrum</a></span><span class="op">(</span><span class="va">sunspot.year</span>, kernel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kernel.html">kernel</a></span><span class="op">(</span><span class="st">"daniell"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">7</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, log <span class="op">=</span> <span class="st">"no"</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:spectrum-sunspot-year"></span>
<img src="data-manipulation_files/figure-html/spectrum-sunspot-year-1.png" alt="太阳黑子的频谱" width="672"><p class="caption">
图 5.2: 太阳黑子的频谱
</p>
</div>
<!-- https://design.tidyverse.org/cs-mapply-pmap.html -->
<p>将函数应用到多个向量，返回一个列表，生成四组服从正态分布 <span class="math inline">\(\mathcal{N}(\mu_i,\sigma_i)\)</span> 的随机数，它们的均值和方差依次是 <span class="math inline">\(\mu_i = \sigma_i = 1 \ldots 4\)</span></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">means</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>
<span class="va">sds</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="va">rnorm</span>,
  mean <span class="op">=</span> <span class="va">means</span>, sd <span class="op">=</span> <span class="va">sds</span>,
  MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="va">samples</span></code></pre></div>
<pre><code>## [[1]]
##  [1]  1.37697212  1.30154837 -0.09802317 -0.13040590 -1.79653432  1.72057350
##  [7]  1.93912102  0.77062225  2.75913135  1.11736679
## 
## [[2]]
##  [1]  0.2937544  3.8185184  4.3927459  1.2568322  1.7534795  5.6000862
##  [7]  5.4079918 -4.0775292 -2.5779499  2.1166070
## 
## [[3]]
##  [1] 9.523096 6.294548 3.954661 2.780557 5.502806 3.596252 6.893524 5.810155
##  [9] 2.557700 3.331296
## 
## [[4]]
##  [1]  0.7499813  1.0251913  8.3813803 13.7414948  5.5524739  5.1625107
##  [7]  2.8576069  4.3040589  1.7588056  5.7887535</code></pre>
<p>我们借用图<a href="chap-data-manipulation.html#fig:mapply-lapply">5.3</a>来看一下 mapply 的效果，多组随机数生成非常有助于快速模拟。</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"darkorange"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:mapply-lapply"></span>
<img src="data-manipulation_files/figure-html/mapply-lapply-1.png" alt=" lapply 函数" width="672"><p class="caption">
图 5.3:  lapply 函数
</p>
</div>
<p>分别计算每个样本的平均值</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.8960372 1.7984536 5.0244596 4.9322257</code></pre>
<p>分别计算每个样本的1，2，3 分位点</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
##       25%       50%       75% 
## 0.1191382 1.2094576 1.6346732 
## 
## [[2]]
##       25%       50%       75% 
## 0.5345238 1.9350433 4.2491890 
## 
## [[3]]
##      25%      50%      75% 
## 3.397535 4.728734 6.173450 
## 
## [[4]]
##      25%      50%      75% 
## 2.033506 4.733285 5.729684</code></pre>
<p>仅用 <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> 函数替换上面的 <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>，我们可以得到一个矩阵，值得注意的是函数 <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> 和 <code><a href="https://rdrr.io/r/stats/fivenum.html">fivenum()</a></code> 算出来的结果有一些差异</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>##          [,1]      [,2]     [,3]     [,4]
## 25% 0.1191382 0.5345238 3.397535 2.033506
## 50% 1.2094576 1.9350433 4.728734 4.733285
## 75% 1.6346732 4.2491890 6.173450 5.729684</code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">fivenum</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Min. <span class="op">=</span> <span class="fl">0</span>, <span class="st">"1st Qu."</span> <span class="op">=</span> <span class="fl">0</span>, Median <span class="op">=</span> <span class="fl">0</span>, <span class="st">"3rd Qu."</span> <span class="op">=</span> <span class="fl">0</span>, Max. <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##                [,1]       [,2]     [,3]       [,4]
## Min.    -1.79653432 -4.0775292 2.557700  0.7499813
## 1st Qu. -0.09802317  0.2937544 3.331296  1.7588056
## Median   1.20945758  1.9350433 4.728734  4.7332848
## 3rd Qu.  1.72057350  4.3927459 6.294548  5.7887535
## Max.     2.75913135  5.6000862 9.523096 13.7414948</code></pre>
<p>vapply 和 sapply 类似，但是预先指定返回值类型，这样可以更加安全，有时也更快。</p>
<p>以数据集 presidents 为例，它是一个 ts 对象类型的时间序列数据，记录了 1945 年至 1974 年每个季度美国总统的支持率，这组数据中存在缺失值，以 NA 表示。支持率的变化趋势见图 <a href="chap-data-manipulation.html#fig:usa-presidents">5.4</a>。</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">presidents</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:usa-presidents"></span>
<img src="data-manipulation_files/figure-html/usa-presidents-1.png" alt="1945-1974美国总统的支持率" width="672"><p class="caption">
图 5.4: 1945-1974美国总统的支持率
</p>
</div>
<p>计算这 30 年每个季度的平均支持率</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">presidents</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">presidents</span><span class="op">)</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>##        1        2        3        4 
## 58.44828 56.43333 57.22222 53.07143</code></pre>
<p><code><a href="https://rdrr.io/r/stats/time.html">cycle()</a></code> 函数计算序列中每个观察值在周期中的位置，presidents 的周期为 4，根据位置划分组，然后分组求平均，也可以化作如下计算步骤，虽然看起来复杂，但是数据操作的过程很清晰，不再看起来像是一个黑箱。</p>
<p>tapply 函数来做分组求和</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 一个变量分组求和</span>
<span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">warpbreaks</span><span class="op">$</span><span class="va">breaks</span>, <span class="va">warpbreaks</span><span class="op">[</span>, <span class="fl">3</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>## tension
##   L   M   H 
## 655 475 390</code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 两个变量分组计数</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">warpbreaks</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">wool</span>, <span class="va">tension</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9</code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 两个变量分组求和</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">breaks</span> <span class="op">~</span> <span class="va">wool</span> <span class="op">+</span> <span class="va">tension</span>, data <span class="op">=</span> <span class="va">warpbreaks</span>, <span class="va">sum</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span>v.names <span class="op">=</span> <span class="st">"breaks"</span>, idvar <span class="op">=</span> <span class="st">"wool"</span>, timevar <span class="op">=</span> <span class="st">"tension"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>

<span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"(breaks)"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, replacement <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   wool   L   M   H
## 1    A 401 216 221
## 2    B 254 259 169</code></pre>
</div>
<div id="sec-subset" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> 子集过滤<a class="anchor" aria-label="anchor" href="#sec-subset"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8</code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">iris</span>,
  subset <span class="op">=</span> <span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>,
  select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8</code></pre>
</div>
<div id="sec-option-with" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> with 选项<a class="anchor" aria-label="anchor" href="#sec-option-with"><i class="fas fa-link"></i></a>
</h2>
<p>注意 data.table 与 Base R 不同的地方</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># https://github.com/Rdatatable/data.table/issues/4513</span>
<span class="co"># https://d.cosx.org/d/421532-datatable-base-r</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## [1]  TRUE  TRUE FALSE FALSE FALSE</code></pre>
<p>需要使用 <code>with = FALSE</code> 选项</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span>,
  with <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8</code></pre>
<p>不使用 with 选项，用函数 <code><a href="https://rdrr.io/r/base/get.html">mget()</a></code> 将字符串转变量</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span>
  <span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/get.html">mget</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8</code></pre>
<p>更加 data.table 风格的方式见</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>, <span class="va">.SD</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/patterns.html">patterns</a></span><span class="op">(</span><span class="st">"Sepal"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8</code></pre>
<p>with 还可以这样用，直接修改、添加一列</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">z</span> <span class="op">&lt;</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></code></pre></div>
<pre><code>##    x y  z
## 7  7 1 50
## 8  8 1 65
## 65 5 7 74
## 14 4 2 20
## 37 7 4 65
## 5  5 1 26</code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, z <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_contour.html">geom_contour</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:with-op"></span>
<img src="data-manipulation_files/figure-html/with-op-1.png" alt="with 操作" width="672"><p class="caption">
图 5.5: with 操作
</p>
</div>
</div>
<div id="sec-aggregate" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> 分组聚合<a class="anchor" aria-label="anchor" href="#sec-aggregate"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="st">"aggregate"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] aggregate.data.frame aggregate.default*   aggregate.formula*  
## [4] aggregate.ts        
## see '?methods' for accessing help and source code</code></pre>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="st">"aggregate.data.frame"</span><span class="op">)</span></code></pre></div>
<pre><code>## function (x, by, FUN, ..., simplify = TRUE, drop = TRUE) 
## NULL</code></pre>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="st">"aggregate.ts"</span><span class="op">)</span></code></pre></div>
<pre><code>## function (x, nfrequency = 1, FUN = sum, ndeltat = 1, ts.eps = getOption("ts.eps"), 
##     ...) 
## NULL</code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># getAnywhere(aggregate.formula)</span></code></pre></div>
<p>按 Species 分组，对 Sepal.Length 中大于平均值的数取平均</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Species</span>, <span class="va">iris</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length
## 1     setosa     5.313636
## 2 versicolor     6.375000
## 3  virginica     7.159091</code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>

<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">z</span>, <span class="va">w</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3</code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">mget</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"z"</span>, <span class="st">"w"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3</code></pre>
<p>shiny 前端传递字符串向量，借助 <code><a href="https://rdrr.io/r/base/get.html">mget()</a></code> 函数根据选择的变量分组统计计算，只有一个变量可以使用 <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> 传递变量给 data.table</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span>
      <span class="fl">6</span>,
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span><span class="st">"input_vars"</span>,
        label <span class="op">=</span> <span class="st">"变量"</span>, <span class="co"># 给筛选框取名</span>
        choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>z <span class="op">=</span> <span class="st">"z"</span>, w <span class="op">=</span> <span class="st">"w"</span><span class="op">)</span>, <span class="co"># 待选的值</span>
        selected <span class="op">=</span> <span class="st">"z"</span>, <span class="co"># 指定默认值</span>
        multiple <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># 允许多选</span>
      <span class="op">)</span>,
      <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">dataTableOutput</a></span><span class="op">(</span><span class="st">"output_table"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>

<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">output</span><span class="op">$</span><span class="va">output_table</span> <span class="op">&lt;-</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">renderDataTable</a></span><span class="op">(</span>
    <span class="op">{</span>
      <span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">mget</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">input_vars</span><span class="op">)</span><span class="op">]</span> |&gt;
        <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>,
    server <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># 执行</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></code></pre></div>
</div>
<div id="sec-merge-two-tables" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> 合并操作<a class="anchor" aria-label="anchor" href="#sec-merge-two-tables"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span>, z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">dat1</span>, z <span class="op">=</span> <span class="va">dat2</span><span class="op">$</span><span class="va">z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">$</span><span class="va">x</span>, <span class="va">dat2</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6</code></pre>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">dat2</span><span class="op">)</span></code></pre></div>
<pre><code>##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6</code></pre>
<p>保留两个数据集中的所有行</p>
</div>
<div id="sec-reshape" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> 长宽转换<a class="anchor" aria-label="anchor" href="#sec-reshape"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="st">"reshape"</span><span class="op">)</span></code></pre></div>
<pre><code>## function (data, varying = NULL, v.names = NULL, timevar = "time", 
##     idvar = "id", ids = 1L:NROW(data), times = seq_along(varying[[1L]]), 
##     drop = NULL, direction, new.row.names = NULL, sep = ".", 
##     split = if (sep == "") {
##         list(regexp = "[A-Za-z][0-9]", include = TRUE)
##     } else {
##         list(regexp = sep, include = FALSE, fixed = TRUE)
##     }) 
## NULL</code></pre>
<p>PlantGrowth 数据集的重塑操作也可以使用内置的函数 <code><a href="https://rdrr.io/r/stats/reshape.html">reshape()</a></code> 实现</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PlantGrowth</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">PlantGrowth</span>, idvar <span class="op">=</span> <span class="st">"group"</span>, v.names <span class="op">=</span> <span class="st">"weight"</span>,
  timevar <span class="op">=</span> <span class="st">"id"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>,
  sep <span class="op">=</span> <span class="st">""</span>
<span class="op">)</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">dat</span>,
  caption <span class="op">=</span> <span class="st">"不同生长环境下植物的干重"</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>,
  col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(weight)"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span>,
  align <span class="op">=</span> <span class="st">"c"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:data-frame-PlantGrowth">表 5.2: </span>不同生长环境下植物的干重</caption>
<thead><tr class="header">
<th align="center">group</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
<th align="center">4</th>
<th align="center">5</th>
<th align="center">6</th>
<th align="center">7</th>
<th align="center">8</th>
<th align="center">9</th>
<th align="center">10</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">ctrl</td>
<td align="center">4.17</td>
<td align="center">5.58</td>
<td align="center">5.18</td>
<td align="center">6.11</td>
<td align="center">4.50</td>
<td align="center">4.61</td>
<td align="center">5.17</td>
<td align="center">4.53</td>
<td align="center">5.33</td>
<td align="center">5.14</td>
</tr>
<tr class="even">
<td align="center">trt1</td>
<td align="center">4.81</td>
<td align="center">4.17</td>
<td align="center">4.41</td>
<td align="center">3.59</td>
<td align="center">5.87</td>
<td align="center">3.83</td>
<td align="center">6.03</td>
<td align="center">4.89</td>
<td align="center">4.32</td>
<td align="center">4.69</td>
</tr>
<tr class="odd">
<td align="center">trt2</td>
<td align="center">6.31</td>
<td align="center">5.12</td>
<td align="center">5.54</td>
<td align="center">5.50</td>
<td align="center">5.37</td>
<td align="center">5.29</td>
<td align="center">4.92</td>
<td align="center">6.15</td>
<td align="center">5.80</td>
<td align="center">5.26</td>
</tr>
</tbody>
</table></div>
<p>或者，我们也可以使用 <strong>tidyr</strong> 包提供的 <code>pivot_wider()</code> 函数</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">PlantGrowth</span>, id_cols <span class="op">=</span> <span class="va">id</span>,
  names_from <span class="op">=</span> <span class="va">group</span>, values_from <span class="op">=</span> <span class="va">weight</span>
<span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
##       id  ctrl  trt1  trt2
##    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     1  4.17  4.81  6.31
##  2     2  5.58  4.17  5.12
##  3     3  5.18  4.41  5.54
##  4     4  6.11  3.59  5.5 
##  5     5  4.5   5.87  5.37
##  6     6  4.61  3.83  5.29
##  7     7  5.17  6.03  4.92
##  8     8  4.53  4.89  6.15
##  9     9  5.33  4.32  5.8 
## 10    10  5.14  4.69  5.26</code></pre>
<p>或者，我们还可以使用 <strong>data.table</strong> 包提供的 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast()</a></code> 函数，用于将长格式的数据框重塑为宽格式的</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PlantGrowth_DT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span>
<span class="co"># 纵</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">PlantGrowth_DT</span>, <span class="va">id</span> <span class="op">~</span> <span class="va">group</span>, value.var <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></code></pre></div>
<pre><code>##     id ctrl trt1 trt2
##  1:  1 4.17 4.81 6.31
##  2:  2 5.58 4.17 5.12
##  3:  3 5.18 4.41 5.54
##  4:  4 6.11 3.59 5.50
##  5:  5 4.50 5.87 5.37
##  6:  6 4.61 3.83 5.29
##  7:  7 5.17 6.03 4.92
##  8:  8 4.53 4.89 6.15
##  9:  9 5.33 4.32 5.80
## 10: 10 5.14 4.69 5.26</code></pre>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 横</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">PlantGrowth_DT</span>, <span class="va">group</span> <span class="op">~</span> <span class="va">id</span>, value.var <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></code></pre></div>
<pre><code>##    group    1    2    3    4    5    6    7    8    9   10
## 1:  ctrl 4.17 5.58 5.18 6.11 4.50 4.61 5.17 4.53 5.33 5.14
## 2:  trt1 4.81 4.17 4.41 3.59 5.87 3.83 6.03 4.89 4.32 4.69
## 3:  trt2 6.31 5.12 5.54 5.50 5.37 5.29 4.92 6.15 5.80 5.26</code></pre>
</div>
<div id="sec-filter-columns" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> 对符合条件的列操作<a class="anchor" aria-label="anchor" href="#sec-filter-columns"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 数值型变量的列的位置</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">is.numeric</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##            1            2            3            4</code></pre>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">is.numeric</span><span class="op">)</span>, with <span class="op">=</span> <span class="cn">F</span><span class="op">]</span><span class="op">[</span><span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">7.5</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:          7.6         3.0          6.6         2.1
## 2:          7.7         3.8          6.7         2.2
## 3:          7.7         2.6          6.9         2.3
## 4:          7.7         2.8          6.7         2.0
## 5:          7.9         3.8          6.4         2.0
## 6:          7.7         3.0          6.1         2.3</code></pre>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.table" "data.frame"</code></pre>
<p>用 Base R 提供的管道符号 |&gt; 将 data.table 数据操作与 ggplot2 数据可视化连接起来</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">iris</span> |&gt;
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span><span class="op">)</span> |&gt;
  <span class="co"># 行过滤</span>
  <span class="co"># subset(select = grep("Sepal", colnames(iris), value = TRUE)) |&gt; # 列过滤</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sepal.Length</span>, y <span class="op">=</span> <span class="va">Sepal.Width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># 绘图</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pipe-dataframe-ggplot2"></span>
<img src="data-manipulation_files/figure-html/pipe-dataframe-ggplot2-1.png" alt="管道连接数据操作和可视化" width="672"><p class="caption">
图 5.6: 管道连接数据操作和可视化
</p>
</div>
</div>
<div id="sec-case-when" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> <code>CASE WHEN</code> 和 <code>fcase</code><a class="anchor" aria-label="anchor" href="#sec-case-when"><i class="fas fa-link"></i></a>
</h2>
<p><code>CASE WHEN</code> 是 SQL 中的条件判断语句，<strong>data.table</strong> 中的函数 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/fcase.html">fcase()</a></code> 可与之等价。值得注意的是，<code><a href="https://Rdatatable.gitlab.io/data.table/reference/fcase.html">fcase()</a></code> 需要 <strong>data.table</strong> 版本 1.13.0 及以上。</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">56.8</span>, <span class="fl">57.2</span>, <span class="fl">46.3</span>, <span class="fl">38.5</span><span class="op">)</span>,
  gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"0"</span>, <span class="st">""</span>, <span class="st">"0"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># 1 表示男，0表示女，空表示未知</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform</a></span><span class="op">(</span><span class="va">dat</span>, gender_cn <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fcase.html">fcase</a></span><span class="op">(</span>
  <span class="va">gender</span> <span class="op">==</span> <span class="st">"1"</span>, <span class="st">"男"</span>,
  <span class="va">gender</span> <span class="op">==</span> <span class="st">"0"</span>, <span class="st">"女"</span>,
  <span class="va">gender</span> <span class="op">==</span> <span class="st">""</span>, <span class="st">"未知"</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    weights gender gender_cn
## 1:    56.8      1        男
## 2:    57.2      0        女
## 3:    46.3             未知
## 4:    38.5      0        女</code></pre>
</div>
<div id="sec-datatable-in-action" class="section level2" number="5.9">
<h2>
<span class="header-section-number">5.9</span> 数据操作实战<a class="anchor" aria-label="anchor" href="#sec-datatable-in-action"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://tdhock.github.io/">Toby Dylan Hocking</a> 在 useR! 2020 大会上分享的幻灯片 <a href="https://github.com/tdhock/r-devel-emails" class="uri">https://github.com/tdhock/r-devel-emails</a></p>
</div>
<div id="sec-faq-operations" class="section level2" number="5.10">
<h2>
<span class="header-section-number">5.10</span> 高频数据操作<a class="anchor" aria-label="anchor" href="#sec-faq-operations"><i class="fas fa-link"></i></a>
</h2>
<p>以数据集 dat 为例介绍常用的数据操作</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  num_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, num_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
  group_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">16</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
  group_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">16</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="va">dat</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     1     1       c       B
##  2:     1     2       b       B
##  3:     1     3       a       B
##  4:     1     4       a       C
##  5:     2     1       b       B
##  6:     2     2       b       C
##  7:     2     3       a       B
##  8:     2     4       a       A
##  9:     3     1       b       C
## 10:     3     2       b       B
## 11:     3     3       b       B
## 12:     3     4       a       B
## 13:     4     1       b       C
## 14:     4     2       c       B
## 15:     4     3       b       C
## 16:     4     4       a       C</code></pre>
<div id="subsec-reduce-merge" class="section level3" number="5.10.1">
<h3>
<span class="header-section-number">5.10.1</span> 循环合并<a class="anchor" aria-label="anchor" href="#subsec-reduce-merge"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>问题来源 <a href="https://github.com/Rdatatable/data.table/issues/599">Faster version of Reduce(merge, list(DT1,DT2,DT3,…)) called mergelist (a la rbindlist)</a>
</li>
</ul>
</div>
<div id="subsec-count-by-group" class="section level3" number="5.10.2">
<h3>
<span class="header-section-number">5.10.2</span> 分组计数<a class="anchor" aria-label="anchor" href="#subsec-count-by-group"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span><span class="op">)</span><span class="op">]</span> <span class="co"># dat[, .N , by = .(group_a)]</span></code></pre></div>
<pre><code>##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6</code></pre>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_b</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_b V1
## 1:       B  9
## 2:       C  6
## 3:       A  1</code></pre>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span>, <span class="va">group_b</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_a group_b V1
## 1:       c       B  2
## 2:       b       B  4
## 3:       a       B  3
## 4:       a       C  2
## 5:       b       C  4
## 6:       a       A  1</code></pre>
</div>
<div id="subsec-sample-by-group" class="section level3" number="5.10.3">
<h3>
<span class="header-section-number">5.10.3</span> 分组抽样<a class="anchor" aria-label="anchor" href="#subsec-sample-by-group"><i class="fas fa-link"></i></a>
</h3>
<p>以 <code>group_a</code> 为组别， a、 b、 c 分别有 6、 8、 2 条记录</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 无放回的抽样</span>
<span class="va">dt_sample_1</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.N</span>, size <span class="op">=</span> <span class="fl">2</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">group_a</span><span class="op">]</span>
<span class="co"># 有放回的随机抽样</span>
<span class="va">dt_sample_2</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.N</span>, size <span class="op">=</span> <span class="fl">3</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">group_a</span><span class="op">]</span></code></pre></div>
<p>可能存在该组样本不平衡，有的组的样本量不足你想要的样本量。每个组无放回地抽取 4 个样本，如果该组样本量不足 4，则全部抽取全部样本量。</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.N</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">4</span>, <span class="va">.N</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">group_a</span><span class="op">]</span></code></pre></div>
<pre><code>##     group_a num_a num_b group_b
##  1:       c     1     1       B
##  2:       c     4     2       B
##  3:       b     3     2       B
##  4:       b     2     2       C
##  5:       b     2     1       B
##  6:       b     3     3       B
##  7:       a     1     3       B
##  8:       a     2     3       B
##  9:       a     2     4       A
## 10:       a     1     4       C</code></pre>
<p>还可以按照指定的比例抽取样本量 <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://stackoverflow.com/questions/18258690/take-randomly-sample-based-on-groups" class="uri"&gt;https://stackoverflow.com/questions/18258690/take-randomly-sample-based-on-groups&lt;/a&gt;&lt;/p&gt;'><sup>8</sup></a></p>
</div>
<div id="subsec-order-by-group" class="section level3" number="5.10.4">
<h3>
<span class="header-section-number">5.10.4</span> 分组排序<a class="anchor" aria-label="anchor" href="#subsec-order-by-group"><i class="fas fa-link"></i></a>
</h3>
<p>data.table 包的分组排序问题 <a href="https://d.cosx.org/d/421650-datatable/3" class="uri">https://d.cosx.org/d/421650-datatable/3</a></p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">num_a</span>, <span class="va">group_a</span>, FUN <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, <span class="op">-</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     4     1       b       C
##  2:     4     2       c       B
##  3:     4     3       b       C
##  4:     4     4       a       C
##  5:     3     1       b       C
##  6:     3     2       b       B
##  7:     3     3       b       B
##  8:     3     4       a       B
##  9:     2     1       b       B
## 10:     2     2       b       C
## 11:     2     3       a       B
## 12:     2     4       a       A
## 13:     1     1       c       B
## 14:     1     2       b       B
## 15:     1     3       a       B
## 16:     1     4       a       C</code></pre>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># num_a 降序排列，然后对 group_a 升序排列</span>
<span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">num_a</span>, <span class="va">group_a</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B</code></pre>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 简写</span>
<span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">num_a</span>, <span class="va">group_a</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B</code></pre>
<p><code><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder()</a></code> 函数直接修改原始数据记录的排序</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">dat</span>, <span class="op">-</span><span class="va">num_a</span>, <span class="va">group_a</span><span class="op">)</span></code></pre></div>
<p>参考多个列分组排序 <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns" class="uri"&gt;https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns&lt;/a&gt;&lt;/p&gt;'><sup>9</sup></a></p>
<div class="rmdtip">
<p>如果数据集 dat 包含缺失值，考虑去掉缺失值</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6</code></pre>
<p>如果数据集 dat 包含重复值，考虑去掉重复值</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_a V1
## 1:       c  2
## 2:       b  4
## 3:       a  4</code></pre>
</div>
<p>按 Species 分组，对 Sepal.Length 降序排列，取 Top 3</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">]</span></code></pre></div>
<pre><code>##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3</code></pre>
<p>对 iris 各个列排序</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="st">"order"</span>, args <span class="op">=</span> <span class="va">dat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">dat</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.6         3.1          1.5         0.2  setosa
## 2:          4.7         3.2          1.3         0.2  setosa
## 3:          4.9         3.0          1.4         0.2  setosa
## 4:          5.0         3.6          1.4         0.2  setosa
## 5:          5.1         3.5          1.4         0.2  setosa
## 6:          5.4         3.9          1.7         0.4  setosa</code></pre>
<p>按 Species 分组，对 Sepal.Length 降序排列，取 Top 3</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, by<span class="op">=</span><span class="st">"Species"</span><span class="op">]</span></code></pre></div>
<pre><code>##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3</code></pre>
<p>对 iris 各个列排序，依次对第 5、1、2、3 列升序排列</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="st">"order"</span>, args <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.3         3.0          1.1         0.1  setosa
## 2:          4.4         2.9          1.4         0.2  setosa
## 3:          4.4         3.0          1.3         0.2  setosa
## 4:          4.4         3.2          1.3         0.2  setosa
## 5:          4.5         2.3          1.3         0.3  setosa
## 6:          4.6         3.1          1.5         0.2  setosa</code></pre>
<div class="inline-table"><table class="kable_wrapper">
<caption>
<span id="tab:column-order">表 5.3: </span>iris 数据集原顺序（左）和新顺序（右）
</caption>
<tbody><tr>
<td>
<table class="table table-sm">
<thead><tr class="header">
<th align="right">Sepal.Length</th>
<th align="right">Sepal.Width</th>
<th align="right">Petal.Length</th>
<th align="right">Petal.Width</th>
<th align="left">Species</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">5.1</td>
<td align="right">3.5</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.9</td>
<td align="right">3.0</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.7</td>
<td align="right">3.2</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.6</td>
<td align="right">3.1</td>
<td align="right">1.5</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">5.0</td>
<td align="right">3.6</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">5.4</td>
<td align="right">3.9</td>
<td align="right">1.7</td>
<td align="right">0.4</td>
<td align="left">setosa</td>
</tr>
</tbody>
</table>
</td>
<td>
<table class="table table-sm">
<thead><tr class="header">
<th align="right">Sepal.Length</th>
<th align="right">Sepal.Width</th>
<th align="right">Petal.Length</th>
<th align="right">Petal.Width</th>
<th align="left">Species</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">4.3</td>
<td align="right">3.0</td>
<td align="right">1.1</td>
<td align="right">0.1</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.4</td>
<td align="right">2.9</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.4</td>
<td align="right">3.0</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.4</td>
<td align="right">3.2</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.5</td>
<td align="right">2.3</td>
<td align="right">1.3</td>
<td align="right">0.3</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.6</td>
<td align="right">3.1</td>
<td align="right">1.5</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
</tbody>
</table>
</td>
</tr></tbody>
</table></div>
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-data-structure.html"><span class="header-section-number">4</span> 数据结构</a></div>
<div class="next"><a href="chap-data-transportation.html"><span class="header-section-number">6</span> 数据搬运</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-data-manipulation"><span class="header-section-number">5</span> 数据操作</a></li>
<li><a class="nav-link" href="#sec-apply-family"><span class="header-section-number">5.1</span> apply 族</a></li>
<li><a class="nav-link" href="#sec-subset"><span class="header-section-number">5.2</span> 子集过滤</a></li>
<li><a class="nav-link" href="#sec-option-with"><span class="header-section-number">5.3</span> with 选项</a></li>
<li><a class="nav-link" href="#sec-aggregate"><span class="header-section-number">5.4</span> 分组聚合</a></li>
<li><a class="nav-link" href="#sec-merge-two-tables"><span class="header-section-number">5.5</span> 合并操作</a></li>
<li><a class="nav-link" href="#sec-reshape"><span class="header-section-number">5.6</span> 长宽转换</a></li>
<li><a class="nav-link" href="#sec-filter-columns"><span class="header-section-number">5.7</span> 对符合条件的列操作</a></li>
<li><a class="nav-link" href="#sec-case-when"><span class="header-section-number">5.8</span> CASE WHEN 和 fcase</a></li>
<li><a class="nav-link" href="#sec-datatable-in-action"><span class="header-section-number">5.9</span> 数据操作实战</a></li>
<li>
<a class="nav-link" href="#sec-faq-operations"><span class="header-section-number">5.10</span> 高频数据操作</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#subsec-reduce-merge"><span class="header-section-number">5.10.1</span> 循环合并</a></li>
<li><a class="nav-link" href="#subsec-count-by-group"><span class="header-section-number">5.10.2</span> 分组计数</a></li>
<li><a class="nav-link" href="#subsec-sample-by-group"><span class="header-section-number">5.10.3</span> 分组抽样</a></li>
<li><a class="nav-link" href="#subsec-order-by-group"><span class="header-section-number">5.10.4</span> 分组排序</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/masr/blob/master/data-manipulation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/masr/edit/master/data-manipulation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>现代应用统计与 R 语言</strong>" was written by 黄湘云. It was last built on 2021-08-07.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
