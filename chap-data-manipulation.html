<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 5 章 数据操作 | 现代应用统计与 R 语言</title>
<meta name="author" content="黄湘云">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs/header-attrs.js"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/proj4js/proj4.js"></script><link href="libs/highcharts/css/motion.css" rel="stylesheet">
<script src="libs/highcharts/highcharts.js"></script><script src="libs/highcharts/highcharts-3d.js"></script><script src="libs/highcharts/highcharts-more.js"></script><script src="libs/highcharts/modules/stock.js"></script><script src="libs/highcharts/modules/map.js"></script><script src="libs/highcharts/modules/annotations.js"></script><script src="libs/highcharts/modules/data.js"></script><script src="libs/highcharts/modules/drilldown.js"></script><script src="libs/highcharts/modules/item-series.js"></script><script src="libs/highcharts/modules/offline-exporting.js"></script><script src="libs/highcharts/modules/overlapping-datalabels.js"></script><script src="libs/highcharts/modules/exporting.js"></script><script src="libs/highcharts/modules/export-data.js"></script><script src="libs/highcharts/modules/funnel.js"></script><script src="libs/highcharts/modules/heatmap.js"></script><script src="libs/highcharts/modules/treemap.js"></script><script src="libs/highcharts/modules/sankey.js"></script><script src="libs/highcharts/modules/dependency-wheel.js"></script><script src="libs/highcharts/modules/organization.js"></script><script src="libs/highcharts/modules/solid-gauge.js"></script><script src="libs/highcharts/modules/streamgraph.js"></script><script src="libs/highcharts/modules/sunburst.js"></script><script src="libs/highcharts/modules/vector.js"></script><script src="libs/highcharts/modules/wordcloud.js"></script><script src="libs/highcharts/modules/xrange.js"></script><script src="libs/highcharts/modules/tilemap.js"></script><script src="libs/highcharts/modules/venn.js"></script><script src="libs/highcharts/modules/gantt.js"></script><script src="libs/highcharts/modules/timeline.js"></script><script src="libs/highcharts/modules/parallel-coordinates.js"></script><script src="libs/highcharts/modules/bullet.js"></script><script src="libs/highcharts/modules/coloraxis.js"></script><script src="libs/highcharts/modules/dumbbell.js"></script><script src="libs/highcharts/modules/lollipop.js"></script><script src="libs/highcharts/modules/series-label.js"></script><script src="libs/highcharts/plugins/motion.js"></script><script src="libs/highcharts/custom/reset.js"></script><script src="libs/highcharts/modules/boost.js"></script><script src="libs/highchart-binding/highchart.js"></script><script src="libs/es6shim/es6shim.js"></script><script src="libs/es7shim/es7shim.js"></script><script src="libs/graphre/graphre.js"></script><script src="libs/nomnoml/nomnoml.js"></script><script src="libs/nomnoml-binding/nomnoml.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><link href="libs/dygraphs/dygraph.css" rel="stylesheet">
<script src="libs/dygraphs/dygraph-combined.js"></script><script src="libs/dygraphs/shapes.js"></script><script src="libs/moment/moment.js"></script><script src="libs/moment-timezone/moment-timezone-with-data.js"></script><script src="libs/moment-fquarter/moment-fquarter.min.js"></script><script src="libs/dygraphs-binding/dygraphs.js"></script><script src="libs/Dygraph.Plugins.Unzoom/unzoom.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/echarts-world/world.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis.css" rel="stylesheet">
<script src="libs/vis/vis.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><link href="libs/datatables-css/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding/datatables.js"></script><link href="libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core/js/jquery.dataTables.min.js"></script><script src="libs/jszip/jszip.min.js"></script><script src="libs/pdfmake/pdfmake.js"></script><script src="libs/pdfmake/vfs_fonts.js"></script><link href="libs/dt-ext-buttons/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-buttons/js/dataTables.buttons.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.flash.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.html5.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.colVis.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.print.min.js"></script><link href="libs/dt-ext-rowgroup/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-rowgroup/js/dataTables.rowGroup.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">现代应用统计与 R 语言</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li><a class="" href="chap-notations.html"><span class="header-section-number">2</span> 符号说明</a></li>
<li><a class="" href="chap-file-operations.html"><span class="header-section-number">3</span> 文件操作</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">4</span> 数据结构</a></li>
<li><a class="active" href="chap-data-manipulation.html"><span class="header-section-number">5</span> 数据操作</a></li>
<li><a class="" href="chap-data-transportation.html"><span class="header-section-number">6</span> 数据搬运</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">7</span> 数据可视化</a></li>
<li><a class="" href="chap-dynamic-documents.html"><span class="header-section-number">8</span> 动态文档</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">9</span> 交互图形</a></li>
<li><a class="" href="chap-interactive-data-tables.html"><span class="header-section-number">10</span> 交互表格</a></li>
<li><a class="" href="chap-interactive-shiny-app.html"><span class="header-section-number">11</span> 交互报表</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">12</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">13</span> 正则表达式</a></li>
<li><a class="" href="chap-text-analysis.html"><span class="header-section-number">14</span> 文本分析</a></li>
<li><a class="" href="chap-sampling-distributions.html"><span class="header-section-number">15</span> 抽样分布</a></li>
<li><a class="" href="chap-parameter-estimators.html"><span class="header-section-number">16</span> 参数估计</a></li>
<li><a class="" href="chap-hypothesis-test.html"><span class="header-section-number">17</span> 假设检验</a></li>
<li><a class="" href="chap-power-Analysis.html"><span class="header-section-number">18</span> 功效分析</a></li>
<li><a class="" href="chap-experimental-design.html"><span class="header-section-number">19</span> 试验设计</a></li>
<li><a class="" href="chap-linear-models.html"><span class="header-section-number">20</span> 线性模型</a></li>
<li><a class="" href="chap-generalized-linear-models.html"><span class="header-section-number">21</span> 广义线性模型</a></li>
<li><a class="" href="chap-case-study.html"><span class="header-section-number">22</span> 案例研究</a></li>
<li><a class="" href="chap-data-explorer.html"><span class="header-section-number">23</span> 数据探索</a></li>
<li><a class="" href="chap-survival-analysis.html"><span class="header-section-number">24</span> 生存分析</a></li>
<li><a class="" href="chap-time-series-analysis.html"><span class="header-section-number">25</span> 时序分析</a></li>
<li><a class="" href="chap-spatial-analysis.html"><span class="header-section-number">26</span> 空间分析</a></li>
<li><a class="" href="chap-spatial-modeling.html"><span class="header-section-number">27</span> 空间建模</a></li>
<li><a class="" href="chap-bayesian-models.html"><span class="header-section-number">28</span> 贝叶斯模型</a></li>
<li><a class="" href="chap-gradient-boosting-machine.html"><span class="header-section-number">29</span> 梯度提升机</a></li>
<li><a class="" href="chap-neural-network.html"><span class="header-section-number">30</span> 神经网络</a></li>
<li><a class="" href="chap-matrix-operations.html"><span class="header-section-number">31</span> 矩阵运算</a></li>
<li><a class="" href="chap-symbolic-computation.html"><span class="header-section-number">32</span> 符号计算</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">33</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="chap-other-softwares.html"><span class="header-section-number">B</span> 其它软件</a></li>
<li><a class="" href="chap-mixed-programming.html"><span class="header-section-number">C</span> 混合编程</a></li>
<li><a class="" href="chap-object-oriented-programming.html"><span class="header-section-number">D</span> 面向对象编程</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/masr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-data-manipulation" class="section level1" number="5">
<h1>
<span class="header-section-number">第 5 章</span> 数据操作<a class="anchor" aria-label="anchor" href="#chap-data-manipulation"><i class="fas fa-link"></i></a>
</h1>
<!-- 
参考 Data Manipulation With R [@Spector_2008_Manipulation] 重新捋一遍本章，
介绍 Base R 提供的数据操作，重点在于常用的数据操作，其次在于常用的使用场景，最后是总结。
-->
<p><a href="https://github.com/Rdatatable/data.table">data.table</a> 大大加强了 <a href="https://github.com/wch/r-source">Base R</a> 提供的数据操作，<a href="https://github.com/nathaneastwood/poorman">poorman</a> 提供最常用的数据操作，但是不依赖 dplyr，<a href="https://github.com/fstpackage/fst">fst</a>，<a href="https://github.com/apache/arrow/tree/master/r">arrow</a> 和 <a href="https://github.com/wesm/feather/tree/master/R">feather</a> 提供更加高效的数据读写性能。</p>
<p><a href="https://github.com/SebKrantz/collapse">collapse</a> 提供一系列高级和快速的数据操作，支持 Base R、dplyr、tibble、data.table、plm 和 sf 数据框结构类型。关键的特点有：1. 高级的统计编程，提供一系列统计函数支持在向量、矩阵和数据框上做分组和带权计算。<a href="https://github.com/SebKrantz/fastverse">fastverse</a> 提供丰富的数据操作和统计计算功能，意图打造一个 tidyverse 替代品。</p>
<p>更多参考材料见<a href="https://atrebas.github.io/post/2019-03-03-datatable-dplyr/">A data.table and dplyr tour</a>，
<a href="https://raw.githack.com/uo-ec510-2020-spring/lectures/master/05-datatable/05-datatable.html">Big Data in Economics: Data cleaning and wrangling</a> 和 <a href="https://s3.amazonaws.com/assets.datacamp.com/img/blog/data+table+cheat+sheet.pdf">DataCamp’s data.table cheatsheet</a>，关于采用 Base R 还是 tidyverse 做数据操作的 <a href="https://d.cosx.org/d/420697">讨论</a>，数据操作的动画展示参考 <a href="https://github.com/gadenbuie/tidyexplain" class="uri">https://github.com/gadenbuie/tidyexplain</a>。</p>
<div class="figure" style="text-align: center">
<span id="fig:tidyverse-vs-base-r"></span>
<img src="diagrams/tidyverse-vs-base-r.svg" alt="Tidyverse 和 Base R 的关系" width="55%"><p class="caption">
图 5.1: Tidyverse 和 Base R 的关系
</p>
</div>
<p>什么是 Base R? Base R 指的是 R 语言/软件的核心组件，由 R Core Team 维护</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html">R.home</a></span><span class="op">(</span><span class="st">"library"</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageDescription</a></span><span class="op">(</span>pkg <span class="op">=</span> <span class="va">x</span>, fields <span class="op">=</span> <span class="st">"Priority"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">Pkgs</span><span class="op">[</span><span class="va">Pkgs</span> <span class="op">==</span> <span class="st">"base"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Pkgs</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "base"      "compiler"  "datasets"  "graphics"  "grDevices" "grid"     
##  [7] "methods"   "parallel"  "splines"   "stats"     "stats4"    "tcltk"    
## [13] "tools"     "utils"</code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">Pkgs</span><span class="op">[</span><span class="va">Pkgs</span> <span class="op">==</span> <span class="st">"recommended"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Pkgs</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "boot"       "class"      "cluster"    "codetools"  "foreign"   
##  [6] "KernSmooth" "lattice"    "MASS"       "Matrix"     "mgcv"      
## [11] "nlme"       "nnet"       "rpart"      "spatial"    "survival"</code></pre>
<p>数据变形，分组统计聚合等，用以作为模型的输入，绘图的对象，操作的数据对象是数据框(data.frame)类型的，而且如果没有特别说明，文中出现的数据集都是 Base R 内置的，第三方 R 包或者来源于网上的数据集都会加以说明。</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 给定一个/些 R 包名，返回该 R 包存放的位置</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pkg_path</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"survival"</span>, <span class="st">"ggplot2"</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/zpackages.html">.packages</a></span><span class="op">(</span><span class="cn">T</span>, lib.loc <span class="op">=</span> <span class="va">pkg_path</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>##      /home/runner/work/_temp/Library /opt/R/4.1.0/lib/R/library
## [1,]                           FALSE                       TRUE
## [2,]                            TRUE                      FALSE</code></pre>
<div id="dm-view" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> 查看数据<a class="anchor" aria-label="anchor" href="#dm-view"><i class="fas fa-link"></i></a>
</h2>
<p>查看属性</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    150 obs. of  5 variables:
##  $ Sepal.Length: num  5.1 4.9 4.7 4.6 5 5.4 4.6 5 4.4 4.9 ...
##  $ Sepal.Width : num  3.5 3 3.2 3.1 3.6 3.9 3.4 3.4 2.9 3.1 ...
##  $ Petal.Length: num  1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 ...
##  $ Petal.Width : num  0.2 0.2 0.2 0.2 0.2 0.4 0.3 0.2 0.2 0.1 ...
##  $ Species     : Factor w/ 3 levels "setosa","versicolor",..: 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
<p>查看部分数据集</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa</code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica</code></pre>
<p>查看文件前（后）5行</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="chap-data-manipulation.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> <span class="at">-n</span> 5 test.csv</span>
<span id="cb58-2"><a href="chap-data-manipulation.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> <span class="at">-n</span> 5 test.csv</span></code></pre></div>
<p>对象的类型，存储方式</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.frame"</code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mode.html">mode</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "list"</code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "list"</code></pre>
<p>查看对象在R环境中所占空间的大小</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## 7256 bytes</code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">letters</span><span class="op">)</span></code></pre></div>
<pre><code>## 1712 bytes</code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">ls</span><span class="op">)</span></code></pre></div>
<pre><code>## 89880 bytes</code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">library</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "1.8 Mb"</code></pre>
</div>
<div id="dm-subset" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> 提取子集<a class="anchor" aria-label="anchor" href="#dm-subset"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">subset</span>, <span class="va">select</span>, drop <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></code></pre></div>
<p>参数 <code>subset</code>代表行操作，<code>select</code> 代表列操作，函数 <code>subset</code> 从数据框中提取部分数据</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 101          6.3         3.3          6.0         2.5 virginica
## 102          5.8         2.7          5.1         1.9 virginica
## 103          7.1         3.0          5.9         2.1 virginica
## 104          6.3         2.9          5.6         1.8 virginica
## 105          6.5         3.0          5.8         2.2 virginica
## 106          7.6         3.0          6.6         2.1 virginica
## 107          4.9         2.5          4.5         1.7 virginica
## 108          7.3         2.9          6.3         1.8 virginica
## 109          6.7         2.5          5.8         1.8 virginica
## 110          7.2         3.6          6.1         2.5 virginica
## 111          6.5         3.2          5.1         2.0 virginica
## 112          6.4         2.7          5.3         1.9 virginica
## 113          6.8         3.0          5.5         2.1 virginica
## 114          5.7         2.5          5.0         2.0 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 116          6.4         3.2          5.3         2.3 virginica
## 117          6.5         3.0          5.5         1.8 virginica
## 118          7.7         3.8          6.7         2.2 virginica
## 119          7.7         2.6          6.9         2.3 virginica
## 120          6.0         2.2          5.0         1.5 virginica
## 121          6.9         3.2          5.7         2.3 virginica
## 122          5.6         2.8          4.9         2.0 virginica
## 123          7.7         2.8          6.7         2.0 virginica
## 124          6.3         2.7          4.9         1.8 virginica
## 125          6.7         3.3          5.7         2.1 virginica
## 126          7.2         3.2          6.0         1.8 virginica
## 127          6.2         2.8          4.8         1.8 virginica
## 128          6.1         3.0          4.9         1.8 virginica
## 129          6.4         2.8          5.6         2.1 virginica
## 130          7.2         3.0          5.8         1.6 virginica
## 131          7.4         2.8          6.1         1.9 virginica
## 132          7.9         3.8          6.4         2.0 virginica
## 133          6.4         2.8          5.6         2.2 virginica
## 134          6.3         2.8          5.1         1.5 virginica
## 135          6.1         2.6          5.6         1.4 virginica
## 136          7.7         3.0          6.1         2.3 virginica
## 137          6.3         3.4          5.6         2.4 virginica
## 138          6.4         3.1          5.5         1.8 virginica
## 139          6.0         3.0          4.8         1.8 virginica
## 140          6.9         3.1          5.4         2.1 virginica
## 141          6.7         3.1          5.6         2.4 virginica
## 142          6.9         3.1          5.1         2.3 virginica
## 143          5.8         2.7          5.1         1.9 virginica
## 144          6.8         3.2          5.9         2.3 virginica
## 145          6.7         3.3          5.7         2.5 virginica
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica</code></pre>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># summary(iris$Sepal.Length)  mean(iris$Sepal.Length)</span>
<span class="co"># 且的逻辑</span>
<span class="co"># subset(iris, Species == "virginica" &amp; Sepal.Length &gt; 5.84333)</span>
<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span> <span class="op">&amp;</span>
  <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 101          6.3         3.3          6.0         2.5 virginica
## 103          7.1         3.0          5.9         2.1 virginica
## 104          6.3         2.9          5.6         1.8 virginica
## 105          6.5         3.0          5.8         2.2 virginica
## 106          7.6         3.0          6.6         2.1 virginica
## 108          7.3         2.9          6.3         1.8 virginica
## 109          6.7         2.5          5.8         1.8 virginica
## 110          7.2         3.6          6.1         2.5 virginica
## 111          6.5         3.2          5.1         2.0 virginica
## 112          6.4         2.7          5.3         1.9 virginica
## 113          6.8         3.0          5.5         2.1 virginica
## 116          6.4         3.2          5.3         2.3 virginica
## 117          6.5         3.0          5.5         1.8 virginica
## 118          7.7         3.8          6.7         2.2 virginica
## 119          7.7         2.6          6.9         2.3 virginica
## 120          6.0         2.2          5.0         1.5 virginica
## 121          6.9         3.2          5.7         2.3 virginica
## 123          7.7         2.8          6.7         2.0 virginica
## 124          6.3         2.7          4.9         1.8 virginica
## 125          6.7         3.3          5.7         2.1 virginica
## 126          7.2         3.2          6.0         1.8 virginica
## 127          6.2         2.8          4.8         1.8 virginica
## 128          6.1         3.0          4.9         1.8 virginica
## 129          6.4         2.8          5.6         2.1 virginica
## 130          7.2         3.0          5.8         1.6 virginica
## 131          7.4         2.8          6.1         1.9 virginica
## 132          7.9         3.8          6.4         2.0 virginica
## 133          6.4         2.8          5.6         2.2 virginica
## 134          6.3         2.8          5.1         1.5 virginica
## 135          6.1         2.6          5.6         1.4 virginica
## 136          7.7         3.0          6.1         2.3 virginica
## 137          6.3         3.4          5.6         2.4 virginica
## 138          6.4         3.1          5.5         1.8 virginica
## 139          6.0         3.0          4.8         1.8 virginica
## 140          6.9         3.1          5.4         2.1 virginica
## 141          6.7         3.1          5.6         2.4 virginica
## 142          6.9         3.1          5.1         2.3 virginica
## 144          6.8         3.2          5.9         2.3 virginica
## 145          6.7         3.3          5.7         2.5 virginica
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica</code></pre>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 在行的子集范围内</span>
<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">Species</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"virginica"</span>, <span class="st">"versicolor"</span><span class="op">)</span> <span class="op">&amp;</span>
  <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 51           7.0         3.2          4.7         1.4 versicolor
## 52           6.4         3.2          4.5         1.5 versicolor
## 53           6.9         3.1          4.9         1.5 versicolor
## 55           6.5         2.8          4.6         1.5 versicolor
## 57           6.3         3.3          4.7         1.6 versicolor
## 59           6.6         2.9          4.6         1.3 versicolor
## 62           5.9         3.0          4.2         1.5 versicolor
## 63           6.0         2.2          4.0         1.0 versicolor
## 64           6.1         2.9          4.7         1.4 versicolor
## 66           6.7         3.1          4.4         1.4 versicolor
## 69           6.2         2.2          4.5         1.5 versicolor
## 71           5.9         3.2          4.8         1.8 versicolor
## 72           6.1         2.8          4.0         1.3 versicolor
## 73           6.3         2.5          4.9         1.5 versicolor
## 74           6.1         2.8          4.7         1.2 versicolor
## 75           6.4         2.9          4.3         1.3 versicolor
## 76           6.6         3.0          4.4         1.4 versicolor
## 77           6.8         2.8          4.8         1.4 versicolor
## 78           6.7         3.0          5.0         1.7 versicolor
## 79           6.0         2.9          4.5         1.5 versicolor
## 84           6.0         2.7          5.1         1.6 versicolor
## 86           6.0         3.4          4.5         1.6 versicolor
## 87           6.7         3.1          4.7         1.5 versicolor
## 88           6.3         2.3          4.4         1.3 versicolor
## 92           6.1         3.0          4.6         1.4 versicolor
## 98           6.2         2.9          4.3         1.3 versicolor
## 101          6.3         3.3          6.0         2.5  virginica
## 103          7.1         3.0          5.9         2.1  virginica
## 104          6.3         2.9          5.6         1.8  virginica
## 105          6.5         3.0          5.8         2.2  virginica
## 106          7.6         3.0          6.6         2.1  virginica
## 108          7.3         2.9          6.3         1.8  virginica
## 109          6.7         2.5          5.8         1.8  virginica
## 110          7.2         3.6          6.1         2.5  virginica
## 111          6.5         3.2          5.1         2.0  virginica
## 112          6.4         2.7          5.3         1.9  virginica
## 113          6.8         3.0          5.5         2.1  virginica
## 116          6.4         3.2          5.3         2.3  virginica
## 117          6.5         3.0          5.5         1.8  virginica
## 118          7.7         3.8          6.7         2.2  virginica
## 119          7.7         2.6          6.9         2.3  virginica
## 120          6.0         2.2          5.0         1.5  virginica
## 121          6.9         3.2          5.7         2.3  virginica
## 123          7.7         2.8          6.7         2.0  virginica
## 124          6.3         2.7          4.9         1.8  virginica
## 125          6.7         3.3          5.7         2.1  virginica
## 126          7.2         3.2          6.0         1.8  virginica
## 127          6.2         2.8          4.8         1.8  virginica
## 128          6.1         3.0          4.9         1.8  virginica
## 129          6.4         2.8          5.6         2.1  virginica
## 130          7.2         3.0          5.8         1.6  virginica
## 131          7.4         2.8          6.1         1.9  virginica
## 132          7.9         3.8          6.4         2.0  virginica
## 133          6.4         2.8          5.6         2.2  virginica
## 134          6.3         2.8          5.1         1.5  virginica
## 135          6.1         2.6          5.6         1.4  virginica
## 136          7.7         3.0          6.1         2.3  virginica
## 137          6.3         3.4          5.6         2.4  virginica
## 138          6.4         3.1          5.5         1.8  virginica
## 139          6.0         3.0          4.8         1.8  virginica
## 140          6.9         3.1          5.4         2.1  virginica
## 141          6.7         3.1          5.6         2.4  virginica
## 142          6.9         3.1          5.1         2.3  virginica
## 144          6.8         3.2          5.9         2.3  virginica
## 145          6.7         3.3          5.7         2.5  virginica
## 146          6.7         3.0          5.2         2.3  virginica
## 147          6.3         2.5          5.0         1.9  virginica
## 148          6.5         3.0          5.2         2.0  virginica
## 149          6.2         3.4          5.4         2.3  virginica
## 150          5.9         3.0          5.1         1.8  virginica</code></pre>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 在列的子集内 先选中列</span>
<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span>,
  select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Species"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length    Species
## 51           7.0 versicolor
## 52           6.4 versicolor
## 53           6.9 versicolor
## 55           6.5 versicolor
## 57           6.3 versicolor
## 59           6.6 versicolor
## 62           5.9 versicolor
## 63           6.0 versicolor
## 64           6.1 versicolor
## 66           6.7 versicolor
## 69           6.2 versicolor
## 71           5.9 versicolor
## 72           6.1 versicolor
## 73           6.3 versicolor
## 74           6.1 versicolor
## 75           6.4 versicolor
## 76           6.6 versicolor
## 77           6.8 versicolor
## 78           6.7 versicolor
## 79           6.0 versicolor
## 84           6.0 versicolor
## 86           6.0 versicolor
## 87           6.7 versicolor
## 88           6.3 versicolor
## 92           6.1 versicolor
## 98           6.2 versicolor
## 101          6.3  virginica
## 103          7.1  virginica
## 104          6.3  virginica
## 105          6.5  virginica
## 106          7.6  virginica
## 108          7.3  virginica
## 109          6.7  virginica
## 110          7.2  virginica
## 111          6.5  virginica
## 112          6.4  virginica
## 113          6.8  virginica
## 116          6.4  virginica
## 117          6.5  virginica
## 118          7.7  virginica
## 119          7.7  virginica
## 120          6.0  virginica
## 121          6.9  virginica
## 123          7.7  virginica
## 124          6.3  virginica
## 125          6.7  virginica
## 126          7.2  virginica
## 127          6.2  virginica
## 128          6.1  virginica
## 129          6.4  virginica
## 130          7.2  virginica
## 131          7.4  virginica
## 132          7.9  virginica
## 133          6.4  virginica
## 134          6.3  virginica
## 135          6.1  virginica
## 136          7.7  virginica
## 137          6.3  virginica
## 138          6.4  virginica
## 139          6.0  virginica
## 140          6.9  virginica
## 141          6.7  virginica
## 142          6.9  virginica
## 144          6.8  virginica
## 145          6.7  virginica
## 146          6.7  virginica
## 147          6.3  virginica
## 148          6.5  virginica
## 149          6.2  virginica
## 150          5.9  virginica</code></pre>
<p>高级操作：加入正则表达式筛选</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## sometimes requiring a logical 'subset' argument is a nuisance</span>
<span class="va">nm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">state.x77</span><span class="op">)</span>
<span class="va">start_with_M</span> <span class="op">&lt;-</span> <span class="va">nm</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^M"</span>, <span class="va">nm</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">state.x77</span>, <span class="va">start_with_M</span>, <span class="va">Illiteracy</span><span class="op">:</span><span class="va">Murder</span><span class="op">)</span></code></pre></div>
<pre><code>##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0</code></pre>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 简化</span>
<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">state.x77</span>, subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"^M"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">state.x77</span><span class="op">)</span><span class="op">)</span>, select <span class="op">=</span> <span class="va">Illiteracy</span><span class="op">:</span><span class="va">Murder</span><span class="op">)</span></code></pre></div>
<pre><code>##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0</code></pre>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 继续简化</span>
<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">state.x77</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"^M"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">state.x77</span><span class="op">)</span><span class="op">)</span>, <span class="va">Illiteracy</span><span class="op">:</span><span class="va">Murder</span><span class="op">)</span></code></pre></div>
<pre><code>##               Illiteracy Life Exp Murder
## Maine                0.7    70.39    2.7
## Maryland             0.9    70.22    8.5
## Massachusetts        1.1    71.83    3.3
## Michigan             0.9    70.63   11.1
## Minnesota            0.6    72.96    2.3
## Mississippi          2.4    68.09   12.5
## Missouri             0.8    70.69    9.3
## Montana              0.6    70.56    5.0</code></pre>
<div class="rmdnote">
<p>警告：这是一个为了交互使用打造的便捷函数。对于编程，最好使用标准的子集函数，如 <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code>，特别地，参数 <code>subset</code> 的非标准计算(non-standard evaluation)<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Thomas Lumley (2003) Standard nonstandard evaluation rules. &lt;a href="https://developer.r-project.org/nonstandard-eval.pdf" class="uri"&gt;https://developer.r-project.org/nonstandard-eval.pdf&lt;/a&gt;&lt;/p&gt;'><sup>8</sup></a> 可能带来意想不到的后果。</p>
</div>
<p>使用索引 <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code></p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 101          6.3         3.3          6.0         2.5 virginica
## 102          5.8         2.7          5.1         1.9 virginica
## 103          7.1         3.0          5.9         2.1 virginica
## 104          6.3         2.9          5.6         1.8 virginica
## 105          6.5         3.0          5.8         2.2 virginica
## 106          7.6         3.0          6.6         2.1 virginica
## 107          4.9         2.5          4.5         1.7 virginica
## 108          7.3         2.9          6.3         1.8 virginica
## 109          6.7         2.5          5.8         1.8 virginica
## 110          7.2         3.6          6.1         2.5 virginica
## 111          6.5         3.2          5.1         2.0 virginica
## 112          6.4         2.7          5.3         1.9 virginica
## 113          6.8         3.0          5.5         2.1 virginica
## 114          5.7         2.5          5.0         2.0 virginica
## 115          5.8         2.8          5.1         2.4 virginica
## 116          6.4         3.2          5.3         2.3 virginica
## 117          6.5         3.0          5.5         1.8 virginica
## 118          7.7         3.8          6.7         2.2 virginica
## 119          7.7         2.6          6.9         2.3 virginica
## 120          6.0         2.2          5.0         1.5 virginica
## 121          6.9         3.2          5.7         2.3 virginica
## 122          5.6         2.8          4.9         2.0 virginica
## 123          7.7         2.8          6.7         2.0 virginica
## 124          6.3         2.7          4.9         1.8 virginica
## 125          6.7         3.3          5.7         2.1 virginica
## 126          7.2         3.2          6.0         1.8 virginica
## 127          6.2         2.8          4.8         1.8 virginica
## 128          6.1         3.0          4.9         1.8 virginica
## 129          6.4         2.8          5.6         2.1 virginica
## 130          7.2         3.0          5.8         1.6 virginica
## 131          7.4         2.8          6.1         1.9 virginica
## 132          7.9         3.8          6.4         2.0 virginica
## 133          6.4         2.8          5.6         2.2 virginica
## 134          6.3         2.8          5.1         1.5 virginica
## 135          6.1         2.6          5.6         1.4 virginica
## 136          7.7         3.0          6.1         2.3 virginica
## 137          6.3         3.4          5.6         2.4 virginica
## 138          6.4         3.1          5.5         1.8 virginica
## 139          6.0         3.0          4.8         1.8 virginica
## 140          6.9         3.1          5.4         2.1 virginica
## 141          6.7         3.1          5.6         2.4 virginica
## 142          6.9         3.1          5.1         2.3 virginica
## 143          5.8         2.7          5.1         1.9 virginica
## 144          6.8         3.2          5.9         2.3 virginica
## 145          6.7         3.3          5.7         2.5 virginica
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica</code></pre>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span> <span class="op">&amp;</span>
  <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 101          6.3         3.3          6.0         2.5 virginica
## 103          7.1         3.0          5.9         2.1 virginica
## 104          6.3         2.9          5.6         1.8 virginica
## 105          6.5         3.0          5.8         2.2 virginica
## 106          7.6         3.0          6.6         2.1 virginica
## 108          7.3         2.9          6.3         1.8 virginica
## 109          6.7         2.5          5.8         1.8 virginica
## 110          7.2         3.6          6.1         2.5 virginica
## 111          6.5         3.2          5.1         2.0 virginica
## 112          6.4         2.7          5.3         1.9 virginica
## 113          6.8         3.0          5.5         2.1 virginica
## 116          6.4         3.2          5.3         2.3 virginica
## 117          6.5         3.0          5.5         1.8 virginica
## 118          7.7         3.8          6.7         2.2 virginica
## 119          7.7         2.6          6.9         2.3 virginica
## 120          6.0         2.2          5.0         1.5 virginica
## 121          6.9         3.2          5.7         2.3 virginica
## 123          7.7         2.8          6.7         2.0 virginica
## 124          6.3         2.7          4.9         1.8 virginica
## 125          6.7         3.3          5.7         2.1 virginica
## 126          7.2         3.2          6.0         1.8 virginica
## 127          6.2         2.8          4.8         1.8 virginica
## 128          6.1         3.0          4.9         1.8 virginica
## 129          6.4         2.8          5.6         2.1 virginica
## 130          7.2         3.0          5.8         1.6 virginica
## 131          7.4         2.8          6.1         1.9 virginica
## 132          7.9         3.8          6.4         2.0 virginica
## 133          6.4         2.8          5.6         2.2 virginica
## 134          6.3         2.8          5.1         1.5 virginica
## 135          6.1         2.6          5.6         1.4 virginica
## 136          7.7         3.0          6.1         2.3 virginica
## 137          6.3         3.4          5.6         2.4 virginica
## 138          6.4         3.1          5.5         1.8 virginica
## 139          6.0         3.0          4.8         1.8 virginica
## 140          6.9         3.1          5.4         2.1 virginica
## 141          6.7         3.1          5.6         2.4 virginica
## 142          6.9         3.1          5.1         2.3 virginica
## 144          6.8         3.2          5.9         2.3 virginica
## 145          6.7         3.3          5.7         2.5 virginica
## 146          6.7         3.0          5.2         2.3 virginica
## 147          6.3         2.5          5.0         1.9 virginica
## 148          6.5         3.0          5.2         2.0 virginica
## 149          6.2         3.4          5.4         2.3 virginica
## 150          5.9         3.0          5.1         1.8 virginica</code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span>
  <span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span> <span class="op">&amp;</span>
    <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Species"</span><span class="op">)</span>
<span class="op">]</span></code></pre></div>
<pre><code>##     Sepal.Length   Species
## 101          6.3 virginica
## 103          7.1 virginica
## 104          6.3 virginica
## 105          6.5 virginica
## 106          7.6 virginica
## 108          7.3 virginica
## 109          6.7 virginica
## 110          7.2 virginica
## 111          6.5 virginica
## 112          6.4 virginica
## 113          6.8 virginica
## 116          6.4 virginica
## 117          6.5 virginica
## 118          7.7 virginica
## 119          7.7 virginica
## 120          6.0 virginica
## 121          6.9 virginica
## 123          7.7 virginica
## 124          6.3 virginica
## 125          6.7 virginica
## 126          7.2 virginica
## 127          6.2 virginica
## 128          6.1 virginica
## 129          6.4 virginica
## 130          7.2 virginica
## 131          7.4 virginica
## 132          7.9 virginica
## 133          6.4 virginica
## 134          6.3 virginica
## 135          6.1 virginica
## 136          7.7 virginica
## 137          6.3 virginica
## 138          6.4 virginica
## 139          6.0 virginica
## 140          6.9 virginica
## 141          6.7 virginica
## 142          6.9 virginica
## 144          6.8 virginica
## 145          6.7 virginica
## 146          6.7 virginica
## 147          6.3 virginica
## 148          6.5 virginica
## 149          6.2 virginica
## 150          5.9 virginica</code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8</code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">iris</span>,
  subset <span class="op">=</span> <span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>,
  select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 15          5.8         4.0
## 16          5.7         4.4
## 19          5.7         3.8</code></pre>
</div>
<div id="dm-reshape" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> 数据重塑<a class="anchor" aria-label="anchor" href="#dm-reshape"><i class="fas fa-link"></i></a>
</h2>
<p>重复测量数据的变形 Reshape Grouped Data，将宽格式 wide 的数据框变长格式 long的，反之也行。reshape 还支持正则表达式</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">Indometh</span><span class="op">)</span></code></pre></div>
<pre><code>## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   66 obs. of  3 variables:
##  $ Subject: Ord.factor w/ 6 levels "1"&lt;"4"&lt;"2"&lt;"5"&lt;..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ time   : num  0.25 0.5 0.75 1 1.25 2 3 4 5 6 ...
##  $ conc   : num  1.5 0.94 0.78 0.48 0.37 0.19 0.12 0.11 0.08 0.07 ...
##  - attr(*, "formula")=Class 'formula'  language conc ~ time | Subject
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time since drug administration"
##   ..$ y: chr "Indomethacin concentration"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(hr)"
##   ..$ y: chr "(mcg/ml)"</code></pre>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">Indometh</span><span class="op">)</span></code></pre></div>
<pre><code>##  Subject      time            conc       
##  1:11    Min.   :0.250   Min.   :0.0500  
##  4:11    1st Qu.:0.750   1st Qu.:0.1100  
##  2:11    Median :2.000   Median :0.3400  
##  5:11    Mean   :2.886   Mean   :0.5918  
##  6:11    3rd Qu.:5.000   3rd Qu.:0.8325  
##  3:11    Max.   :8.000   Max.   :2.7200</code></pre>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 长的变宽</span>
<span class="va">wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">Indometh</span>,
  v.names <span class="op">=</span> <span class="st">"conc"</span>, idvar <span class="op">=</span> <span class="st">"Subject"</span>,
  timevar <span class="op">=</span> <span class="st">"time"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>
<span class="op">)</span>
<span class="va">wide</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></code></pre></div>
<pre><code>##    Subject conc.0.25 conc.0.5 conc.0.75 conc.1 conc.1.25
## 1        1      1.50     0.94      0.78   0.48      0.37
## 12       2      2.03     1.63      0.71   0.70      0.64
## 23       3      2.72     1.49      1.16   0.80      0.80
## 34       4      1.85     1.39      1.02   0.89      0.59
## 45       5      2.05     1.04      0.81   0.39      0.30
## 56       6      2.31     1.44      1.03   0.84      0.64</code></pre>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 宽的变长</span>
<span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">wide</span>, direction <span class="op">=</span> <span class="st">"long"</span><span class="op">)</span></code></pre></div>
<pre><code>##        Subject time conc
## 1.0.25       1 0.25 1.50
## 2.0.25       2 0.25 2.03
## 3.0.25       3 0.25 2.72
## 4.0.25       4 0.25 1.85
## 5.0.25       5 0.25 2.05
## 6.0.25       6 0.25 2.31
## 1.0.5        1 0.50 0.94
## 2.0.5        2 0.50 1.63
## 3.0.5        3 0.50 1.49
## 4.0.5        4 0.50 1.39
## 5.0.5        5 0.50 1.04
## 6.0.5        6 0.50 1.44
## 1.0.75       1 0.75 0.78
## 2.0.75       2 0.75 0.71
## 3.0.75       3 0.75 1.16
## 4.0.75       4 0.75 1.02
## 5.0.75       5 0.75 0.81
## 6.0.75       6 0.75 1.03
## 1.1          1 1.00 0.48
## 2.1          2 1.00 0.70
## 3.1          3 1.00 0.80
## 4.1          4 1.00 0.89
## 5.1          5 1.00 0.39
## 6.1          6 1.00 0.84
## 1.1.25       1 1.25 0.37
## 2.1.25       2 1.25 0.64
## 3.1.25       3 1.25 0.80
## 4.1.25       4 1.25 0.59
## 5.1.25       5 1.25 0.30
## 6.1.25       6 1.25 0.64
## 1.2          1 2.00 0.19
## 2.2          2 2.00 0.36
## 3.2          3 2.00 0.39
## 4.2          4 2.00 0.40
## 5.2          5 2.00 0.23
## 6.2          6 2.00 0.42
## 1.3          1 3.00 0.12
## 2.3          2 3.00 0.32
## 3.3          3 3.00 0.22
## 4.3          4 3.00 0.16
## 5.3          5 3.00 0.13
## 6.3          6 3.00 0.24
## 1.4          1 4.00 0.11
## 2.4          2 4.00 0.20
## 3.4          3 4.00 0.12
## 4.4          4 4.00 0.11
## 5.4          5 4.00 0.11
## 6.4          6 4.00 0.17
## 1.5          1 5.00 0.08
## 2.5          2 5.00 0.25
## 3.5          3 5.00 0.11
## 4.5          4 5.00 0.10
## 5.5          5 5.00 0.08
## 6.5          6 5.00 0.13
## 1.6          1 6.00 0.07
## 2.6          2 6.00 0.12
## 3.6          3 6.00 0.08
## 4.6          4 6.00 0.07
## 5.6          5 6.00 0.10
## 6.6          6 6.00 0.10
## 1.8          1 8.00 0.05
## 2.8          2 8.00 0.08
## 3.8          3 8.00 0.08
## 4.8          4 8.00 0.07
## 5.8          5 8.00 0.06
## 6.8          6 8.00 0.09</code></pre>
<p>宽的格式变成长的格式 <a href="https://stackoverflow.com/questions/2185252" class="uri">https://stackoverflow.com/questions/2185252</a> 或者长的格式变成宽的格式 <a href="https://stackoverflow.com/questions/5890584/" class="uri">https://stackoverflow.com/questions/5890584/</a></p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Orange"</span>, <span class="st">"Apple"</span><span class="op">)</span>, each<span class="op">=</span><span class="fl">4</span><span class="op">)</span>,
    numbers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat</span></code></pre></div>
<pre><code>##     name numbers      value
## 1 Orange       1  0.3407997
## 2 Orange       2 -0.7033403
## 3 Orange       3 -0.3795377
## 4 Orange       4 -0.7460474
## 5  Apple       1 -0.8981073
## 6  Apple       2 -0.3347941
## 7  Apple       3 -0.5013782
## 8  Apple       4 -0.1745357</code></pre>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">dat</span>, idvar <span class="op">=</span> <span class="st">"name"</span>, timevar <span class="op">=</span> <span class="st">"numbers"</span>, direction <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></code></pre></div>
<pre><code>##     name    value.1    value.2    value.3    value.4
## 1 Orange  0.3407997 -0.7033403 -0.3795377 -0.7460474
## 5  Apple -0.8981073 -0.3347941 -0.5013782 -0.1745357</code></pre>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## times need not be numeric</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
                 visit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Before"</span>,<span class="st">"After"</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
                 x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span></code></pre></div>
<pre><code>##   id  visit          x          y
## 1  1 Before  1.8090374 0.89106978
## 2  1  After -0.2301050 0.06920426
## 3  2 Before -1.1304182 0.94623103
## 4  2  After  0.2159889 0.74850150
## 5  3 Before  1.8090374 0.89106978
## 6  3  After -0.2301050 0.06920426
## 7  4 Before -1.1304182 0.94623103
## 8  4  After  0.2159889 0.74850150</code></pre>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">df</span>, timevar <span class="op">=</span> <span class="st">"visit"</span>, idvar <span class="op">=</span> <span class="st">"id"</span>, direction <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></code></pre></div>
<pre><code>##   id  x.Before  y.Before    x.After    y.After
## 1  1  1.809037 0.8910698 -0.2301050 0.06920426
## 3  2 -1.130418 0.9462310  0.2159889 0.74850150
## 5  3  1.809037 0.8910698 -0.2301050 0.06920426
## 7  4 -1.130418 0.9462310  0.2159889 0.74850150</code></pre>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## warns that y is really varying</span>
<span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">df</span>, timevar <span class="op">=</span> <span class="st">"visit"</span>, idvar <span class="op">=</span> <span class="st">"id"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>, v.names <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in reshapeWide(data, idvar = idvar, timevar = timevar, varying =
## varying, : some constant variables (y) are really varying</code></pre>
<pre><code>##   id         y  x.Before    x.After
## 1  1 0.8910698  1.809037 -0.2301050
## 3  2 0.9462310 -1.130418  0.2159889
## 5  3 0.8910698  1.809037 -0.2301050
## 7  4 0.9462310 -1.130418  0.2159889</code></pre>
<p>更加复杂的例子， gambia 数据集，重塑的效果是使得个体水平的长格式变为村庄水平的宽格式</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data(gambia, package = "geoR")</span>
<span class="co"># 在线下载数据集</span>
<span class="va">gambia</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span>
  file <span class="op">=</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"http://www.leg.ufpr.br/lib/exe/fetch.php"</span>,
      <span class="st">"pessoais:paulojus:mbgbook:datasets:gambia.txt"</span>,
      sep <span class="op">=</span> <span class="st">"/"</span>
    <span class="op">)</span>, header <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">gambia</span><span class="op">)</span>
<span class="co"># Building a "village-level" data frame</span>
<span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="va">gambia</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="st">"y"</span>, <span class="va">gambia</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="va">village</span> <span class="op">&lt;-</span> <span class="va">gambia</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">]</span>
<span class="va">village</span><span class="op">$</span><span class="va">prev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">gambia</span><span class="op">$</span><span class="va">pos</span>, <span class="va">ind</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">village</span><span class="op">)</span></code></pre></div>
</div>
<div id="dm-transform" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> 数据转换<a class="anchor" aria-label="anchor" href="#dm-transform"><i class="fas fa-link"></i></a>
</h2>
<p>transform 对数据框中的某些列做计算，取对数，将计算的结果单存一列加到数据框中</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span><span class="op">(</span><span class="va">iris</span>, scale.sl <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span> <span class="op">-</span> <span class="va">Sepal.Length</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species   scale.sl
## 1            5.1         3.5          1.4         0.2     setosa 0.77777778
## 2            4.9         3.0          1.4         0.2     setosa 0.83333333
## 3            4.7         3.2          1.3         0.2     setosa 0.88888889
## 4            4.6         3.1          1.5         0.2     setosa 0.91666667
## 5            5.0         3.6          1.4         0.2     setosa 0.80555556
## 6            5.4         3.9          1.7         0.4     setosa 0.69444444
## 7            4.6         3.4          1.4         0.3     setosa 0.91666667
## 8            5.0         3.4          1.5         0.2     setosa 0.80555556
## 9            4.4         2.9          1.4         0.2     setosa 0.97222222
## 10           4.9         3.1          1.5         0.1     setosa 0.83333333
## 11           5.4         3.7          1.5         0.2     setosa 0.69444444
## 12           4.8         3.4          1.6         0.2     setosa 0.86111111
## 13           4.8         3.0          1.4         0.1     setosa 0.86111111
## 14           4.3         3.0          1.1         0.1     setosa 1.00000000
## 15           5.8         4.0          1.2         0.2     setosa 0.58333333
## 16           5.7         4.4          1.5         0.4     setosa 0.61111111
## 17           5.4         3.9          1.3         0.4     setosa 0.69444444
## 18           5.1         3.5          1.4         0.3     setosa 0.77777778
## 19           5.7         3.8          1.7         0.3     setosa 0.61111111
## 20           5.1         3.8          1.5         0.3     setosa 0.77777778
## 21           5.4         3.4          1.7         0.2     setosa 0.69444444
## 22           5.1         3.7          1.5         0.4     setosa 0.77777778
## 23           4.6         3.6          1.0         0.2     setosa 0.91666667
## 24           5.1         3.3          1.7         0.5     setosa 0.77777778
## 25           4.8         3.4          1.9         0.2     setosa 0.86111111
## 26           5.0         3.0          1.6         0.2     setosa 0.80555556
## 27           5.0         3.4          1.6         0.4     setosa 0.80555556
## 28           5.2         3.5          1.5         0.2     setosa 0.75000000
## 29           5.2         3.4          1.4         0.2     setosa 0.75000000
## 30           4.7         3.2          1.6         0.2     setosa 0.88888889
## 31           4.8         3.1          1.6         0.2     setosa 0.86111111
## 32           5.4         3.4          1.5         0.4     setosa 0.69444444
## 33           5.2         4.1          1.5         0.1     setosa 0.75000000
## 34           5.5         4.2          1.4         0.2     setosa 0.66666667
## 35           4.9         3.1          1.5         0.2     setosa 0.83333333
## 36           5.0         3.2          1.2         0.2     setosa 0.80555556
## 37           5.5         3.5          1.3         0.2     setosa 0.66666667
## 38           4.9         3.6          1.4         0.1     setosa 0.83333333
## 39           4.4         3.0          1.3         0.2     setosa 0.97222222
## 40           5.1         3.4          1.5         0.2     setosa 0.77777778
## 41           5.0         3.5          1.3         0.3     setosa 0.80555556
## 42           4.5         2.3          1.3         0.3     setosa 0.94444444
## 43           4.4         3.2          1.3         0.2     setosa 0.97222222
## 44           5.0         3.5          1.6         0.6     setosa 0.80555556
## 45           5.1         3.8          1.9         0.4     setosa 0.77777778
## 46           4.8         3.0          1.4         0.3     setosa 0.86111111
## 47           5.1         3.8          1.6         0.2     setosa 0.77777778
## 48           4.6         3.2          1.4         0.2     setosa 0.91666667
## 49           5.3         3.7          1.5         0.2     setosa 0.72222222
## 50           5.0         3.3          1.4         0.2     setosa 0.80555556
## 51           7.0         3.2          4.7         1.4 versicolor 0.25000000
## 52           6.4         3.2          4.5         1.5 versicolor 0.41666667
## 53           6.9         3.1          4.9         1.5 versicolor 0.27777778
## 54           5.5         2.3          4.0         1.3 versicolor 0.66666667
## 55           6.5         2.8          4.6         1.5 versicolor 0.38888889
## 56           5.7         2.8          4.5         1.3 versicolor 0.61111111
## 57           6.3         3.3          4.7         1.6 versicolor 0.44444444
## 58           4.9         2.4          3.3         1.0 versicolor 0.83333333
## 59           6.6         2.9          4.6         1.3 versicolor 0.36111111
## 60           5.2         2.7          3.9         1.4 versicolor 0.75000000
## 61           5.0         2.0          3.5         1.0 versicolor 0.80555556
## 62           5.9         3.0          4.2         1.5 versicolor 0.55555556
## 63           6.0         2.2          4.0         1.0 versicolor 0.52777778
## 64           6.1         2.9          4.7         1.4 versicolor 0.50000000
## 65           5.6         2.9          3.6         1.3 versicolor 0.63888889
## 66           6.7         3.1          4.4         1.4 versicolor 0.33333333
## 67           5.6         3.0          4.5         1.5 versicolor 0.63888889
## 68           5.8         2.7          4.1         1.0 versicolor 0.58333333
## 69           6.2         2.2          4.5         1.5 versicolor 0.47222222
## 70           5.6         2.5          3.9         1.1 versicolor 0.63888889
## 71           5.9         3.2          4.8         1.8 versicolor 0.55555556
## 72           6.1         2.8          4.0         1.3 versicolor 0.50000000
## 73           6.3         2.5          4.9         1.5 versicolor 0.44444444
## 74           6.1         2.8          4.7         1.2 versicolor 0.50000000
## 75           6.4         2.9          4.3         1.3 versicolor 0.41666667
## 76           6.6         3.0          4.4         1.4 versicolor 0.36111111
## 77           6.8         2.8          4.8         1.4 versicolor 0.30555556
## 78           6.7         3.0          5.0         1.7 versicolor 0.33333333
## 79           6.0         2.9          4.5         1.5 versicolor 0.52777778
## 80           5.7         2.6          3.5         1.0 versicolor 0.61111111
## 81           5.5         2.4          3.8         1.1 versicolor 0.66666667
## 82           5.5         2.4          3.7         1.0 versicolor 0.66666667
## 83           5.8         2.7          3.9         1.2 versicolor 0.58333333
## 84           6.0         2.7          5.1         1.6 versicolor 0.52777778
## 85           5.4         3.0          4.5         1.5 versicolor 0.69444444
## 86           6.0         3.4          4.5         1.6 versicolor 0.52777778
## 87           6.7         3.1          4.7         1.5 versicolor 0.33333333
## 88           6.3         2.3          4.4         1.3 versicolor 0.44444444
## 89           5.6         3.0          4.1         1.3 versicolor 0.63888889
## 90           5.5         2.5          4.0         1.3 versicolor 0.66666667
## 91           5.5         2.6          4.4         1.2 versicolor 0.66666667
## 92           6.1         3.0          4.6         1.4 versicolor 0.50000000
## 93           5.8         2.6          4.0         1.2 versicolor 0.58333333
## 94           5.0         2.3          3.3         1.0 versicolor 0.80555556
## 95           5.6         2.7          4.2         1.3 versicolor 0.63888889
## 96           5.7         3.0          4.2         1.2 versicolor 0.61111111
## 97           5.7         2.9          4.2         1.3 versicolor 0.61111111
## 98           6.2         2.9          4.3         1.3 versicolor 0.47222222
## 99           5.1         2.5          3.0         1.1 versicolor 0.77777778
## 100          5.7         2.8          4.1         1.3 versicolor 0.61111111
## 101          6.3         3.3          6.0         2.5  virginica 0.44444444
## 102          5.8         2.7          5.1         1.9  virginica 0.58333333
## 103          7.1         3.0          5.9         2.1  virginica 0.22222222
## 104          6.3         2.9          5.6         1.8  virginica 0.44444444
## 105          6.5         3.0          5.8         2.2  virginica 0.38888889
## 106          7.6         3.0          6.6         2.1  virginica 0.08333333
## 107          4.9         2.5          4.5         1.7  virginica 0.83333333
## 108          7.3         2.9          6.3         1.8  virginica 0.16666667
## 109          6.7         2.5          5.8         1.8  virginica 0.33333333
## 110          7.2         3.6          6.1         2.5  virginica 0.19444444
## 111          6.5         3.2          5.1         2.0  virginica 0.38888889
## 112          6.4         2.7          5.3         1.9  virginica 0.41666667
## 113          6.8         3.0          5.5         2.1  virginica 0.30555556
## 114          5.7         2.5          5.0         2.0  virginica 0.61111111
## 115          5.8         2.8          5.1         2.4  virginica 0.58333333
## 116          6.4         3.2          5.3         2.3  virginica 0.41666667
## 117          6.5         3.0          5.5         1.8  virginica 0.38888889
## 118          7.7         3.8          6.7         2.2  virginica 0.05555556
## 119          7.7         2.6          6.9         2.3  virginica 0.05555556
## 120          6.0         2.2          5.0         1.5  virginica 0.52777778
## 121          6.9         3.2          5.7         2.3  virginica 0.27777778
## 122          5.6         2.8          4.9         2.0  virginica 0.63888889
## 123          7.7         2.8          6.7         2.0  virginica 0.05555556
## 124          6.3         2.7          4.9         1.8  virginica 0.44444444
## 125          6.7         3.3          5.7         2.1  virginica 0.33333333
## 126          7.2         3.2          6.0         1.8  virginica 0.19444444
## 127          6.2         2.8          4.8         1.8  virginica 0.47222222
## 128          6.1         3.0          4.9         1.8  virginica 0.50000000
## 129          6.4         2.8          5.6         2.1  virginica 0.41666667
## 130          7.2         3.0          5.8         1.6  virginica 0.19444444
## 131          7.4         2.8          6.1         1.9  virginica 0.13888889
## 132          7.9         3.8          6.4         2.0  virginica 0.00000000
## 133          6.4         2.8          5.6         2.2  virginica 0.41666667
## 134          6.3         2.8          5.1         1.5  virginica 0.44444444
## 135          6.1         2.6          5.6         1.4  virginica 0.50000000
## 136          7.7         3.0          6.1         2.3  virginica 0.05555556
## 137          6.3         3.4          5.6         2.4  virginica 0.44444444
## 138          6.4         3.1          5.5         1.8  virginica 0.41666667
## 139          6.0         3.0          4.8         1.8  virginica 0.52777778
## 140          6.9         3.1          5.4         2.1  virginica 0.27777778
## 141          6.7         3.1          5.6         2.4  virginica 0.33333333
## 142          6.9         3.1          5.1         2.3  virginica 0.27777778
## 143          5.8         2.7          5.1         1.9  virginica 0.58333333
## 144          6.8         3.2          5.9         2.3  virginica 0.30555556
## 145          6.7         3.3          5.7         2.5  virginica 0.33333333
## 146          6.7         3.0          5.2         2.3  virginica 0.33333333
## 147          6.3         2.5          5.0         1.9  virginica 0.44444444
## 148          6.5         3.0          5.2         2.0  virginica 0.38888889
## 149          6.2         3.4          5.4         2.3  virginica 0.47222222
## 150          5.9         3.0          5.1         1.8  virginica 0.55555556</code></pre>
<p>验证一下 <code>scale.sl</code> 变量的第一个值</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5.1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.7777778</code></pre>
<div class="rmdnote">
<p>Warning: This is a convenience function intended for use interactively. For programming it is better to use the standard subsetting arithmetic functions, and in particular the non-standard evaluation of argument <code>transform</code> can have unanticipated consequences.</p>
</div>
</div>
<div id="dm-order" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> 按列排序<a class="anchor" aria-label="anchor" href="#dm-order"><i class="fas fa-link"></i></a>
</h2>
<p>在数据框内，根据(order)某一列或几列对行进行排序(sort)，根据鸢尾花(iris)的类别(Species)对萼片(sepal)的长度进行排序，其余的列随之变化</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 对萼片的长度排序</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 14           4.3         3.0          1.1         0.1     setosa
## 9            4.4         2.9          1.4         0.2     setosa
## 39           4.4         3.0          1.3         0.2     setosa
## 43           4.4         3.2          1.3         0.2     setosa
## 42           4.5         2.3          1.3         0.3     setosa
## 4            4.6         3.1          1.5         0.2     setosa
## 7            4.6         3.4          1.4         0.3     setosa
## 23           4.6         3.6          1.0         0.2     setosa
## 48           4.6         3.2          1.4         0.2     setosa
## 3            4.7         3.2          1.3         0.2     setosa
## 30           4.7         3.2          1.6         0.2     setosa
## 12           4.8         3.4          1.6         0.2     setosa
## 13           4.8         3.0          1.4         0.1     setosa
## 25           4.8         3.4          1.9         0.2     setosa
## 31           4.8         3.1          1.6         0.2     setosa
## 46           4.8         3.0          1.4         0.3     setosa
## 2            4.9         3.0          1.4         0.2     setosa
## 10           4.9         3.1          1.5         0.1     setosa
## 35           4.9         3.1          1.5         0.2     setosa
## 38           4.9         3.6          1.4         0.1     setosa
## 5            5.0         3.6          1.4         0.2     setosa
## 8            5.0         3.4          1.5         0.2     setosa
## 26           5.0         3.0          1.6         0.2     setosa
## 27           5.0         3.4          1.6         0.4     setosa
## 36           5.0         3.2          1.2         0.2     setosa
## 41           5.0         3.5          1.3         0.3     setosa
## 44           5.0         3.5          1.6         0.6     setosa
## 50           5.0         3.3          1.4         0.2     setosa
## 1            5.1         3.5          1.4         0.2     setosa
## 18           5.1         3.5          1.4         0.3     setosa
## 20           5.1         3.8          1.5         0.3     setosa
## 22           5.1         3.7          1.5         0.4     setosa
## 24           5.1         3.3          1.7         0.5     setosa
## 40           5.1         3.4          1.5         0.2     setosa
## 45           5.1         3.8          1.9         0.4     setosa
## 47           5.1         3.8          1.6         0.2     setosa
## 28           5.2         3.5          1.5         0.2     setosa
## 29           5.2         3.4          1.4         0.2     setosa
## 33           5.2         4.1          1.5         0.1     setosa
## 49           5.3         3.7          1.5         0.2     setosa
## 6            5.4         3.9          1.7         0.4     setosa
## 11           5.4         3.7          1.5         0.2     setosa
## 17           5.4         3.9          1.3         0.4     setosa
## 21           5.4         3.4          1.7         0.2     setosa
## 32           5.4         3.4          1.5         0.4     setosa
## 34           5.5         4.2          1.4         0.2     setosa
## 37           5.5         3.5          1.3         0.2     setosa
## 16           5.7         4.4          1.5         0.4     setosa
## 19           5.7         3.8          1.7         0.3     setosa
## 15           5.8         4.0          1.2         0.2     setosa
## 58           4.9         2.4          3.3         1.0 versicolor
## 61           5.0         2.0          3.5         1.0 versicolor
## 94           5.0         2.3          3.3         1.0 versicolor
## 99           5.1         2.5          3.0         1.1 versicolor
## 60           5.2         2.7          3.9         1.4 versicolor
## 85           5.4         3.0          4.5         1.5 versicolor
## 54           5.5         2.3          4.0         1.3 versicolor
## 81           5.5         2.4          3.8         1.1 versicolor
## 82           5.5         2.4          3.7         1.0 versicolor
## 90           5.5         2.5          4.0         1.3 versicolor
## 91           5.5         2.6          4.4         1.2 versicolor
## 65           5.6         2.9          3.6         1.3 versicolor
## 67           5.6         3.0          4.5         1.5 versicolor
## 70           5.6         2.5          3.9         1.1 versicolor
## 89           5.6         3.0          4.1         1.3 versicolor
## 95           5.6         2.7          4.2         1.3 versicolor
## 56           5.7         2.8          4.5         1.3 versicolor
## 80           5.7         2.6          3.5         1.0 versicolor
## 96           5.7         3.0          4.2         1.2 versicolor
## 97           5.7         2.9          4.2         1.3 versicolor
## 100          5.7         2.8          4.1         1.3 versicolor
## 68           5.8         2.7          4.1         1.0 versicolor
## 83           5.8         2.7          3.9         1.2 versicolor
## 93           5.8         2.6          4.0         1.2 versicolor
## 62           5.9         3.0          4.2         1.5 versicolor
## 71           5.9         3.2          4.8         1.8 versicolor
## 63           6.0         2.2          4.0         1.0 versicolor
## 79           6.0         2.9          4.5         1.5 versicolor
## 84           6.0         2.7          5.1         1.6 versicolor
## 86           6.0         3.4          4.5         1.6 versicolor
## 64           6.1         2.9          4.7         1.4 versicolor
## 72           6.1         2.8          4.0         1.3 versicolor
## 74           6.1         2.8          4.7         1.2 versicolor
## 92           6.1         3.0          4.6         1.4 versicolor
## 69           6.2         2.2          4.5         1.5 versicolor
## 98           6.2         2.9          4.3         1.3 versicolor
## 57           6.3         3.3          4.7         1.6 versicolor
## 73           6.3         2.5          4.9         1.5 versicolor
## 88           6.3         2.3          4.4         1.3 versicolor
## 52           6.4         3.2          4.5         1.5 versicolor
## 75           6.4         2.9          4.3         1.3 versicolor
## 55           6.5         2.8          4.6         1.5 versicolor
## 59           6.6         2.9          4.6         1.3 versicolor
## 76           6.6         3.0          4.4         1.4 versicolor
## 66           6.7         3.1          4.4         1.4 versicolor
## 78           6.7         3.0          5.0         1.7 versicolor
## 87           6.7         3.1          4.7         1.5 versicolor
## 77           6.8         2.8          4.8         1.4 versicolor
## 53           6.9         3.1          4.9         1.5 versicolor
## 51           7.0         3.2          4.7         1.4 versicolor
## 107          4.9         2.5          4.5         1.7  virginica
## 122          5.6         2.8          4.9         2.0  virginica
## 114          5.7         2.5          5.0         2.0  virginica
## 102          5.8         2.7          5.1         1.9  virginica
## 115          5.8         2.8          5.1         2.4  virginica
## 143          5.8         2.7          5.1         1.9  virginica
## 150          5.9         3.0          5.1         1.8  virginica
## 120          6.0         2.2          5.0         1.5  virginica
## 139          6.0         3.0          4.8         1.8  virginica
## 128          6.1         3.0          4.9         1.8  virginica
## 135          6.1         2.6          5.6         1.4  virginica
## 127          6.2         2.8          4.8         1.8  virginica
## 149          6.2         3.4          5.4         2.3  virginica
## 101          6.3         3.3          6.0         2.5  virginica
## 104          6.3         2.9          5.6         1.8  virginica
## 124          6.3         2.7          4.9         1.8  virginica
## 134          6.3         2.8          5.1         1.5  virginica
## 137          6.3         3.4          5.6         2.4  virginica
## 147          6.3         2.5          5.0         1.9  virginica
## 112          6.4         2.7          5.3         1.9  virginica
## 116          6.4         3.2          5.3         2.3  virginica
## 129          6.4         2.8          5.6         2.1  virginica
## 133          6.4         2.8          5.6         2.2  virginica
## 138          6.4         3.1          5.5         1.8  virginica
## 105          6.5         3.0          5.8         2.2  virginica
## 111          6.5         3.2          5.1         2.0  virginica
## 117          6.5         3.0          5.5         1.8  virginica
## 148          6.5         3.0          5.2         2.0  virginica
## 109          6.7         2.5          5.8         1.8  virginica
## 125          6.7         3.3          5.7         2.1  virginica
## 141          6.7         3.1          5.6         2.4  virginica
## 145          6.7         3.3          5.7         2.5  virginica
## 146          6.7         3.0          5.2         2.3  virginica
## 113          6.8         3.0          5.5         2.1  virginica
## 144          6.8         3.2          5.9         2.3  virginica
## 121          6.9         3.2          5.7         2.3  virginica
## 140          6.9         3.1          5.4         2.1  virginica
## 142          6.9         3.1          5.1         2.3  virginica
## 103          7.1         3.0          5.9         2.1  virginica
## 110          7.2         3.6          6.1         2.5  virginica
## 126          7.2         3.2          6.0         1.8  virginica
## 130          7.2         3.0          5.8         1.6  virginica
## 108          7.3         2.9          6.3         1.8  virginica
## 131          7.4         2.8          6.1         1.9  virginica
## 106          7.6         3.0          6.6         2.1  virginica
## 118          7.7         3.8          6.7         2.2  virginica
## 119          7.7         2.6          6.9         2.3  virginica
## 123          7.7         2.8          6.7         2.0  virginica
## 136          7.7         3.0          6.1         2.3  virginica
## 132          7.9         3.8          6.4         2.0  virginica</code></pre>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 对花瓣的长度排序</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 23           4.6         3.6          1.0         0.2     setosa
## 14           4.3         3.0          1.1         0.1     setosa
## 15           5.8         4.0          1.2         0.2     setosa
## 36           5.0         3.2          1.2         0.2     setosa
## 3            4.7         3.2          1.3         0.2     setosa
## 17           5.4         3.9          1.3         0.4     setosa
## 37           5.5         3.5          1.3         0.2     setosa
## 39           4.4         3.0          1.3         0.2     setosa
## 41           5.0         3.5          1.3         0.3     setosa
## 42           4.5         2.3          1.3         0.3     setosa
## 43           4.4         3.2          1.3         0.2     setosa
## 1            5.1         3.5          1.4         0.2     setosa
## 2            4.9         3.0          1.4         0.2     setosa
## 5            5.0         3.6          1.4         0.2     setosa
## 7            4.6         3.4          1.4         0.3     setosa
## 9            4.4         2.9          1.4         0.2     setosa
## 13           4.8         3.0          1.4         0.1     setosa
## 18           5.1         3.5          1.4         0.3     setosa
## 29           5.2         3.4          1.4         0.2     setosa
## 34           5.5         4.2          1.4         0.2     setosa
## 38           4.9         3.6          1.4         0.1     setosa
## 46           4.8         3.0          1.4         0.3     setosa
## 48           4.6         3.2          1.4         0.2     setosa
## 50           5.0         3.3          1.4         0.2     setosa
## 4            4.6         3.1          1.5         0.2     setosa
## 8            5.0         3.4          1.5         0.2     setosa
## 10           4.9         3.1          1.5         0.1     setosa
## 11           5.4         3.7          1.5         0.2     setosa
## 16           5.7         4.4          1.5         0.4     setosa
## 20           5.1         3.8          1.5         0.3     setosa
## 22           5.1         3.7          1.5         0.4     setosa
## 28           5.2         3.5          1.5         0.2     setosa
## 32           5.4         3.4          1.5         0.4     setosa
## 33           5.2         4.1          1.5         0.1     setosa
## 35           4.9         3.1          1.5         0.2     setosa
## 40           5.1         3.4          1.5         0.2     setosa
## 49           5.3         3.7          1.5         0.2     setosa
## 12           4.8         3.4          1.6         0.2     setosa
## 26           5.0         3.0          1.6         0.2     setosa
## 27           5.0         3.4          1.6         0.4     setosa
## 30           4.7         3.2          1.6         0.2     setosa
## 31           4.8         3.1          1.6         0.2     setosa
## 44           5.0         3.5          1.6         0.6     setosa
## 47           5.1         3.8          1.6         0.2     setosa
## 6            5.4         3.9          1.7         0.4     setosa
## 19           5.7         3.8          1.7         0.3     setosa
## 21           5.4         3.4          1.7         0.2     setosa
## 24           5.1         3.3          1.7         0.5     setosa
## 25           4.8         3.4          1.9         0.2     setosa
## 45           5.1         3.8          1.9         0.4     setosa
## 99           5.1         2.5          3.0         1.1 versicolor
## 58           4.9         2.4          3.3         1.0 versicolor
## 94           5.0         2.3          3.3         1.0 versicolor
## 61           5.0         2.0          3.5         1.0 versicolor
## 80           5.7         2.6          3.5         1.0 versicolor
## 65           5.6         2.9          3.6         1.3 versicolor
## 82           5.5         2.4          3.7         1.0 versicolor
## 81           5.5         2.4          3.8         1.1 versicolor
## 60           5.2         2.7          3.9         1.4 versicolor
## 70           5.6         2.5          3.9         1.1 versicolor
## 83           5.8         2.7          3.9         1.2 versicolor
## 54           5.5         2.3          4.0         1.3 versicolor
## 63           6.0         2.2          4.0         1.0 versicolor
## 72           6.1         2.8          4.0         1.3 versicolor
## 90           5.5         2.5          4.0         1.3 versicolor
## 93           5.8         2.6          4.0         1.2 versicolor
## 68           5.8         2.7          4.1         1.0 versicolor
## 89           5.6         3.0          4.1         1.3 versicolor
## 100          5.7         2.8          4.1         1.3 versicolor
## 62           5.9         3.0          4.2         1.5 versicolor
## 95           5.6         2.7          4.2         1.3 versicolor
## 96           5.7         3.0          4.2         1.2 versicolor
## 97           5.7         2.9          4.2         1.3 versicolor
## 75           6.4         2.9          4.3         1.3 versicolor
## 98           6.2         2.9          4.3         1.3 versicolor
## 66           6.7         3.1          4.4         1.4 versicolor
## 76           6.6         3.0          4.4         1.4 versicolor
## 88           6.3         2.3          4.4         1.3 versicolor
## 91           5.5         2.6          4.4         1.2 versicolor
## 52           6.4         3.2          4.5         1.5 versicolor
## 56           5.7         2.8          4.5         1.3 versicolor
## 67           5.6         3.0          4.5         1.5 versicolor
## 69           6.2         2.2          4.5         1.5 versicolor
## 79           6.0         2.9          4.5         1.5 versicolor
## 85           5.4         3.0          4.5         1.5 versicolor
## 86           6.0         3.4          4.5         1.6 versicolor
## 55           6.5         2.8          4.6         1.5 versicolor
## 59           6.6         2.9          4.6         1.3 versicolor
## 92           6.1         3.0          4.6         1.4 versicolor
## 51           7.0         3.2          4.7         1.4 versicolor
## 57           6.3         3.3          4.7         1.6 versicolor
## 64           6.1         2.9          4.7         1.4 versicolor
## 74           6.1         2.8          4.7         1.2 versicolor
## 87           6.7         3.1          4.7         1.5 versicolor
## 71           5.9         3.2          4.8         1.8 versicolor
## 77           6.8         2.8          4.8         1.4 versicolor
## 53           6.9         3.1          4.9         1.5 versicolor
## 73           6.3         2.5          4.9         1.5 versicolor
## 78           6.7         3.0          5.0         1.7 versicolor
## 84           6.0         2.7          5.1         1.6 versicolor
## 107          4.9         2.5          4.5         1.7  virginica
## 127          6.2         2.8          4.8         1.8  virginica
## 139          6.0         3.0          4.8         1.8  virginica
## 122          5.6         2.8          4.9         2.0  virginica
## 124          6.3         2.7          4.9         1.8  virginica
## 128          6.1         3.0          4.9         1.8  virginica
## 114          5.7         2.5          5.0         2.0  virginica
## 120          6.0         2.2          5.0         1.5  virginica
## 147          6.3         2.5          5.0         1.9  virginica
## 102          5.8         2.7          5.1         1.9  virginica
## 111          6.5         3.2          5.1         2.0  virginica
## 115          5.8         2.8          5.1         2.4  virginica
## 134          6.3         2.8          5.1         1.5  virginica
## 142          6.9         3.1          5.1         2.3  virginica
## 143          5.8         2.7          5.1         1.9  virginica
## 150          5.9         3.0          5.1         1.8  virginica
## 146          6.7         3.0          5.2         2.3  virginica
## 148          6.5         3.0          5.2         2.0  virginica
## 112          6.4         2.7          5.3         1.9  virginica
## 116          6.4         3.2          5.3         2.3  virginica
## 140          6.9         3.1          5.4         2.1  virginica
## 149          6.2         3.4          5.4         2.3  virginica
## 113          6.8         3.0          5.5         2.1  virginica
## 117          6.5         3.0          5.5         1.8  virginica
## 138          6.4         3.1          5.5         1.8  virginica
## 104          6.3         2.9          5.6         1.8  virginica
## 129          6.4         2.8          5.6         2.1  virginica
## 133          6.4         2.8          5.6         2.2  virginica
## 135          6.1         2.6          5.6         1.4  virginica
## 137          6.3         3.4          5.6         2.4  virginica
## 141          6.7         3.1          5.6         2.4  virginica
## 121          6.9         3.2          5.7         2.3  virginica
## 125          6.7         3.3          5.7         2.1  virginica
## 145          6.7         3.3          5.7         2.5  virginica
## 105          6.5         3.0          5.8         2.2  virginica
## 109          6.7         2.5          5.8         1.8  virginica
## 130          7.2         3.0          5.8         1.6  virginica
## 103          7.1         3.0          5.9         2.1  virginica
## 144          6.8         3.2          5.9         2.3  virginica
## 101          6.3         3.3          6.0         2.5  virginica
## 126          7.2         3.2          6.0         1.8  virginica
## 110          7.2         3.6          6.1         2.5  virginica
## 131          7.4         2.8          6.1         1.9  virginica
## 136          7.7         3.0          6.1         2.3  virginica
## 108          7.3         2.9          6.3         1.8  virginica
## 132          7.9         3.8          6.4         2.0  virginica
## 106          7.6         3.0          6.6         2.1  virginica
## 118          7.7         3.8          6.7         2.2  virginica
## 123          7.7         2.8          6.7         2.0  virginica
## 119          7.7         2.6          6.9         2.3  virginica</code></pre>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 先对花瓣的宽度排序，再对花瓣的长度排序</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Width</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 14           4.3         3.0          1.1         0.1     setosa
## 13           4.8         3.0          1.4         0.1     setosa
## 38           4.9         3.6          1.4         0.1     setosa
## 10           4.9         3.1          1.5         0.1     setosa
## 33           5.2         4.1          1.5         0.1     setosa
## 23           4.6         3.6          1.0         0.2     setosa
## 15           5.8         4.0          1.2         0.2     setosa
## 36           5.0         3.2          1.2         0.2     setosa
## 3            4.7         3.2          1.3         0.2     setosa
## 37           5.5         3.5          1.3         0.2     setosa
## 39           4.4         3.0          1.3         0.2     setosa
## 43           4.4         3.2          1.3         0.2     setosa
## 1            5.1         3.5          1.4         0.2     setosa
## 2            4.9         3.0          1.4         0.2     setosa
## 5            5.0         3.6          1.4         0.2     setosa
## 9            4.4         2.9          1.4         0.2     setosa
## 29           5.2         3.4          1.4         0.2     setosa
## 34           5.5         4.2          1.4         0.2     setosa
## 48           4.6         3.2          1.4         0.2     setosa
## 50           5.0         3.3          1.4         0.2     setosa
## 4            4.6         3.1          1.5         0.2     setosa
## 8            5.0         3.4          1.5         0.2     setosa
## 11           5.4         3.7          1.5         0.2     setosa
## 28           5.2         3.5          1.5         0.2     setosa
## 35           4.9         3.1          1.5         0.2     setosa
## 40           5.1         3.4          1.5         0.2     setosa
## 49           5.3         3.7          1.5         0.2     setosa
## 12           4.8         3.4          1.6         0.2     setosa
## 26           5.0         3.0          1.6         0.2     setosa
## 30           4.7         3.2          1.6         0.2     setosa
## 31           4.8         3.1          1.6         0.2     setosa
## 47           5.1         3.8          1.6         0.2     setosa
## 21           5.4         3.4          1.7         0.2     setosa
## 25           4.8         3.4          1.9         0.2     setosa
## 41           5.0         3.5          1.3         0.3     setosa
## 42           4.5         2.3          1.3         0.3     setosa
## 7            4.6         3.4          1.4         0.3     setosa
## 18           5.1         3.5          1.4         0.3     setosa
## 46           4.8         3.0          1.4         0.3     setosa
## 20           5.1         3.8          1.5         0.3     setosa
## 19           5.7         3.8          1.7         0.3     setosa
## 17           5.4         3.9          1.3         0.4     setosa
## 16           5.7         4.4          1.5         0.4     setosa
## 22           5.1         3.7          1.5         0.4     setosa
## 32           5.4         3.4          1.5         0.4     setosa
## 27           5.0         3.4          1.6         0.4     setosa
## 6            5.4         3.9          1.7         0.4     setosa
## 45           5.1         3.8          1.9         0.4     setosa
## 24           5.1         3.3          1.7         0.5     setosa
## 44           5.0         3.5          1.6         0.6     setosa
## 58           4.9         2.4          3.3         1.0 versicolor
## 94           5.0         2.3          3.3         1.0 versicolor
## 61           5.0         2.0          3.5         1.0 versicolor
## 80           5.7         2.6          3.5         1.0 versicolor
## 82           5.5         2.4          3.7         1.0 versicolor
## 63           6.0         2.2          4.0         1.0 versicolor
## 68           5.8         2.7          4.1         1.0 versicolor
## 99           5.1         2.5          3.0         1.1 versicolor
## 81           5.5         2.4          3.8         1.1 versicolor
## 70           5.6         2.5          3.9         1.1 versicolor
## 83           5.8         2.7          3.9         1.2 versicolor
## 93           5.8         2.6          4.0         1.2 versicolor
## 96           5.7         3.0          4.2         1.2 versicolor
## 91           5.5         2.6          4.4         1.2 versicolor
## 74           6.1         2.8          4.7         1.2 versicolor
## 65           5.6         2.9          3.6         1.3 versicolor
## 54           5.5         2.3          4.0         1.3 versicolor
## 72           6.1         2.8          4.0         1.3 versicolor
## 90           5.5         2.5          4.0         1.3 versicolor
## 89           5.6         3.0          4.1         1.3 versicolor
## 100          5.7         2.8          4.1         1.3 versicolor
## 95           5.6         2.7          4.2         1.3 versicolor
## 97           5.7         2.9          4.2         1.3 versicolor
## 75           6.4         2.9          4.3         1.3 versicolor
## 98           6.2         2.9          4.3         1.3 versicolor
## 88           6.3         2.3          4.4         1.3 versicolor
## 56           5.7         2.8          4.5         1.3 versicolor
## 59           6.6         2.9          4.6         1.3 versicolor
## 60           5.2         2.7          3.9         1.4 versicolor
## 66           6.7         3.1          4.4         1.4 versicolor
## 76           6.6         3.0          4.4         1.4 versicolor
## 92           6.1         3.0          4.6         1.4 versicolor
## 51           7.0         3.2          4.7         1.4 versicolor
## 64           6.1         2.9          4.7         1.4 versicolor
## 77           6.8         2.8          4.8         1.4 versicolor
## 135          6.1         2.6          5.6         1.4  virginica
## 62           5.9         3.0          4.2         1.5 versicolor
## 52           6.4         3.2          4.5         1.5 versicolor
## 67           5.6         3.0          4.5         1.5 versicolor
## 69           6.2         2.2          4.5         1.5 versicolor
## 79           6.0         2.9          4.5         1.5 versicolor
## 85           5.4         3.0          4.5         1.5 versicolor
## 55           6.5         2.8          4.6         1.5 versicolor
## 87           6.7         3.1          4.7         1.5 versicolor
## 53           6.9         3.1          4.9         1.5 versicolor
## 73           6.3         2.5          4.9         1.5 versicolor
## 120          6.0         2.2          5.0         1.5  virginica
## 134          6.3         2.8          5.1         1.5  virginica
## 86           6.0         3.4          4.5         1.6 versicolor
## 57           6.3         3.3          4.7         1.6 versicolor
## 84           6.0         2.7          5.1         1.6 versicolor
## 130          7.2         3.0          5.8         1.6  virginica
## 107          4.9         2.5          4.5         1.7  virginica
## 78           6.7         3.0          5.0         1.7 versicolor
## 71           5.9         3.2          4.8         1.8 versicolor
## 127          6.2         2.8          4.8         1.8  virginica
## 139          6.0         3.0          4.8         1.8  virginica
## 124          6.3         2.7          4.9         1.8  virginica
## 128          6.1         3.0          4.9         1.8  virginica
## 150          5.9         3.0          5.1         1.8  virginica
## 117          6.5         3.0          5.5         1.8  virginica
## 138          6.4         3.1          5.5         1.8  virginica
## 104          6.3         2.9          5.6         1.8  virginica
## 109          6.7         2.5          5.8         1.8  virginica
## 126          7.2         3.2          6.0         1.8  virginica
## 108          7.3         2.9          6.3         1.8  virginica
## 147          6.3         2.5          5.0         1.9  virginica
## 102          5.8         2.7          5.1         1.9  virginica
## 143          5.8         2.7          5.1         1.9  virginica
## 112          6.4         2.7          5.3         1.9  virginica
## 131          7.4         2.8          6.1         1.9  virginica
## 122          5.6         2.8          4.9         2.0  virginica
## 114          5.7         2.5          5.0         2.0  virginica
## 111          6.5         3.2          5.1         2.0  virginica
## 148          6.5         3.0          5.2         2.0  virginica
## 132          7.9         3.8          6.4         2.0  virginica
## 123          7.7         2.8          6.7         2.0  virginica
## 140          6.9         3.1          5.4         2.1  virginica
## 113          6.8         3.0          5.5         2.1  virginica
## 129          6.4         2.8          5.6         2.1  virginica
## 125          6.7         3.3          5.7         2.1  virginica
## 103          7.1         3.0          5.9         2.1  virginica
## 106          7.6         3.0          6.6         2.1  virginica
## 133          6.4         2.8          5.6         2.2  virginica
## 105          6.5         3.0          5.8         2.2  virginica
## 118          7.7         3.8          6.7         2.2  virginica
## 142          6.9         3.1          5.1         2.3  virginica
## 146          6.7         3.0          5.2         2.3  virginica
## 116          6.4         3.2          5.3         2.3  virginica
## 149          6.2         3.4          5.4         2.3  virginica
## 121          6.9         3.2          5.7         2.3  virginica
## 144          6.8         3.2          5.9         2.3  virginica
## 136          7.7         3.0          6.1         2.3  virginica
## 119          7.7         2.6          6.9         2.3  virginica
## 115          5.8         2.8          5.1         2.4  virginica
## 137          6.3         3.4          5.6         2.4  virginica
## 141          6.7         3.1          5.6         2.4  virginica
## 145          6.7         3.3          5.7         2.5  virginica
## 101          6.3         3.3          6.0         2.5  virginica
## 110          7.2         3.6          6.1         2.5  virginica</code></pre>
<p>sort/ordered 排序， 默认是升序</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Hi"</span>, <span class="st">"Med"</span>, <span class="st">"Hi"</span>, <span class="st">"Low"</span><span class="op">)</span>,
    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="st">"Med"</span>, <span class="st">"Hi"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>,
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"D"</span>, <span class="st">"A"</span>, <span class="st">"C"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">3</span>, <span class="fl">9</span>, <span class="fl">9</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    4 obs. of  4 variables:
##  $ b: Ord.factor w/ 3 levels "Low"&lt;"Med"&lt;"Hi": 3 2 3 1
##  $ x: chr  "A" "D" "A" "C"
##  $ y: num  8 3 9 9
##  $ z: num  1 1 1 2</code></pre>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">dd</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, <span class="va">dd</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     b x y z
## 4 Low C 9 2
## 2 Med D 3 1
## 1  Hi A 8 1
## 3  Hi A 9 1</code></pre>
<p>根据变量 z</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">dd</span><span class="op">$</span><span class="va">z</span>, <span class="va">dd</span><span class="op">$</span><span class="va">b</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     b x y z
## 2 Med D 3 1
## 1  Hi A 8 1
## 3  Hi A 9 1
## 4 Low C 9 2</code></pre>
</div>
<div id="dm-split" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> 数据拆分<a class="anchor" aria-label="anchor" href="#dm-split"><i class="fas fa-link"></i></a>
</h2>
<p>数据拆分通常是按找某一个分类变量分组，分完组就是计算，计算完就把结果按照原来的分组方式合并</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Notice that assignment form is not used since a variable is being added</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="va">airquality</span><span class="op">$</span><span class="va">Month</span>
<span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="va">g</span><span class="op">)</span> <span class="co"># 分组</span>
<span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">transform</span>, Oz.Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">)</span><span class="op">)</span> <span class="co"># 计算：按月对 Ozone 标准化</span>
<span class="va">aq2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">unsplit</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">g</span><span class="op">)</span> <span class="co"># 合并</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aq2</span><span class="op">)</span></code></pre></div>
<pre><code>##   Ozone Solar.R Wind Temp Month Day       Oz.Z
## 1    41     190  7.4   67     5   1  0.7822293
## 2    36     118  8.0   72     5   2  0.5572518
## 3    12     149 12.6   74     5   3 -0.5226399
## 4    18     313 11.5   62     5   4 -0.2526670
## 5    NA      NA 14.3   56     5   5         NA
## 6    28      NA 14.9   66     5   6  0.1972879</code></pre>
<p>tapply 自带分组的功能，按月份 Month 对 Ozone 中心标准化，其返回一个列表</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Ozone</span>, <span class="va">Month</span>, <span class="va">scale</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## $`5`
##              [,1]
##  [1,]  0.78222929
##  [2,]  0.55725184
##  [3,] -0.52263993
##  [4,] -0.25266698
##  [5,]          NA
##  [6,]  0.19728792
##  [7,] -0.02768953
##  [8,] -0.20767149
##  [9,] -0.70262189
## [10,]          NA
## [11,] -0.74761738
## [12,] -0.34265796
## [13,] -0.56763542
## [14,] -0.43264895
## [15,] -0.25266698
## [16,] -0.43264895
## [17,]  0.46726086
## [18,] -0.79261287
## [19,]  0.28727890
## [20,] -0.56763542
## [21,] -1.01759032
## [22,] -0.56763542
## [23,] -0.88260385
## [24,]  0.37726988
## [25,]          NA
## [26,]          NA
## [27,]          NA
## [28,] -0.02768953
## [29,]  0.96221125
## [30,]  4.11189557
## [31,]  0.60224733
## attr(,"scaled:center")
## [1] 23.61538
## attr(,"scaled:scale")
## [1] 22.22445
## 
## $`6`
##              [,1]
##  [1,]          NA
##  [2,]          NA
##  [3,]          NA
##  [4,]          NA
##  [5,]          NA
##  [6,]          NA
##  [7,] -0.02440942
##  [8,]          NA
##  [9,]  2.28228109
## [10,]  0.52480260
## [11,]          NA
## [12,]          NA
## [13,] -0.35393664
## [14,]          NA
## [15,]          NA
## [16,] -0.46377904
## [17,]  0.41496020
## [18,] -0.51870025
## [19,] -0.95806987
## [20,] -0.90314867
## [21,]          NA
## [22,]          NA
## [23,]          NA
## [24,]          NA
## [25,]          NA
## [26,]          NA
## [27,]          NA
## [28,]          NA
## [29,]          NA
## [30,]          NA
## attr(,"scaled:center")
## [1] 29.44444
## attr(,"scaled:scale")
## [1] 18.2079
## 
## $`7`
##               [,1]
##  [1,]  2.398691600
##  [2,] -0.319744496
##  [3,] -0.857109771
##  [4,]           NA
##  [5,]  0.154401335
##  [6,] -0.604231995
##  [7,]  0.565327721
##  [8,]  1.197522162
##  [9,]  1.197522162
## [10,]  0.818205498
## [11,]           NA
## [12,] -1.552523656
## [13,] -1.015158381
## [14,]           NA
## [15,] -1.647352822
## [16,] -0.351354218
## [17,] -0.762280605
## [18,]  0.059572168
## [19,]  0.628547165
## [20,]  0.122791613
## [21,] -1.362865324
## [22,]           NA
## [23,]           NA
## [24,]  0.660156887
## [25,]  1.545229105
## [26,] -1.236426436
## [27,] -0.224915330
## [28,]  0.723376332
## [29,] -0.288134774
## [30,]  0.154401335
## [31,] -0.003647276
## attr(,"scaled:center")
## [1] 59.11538
## attr(,"scaled:scale")
## [1] 31.63584
## 
## $`8`
##              [,1]
##  [1,] -0.52824846
##  [2,] -1.28427379
##  [3,] -1.10786788
##  [4,]  0.45458446
##  [5,] -0.62905184
##  [6,]  0.15217433
##  [7,]  1.56342160
##  [8,]  0.73179374
##  [9,]  1.26101147
## [10,]          NA
## [11,]          NA
## [12,] -0.40224424
## [13,] -0.80545775
## [14,]  0.12697348
## [15,]          NA
## [16,] -0.95666281
## [17,] -0.02423158
## [18,] -0.93146197
## [19,] -0.72985522
## [20,] -0.40224424
## [21,] -0.98186366
## [22,] -1.28427379
## [23,]          NA
## [24,] -0.37704340
## [25,]  2.72266043
## [26,]  0.32858024
## [27,]          NA
## [28,]  0.40418277
## [29,]  1.46261822
## [30,]  0.60578952
## [31,]  0.63099037
## attr(,"scaled:center")
## [1] 59.96154
## attr(,"scaled:scale")
## [1] 39.68121
## 
## $`9`
##              [,1]
##  [1,]  2.67385466
##  [2,]  1.92826057
##  [3,]  1.72115110
##  [4,]  2.46674519
##  [5,]  0.64418186
##  [6,]  0.02285346
##  [7,] -0.47420927
##  [8,] -0.34994359
##  [9,] -0.43278737
## [10,] -0.30852169
## [11,]  0.51991618
## [12,] -0.43278737
## [13,] -0.14283412
## [14,] -0.92985010
## [15,] -0.76416252
## [16,]  0.60275997
## [17,] -0.55705305
## [18,] -0.76416252
## [19,] -0.30852169
## [20,] -0.63989684
## [21,] -0.76416252
## [22,] -0.34994359
## [23,]  0.18854103
## [24,] -1.01269388
## [25,] -0.72274063
## [26,] -0.05999033
## [27,]          NA
## [28,] -0.72274063
## [29,] -0.55705305
## [30,] -0.47420927
## attr(,"scaled:center")
## [1] 31.44828
## attr(,"scaled:scale")
## [1] 24.14182</code></pre>
<p>上面的过程等价于</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="va">airquality</span><span class="op">$</span><span class="va">Month</span><span class="op">)</span>, <span class="va">transform</span>, Oz.Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##       Ozone Solar.R Wind Temp Month Day         Oz.Z
## 5.1      41     190  7.4   67     5   1  0.782229293
## 5.2      36     118  8.0   72     5   2  0.557251841
## 5.3      12     149 12.6   74     5   3 -0.522639926
## 5.4      18     313 11.5   62     5   4 -0.252666984
## 5.5      NA      NA 14.3   56     5   5           NA
## 5.6      28      NA 14.9   66     5   6  0.197287919
## 5.7      23     299  8.6   65     5   7 -0.027689532
## 5.8      19      99 13.8   59     5   8 -0.207671494
## 5.9       8      19 20.1   61     5   9 -0.702621887
## 5.10     NA     194  8.6   69     5  10           NA
## 5.11      7      NA  6.9   74     5  11 -0.747617377
## 5.12     16     256  9.7   69     5  12 -0.342657965
## 5.13     11     290  9.2   66     5  13 -0.567635416
## 5.14     14     274 10.9   68     5  14 -0.432648945
## 5.15     18      65 13.2   58     5  15 -0.252666984
## 5.16     14     334 11.5   64     5  16 -0.432648945
## 5.17     34     307 12.0   66     5  17  0.467260861
## 5.18      6      78 18.4   57     5  18 -0.792612867
## 5.19     30     322 11.5   68     5  19  0.287278900
## 5.20     11      44  9.7   62     5  20 -0.567635416
## 5.21      1       8  9.7   59     5  21 -1.017590319
## 5.22     11     320 16.6   73     5  22 -0.567635416
## 5.23      4      25  9.7   61     5  23 -0.882603848
## 5.24     32      92 12.0   61     5  24  0.377269880
## 5.25     NA      66 16.6   57     5  25           NA
## 5.26     NA     266 14.9   58     5  26           NA
## 5.27     NA      NA  8.0   57     5  27           NA
## 5.28     23      13 12.0   67     5  28 -0.027689532
## 5.29     45     252 14.9   81     5  29  0.962211254
## 5.30    115     223  5.7   79     5  30  4.111895575
## 5.31     37     279  7.4   76     5  31  0.602247332
## 6.32     NA     286  8.6   78     6   1           NA
## 6.33     NA     287  9.7   74     6   2           NA
## 6.34     NA     242 16.1   67     6   3           NA
## 6.35     NA     186  9.2   84     6   4           NA
## 6.36     NA     220  8.6   85     6   5           NA
## 6.37     NA     264 14.3   79     6   6           NA
## 6.38     29     127  9.7   82     6   7 -0.024409423
## 6.39     NA     273  6.9   87     6   8           NA
## 6.40     71     291 13.8   90     6   9  2.282281088
## 6.41     39     323 11.5   87     6  10  0.524802603
## 6.42     NA     259 10.9   93     6  11           NA
## 6.43     NA     250  9.2   92     6  12           NA
## 6.44     23     148  8.0   82     6  13 -0.353936639
## 6.45     NA     332 13.8   80     6  14           NA
## 6.46     NA     322 11.5   79     6  15           NA
## 6.47     21     191 14.9   77     6  16 -0.463779045
## 6.48     37     284 20.7   72     6  17  0.414960198
## 6.49     20      37  9.2   65     6  18 -0.518700247
## 6.50     12     120 11.5   73     6  19 -0.958069868
## 6.51     13     137 10.3   76     6  20 -0.903148666
## 6.52     NA     150  6.3   77     6  21           NA
## 6.53     NA      59  1.7   76     6  22           NA
## 6.54     NA      91  4.6   76     6  23           NA
## 6.55     NA     250  6.3   76     6  24           NA
## 6.56     NA     135  8.0   75     6  25           NA
## 6.57     NA     127  8.0   78     6  26           NA
## 6.58     NA      47 10.3   73     6  27           NA
## 6.59     NA      98 11.5   80     6  28           NA
## 6.60     NA      31 14.9   77     6  29           NA
## 6.61     NA     138  8.0   83     6  30           NA
## 7.62    135     269  4.1   84     7   1  2.398691600
## 7.63     49     248  9.2   85     7   2 -0.319744496
## 7.64     32     236  9.2   81     7   3 -0.857109771
## 7.65     NA     101 10.9   84     7   4           NA
## 7.66     64     175  4.6   83     7   5  0.154401335
## 7.67     40     314 10.9   83     7   6 -0.604231995
## 7.68     77     276  5.1   88     7   7  0.565327721
## 7.69     97     267  6.3   92     7   8  1.197522162
## 7.70     97     272  5.7   92     7   9  1.197522162
## 7.71     85     175  7.4   89     7  10  0.818205498
## 7.72     NA     139  8.6   82     7  11           NA
## 7.73     10     264 14.3   73     7  12 -1.552523656
## 7.74     27     175 14.9   81     7  13 -1.015158381
## 7.75     NA     291 14.9   91     7  14           NA
## 7.76      7      48 14.3   80     7  15 -1.647352822
## 7.77     48     260  6.9   81     7  16 -0.351354218
## 7.78     35     274 10.3   82     7  17 -0.762280605
## 7.79     61     285  6.3   84     7  18  0.059572168
## 7.80     79     187  5.1   87     7  19  0.628547165
## 7.81     63     220 11.5   85     7  20  0.122791613
## 7.82     16       7  6.9   74     7  21 -1.362865324
## 7.83     NA     258  9.7   81     7  22           NA
## 7.84     NA     295 11.5   82     7  23           NA
## 7.85     80     294  8.6   86     7  24  0.660156887
## 7.86    108     223  8.0   85     7  25  1.545229105
## 7.87     20      81  8.6   82     7  26 -1.236426436
## 7.88     52      82 12.0   86     7  27 -0.224915330
## 7.89     82     213  7.4   88     7  28  0.723376332
## 7.90     50     275  7.4   86     7  29 -0.288134774
## 7.91     64     253  7.4   83     7  30  0.154401335
## 7.92     59     254  9.2   81     7  31 -0.003647276
## 8.93     39      83  6.9   81     8   1 -0.528248464
## 8.94      9      24 13.8   81     8   2 -1.284273789
## 8.95     16      77  7.4   82     8   3 -1.107867880
## 8.96     78      NA  6.9   86     8   4  0.454584458
## 8.97     35      NA  7.4   85     8   5 -0.629051841
## 8.98     66      NA  4.6   87     8   6  0.152174328
## 8.99    122     255  4.0   89     8   7  1.563421601
## 8.100    89     229 10.3   90     8   8  0.731793744
## 8.101   110     207  8.0   90     8   9  1.261011471
## 8.102    NA     222  8.6   92     8  10           NA
## 8.103    NA     137 11.5   86     8  11           NA
## 8.104    44     192 11.5   86     8  12 -0.402244243
## 8.105    28     273 11.5   82     8  13 -0.805457750
## 8.106    65     157  9.7   80     8  14  0.126973484
## 8.107    NA      64 11.5   79     8  15           NA
## 8.108    22      71 10.3   77     8  16 -0.956662815
## 8.109    59      51  6.3   79     8  17 -0.024231581
## 8.110    23     115  7.4   76     8  18 -0.931461970
## 8.111    31     244 10.9   78     8  19 -0.729855217
## 8.112    44     190 10.3   78     8  20 -0.402244243
## 8.113    21     259 15.5   77     8  21 -0.981863659
## 8.114     9      36 14.3   72     8  22 -1.284273789
## 8.115    NA     255 12.6   75     8  23           NA
## 8.116    45     212  9.7   79     8  24 -0.377043399
## 8.117   168     238  3.4   81     8  25  2.722660432
## 8.118    73     215  8.0   86     8  26  0.328580237
## 8.119    NA     153  5.7   88     8  27           NA
## 8.120    76     203  9.7   97     8  28  0.404182770
## 8.121   118     225  2.3   94     8  29  1.462618224
## 8.122    84     237  6.3   96     8  30  0.605789523
## 8.123    85     188  6.3   94     8  31  0.630990367
## 9.124    96     167  6.9   91     9   1  2.673854658
## 9.125    78     197  5.1   92     9   2  1.928260571
## 9.126    73     183  2.8   93     9   3  1.721151102
## 9.127    91     189  4.6   93     9   4  2.466745189
## 9.128    47      95  7.4   87     9   5  0.644181865
## 9.129    32      92 15.5   84     9   6  0.022853459
## 9.130    20     252 10.9   80     9   7 -0.474209266
## 9.131    23     220 10.3   78     9   8 -0.349943585
## 9.132    21     230 10.9   75     9   9 -0.432787373
## 9.133    24     259  9.7   73     9  10 -0.308521691
## 9.134    44     236 14.9   81     9  11  0.519916184
## 9.135    21     259 15.5   76     9  12 -0.432787373
## 9.136    28     238  6.3   77     9  13 -0.142834116
## 9.137     9      24 10.9   71     9  14 -0.929850097
## 9.138    13     112 11.5   71     9  15 -0.764162523
## 9.139    46     237  6.9   78     9  16  0.602759971
## 9.140    18     224 13.8   67     9  17 -0.557053054
## 9.141    13      27 10.3   76     9  18 -0.764162523
## 9.142    24     238 10.3   68     9  19 -0.308521691
## 9.143    16     201  8.0   82     9  20 -0.639896841
## 9.144    13     238 12.6   64     9  21 -0.764162523
## 9.145    23      14  9.2   71     9  22 -0.349943585
## 9.146    36     139 10.3   81     9  23  0.188541034
## 9.147     7      49 10.3   69     9  24 -1.012693885
## 9.148    14      20 16.6   63     9  25 -0.722740629
## 9.149    30     193  6.9   70     9  26 -0.059990329
## 9.150    NA     145 13.2   77     9  27           NA
## 9.151    14     191 14.3   75     9  28 -0.722740629
## 9.152    18     131  8.0   76     9  29 -0.557053054
## 9.153    20     223 11.5   68     9  30 -0.474209266</code></pre>
<p>由于上面对 Ozone 正态标准化，所以标准化后的 <code>Oz.z</code> 再按月分组计算方差自然每个月都是 1，而均值都是 0。</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">aq2</span>, <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Oz.Z</span>, <span class="va">Month</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 5 6 7 8 9 
## 1 1 1 1 1</code></pre>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">aq2</span>, <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Oz.Z</span>, <span class="va">Month</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##             5             6             7             8             9 
## -4.240273e-17  1.052760e-16  5.841432e-17  5.898060e-17  2.571709e-17</code></pre>
<blockquote>
<p>循着这个思路，我们可以用 tapply 实现分组计算，上面函数 <code>sd</code> 和 <code>mean</code> 完全可以用自定义的更加复杂的函数替代</p>
</blockquote>
<p><code>cut</code> 函数可以将连续型变量划分为分类变量</p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2019</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">Z</span>, breaks <span class="op">=</span> <span class="op">-</span><span class="fl">6</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] (0,1]   (-1,0]  (-2,-1] (0,1]   (-2,-1] (0,1]   (-1,0]  (0,1]   (-2,-1]
## [10] (-1,0] 
## 12 Levels: (-6,-5] (-5,-4] (-4,-3] (-3,-2] (-2,-1] (-1,0] (0,1] (1,2] ... (5,6]</code></pre>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># labels = FALSE 返回每个数所落的区间位置</span>
<span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">Z</span>, breaks <span class="op">=</span> <span class="op">-</span><span class="fl">6</span><span class="op">:</span><span class="fl">6</span>, labels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 7 6 5 7 5 7 6 7 5 6</code></pre>
<p>我们还可以指定参数 <code>dig.lab</code> 设置分组的精度，<code>ordered</code> 将分组变量看作是有序的，<code>breaks</code> 传递单个数时，表示分组数，而不是断点</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">Z</span>, breaks <span class="op">=</span> <span class="fl">3</span>, dig.lab <span class="op">=</span> <span class="fl">4</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] (0.06396,0.9186]  (-0.7881,0.06396] (-1.643,-0.7881]  (0.06396,0.9186] 
##  [5] (-1.643,-0.7881]  (0.06396,0.9186]  (-0.7881,0.06396] (0.06396,0.9186] 
##  [9] (-1.643,-0.7881]  (-0.7881,0.06396]
## Levels: (-1.643,-0.7881] &lt; (-0.7881,0.06396] &lt; (0.06396,0.9186]</code></pre>
<p>此时，统计每组的频数，如图 <a href="#fig:cut"><strong>??</strong></a></p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 条形图</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">Z</span>, breaks <span class="op">=</span> <span class="op">-</span><span class="fl">6</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:cut-1"></span>
<img src="data-manipulation_files/figure-html/cut-1.png" alt="连续型变量分组统计" width="35%"><p class="caption">
图 5.2: 连续型变量分组统计
</p>
</div>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 直方图</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">Z</span>, breaks <span class="op">=</span> <span class="op">-</span><span class="fl">6</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:cut-2"></span>
<img src="data-manipulation_files/figure-html/cut-2.png" alt="连续型变量分组统计" width="35%"><p class="caption">
图 5.3: 连续型变量分组统计
</p>
</div>
<p>在指定分组数的情况下，我们还想获取分组的断点</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">Z</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">labs</span></code></pre></div>
<pre><code>## [1] "(-1.64,-0.788]" "(-0.788,0.064]" "(0.064,0.919]"</code></pre>
<p>用正则表达式抽取断点</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>
  lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"\\((.+),.*"</span>, <span class="st">"\\1"</span>, <span class="va">labs</span><span class="op">)</span><span class="op">)</span>,
  upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"[^,]*,([^]]*)\\]"</span>, <span class="st">"\\1"</span>, <span class="va">labs</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##       lower  upper
## [1,] -1.640 -0.788
## [2,] -0.788  0.064
## [3,]  0.064  0.919</code></pre>
<p>更多相关函数可以参考 <code>findInterval</code> 和 <code>embed</code></p>
<p>tabulate 和 table 有所不同，它表示排列</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/combn.html">combn</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">4</span>, <span class="va">tabulate</span>, nbins <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
##  [1,]    1    1    1    1    0    0    0    0
##  [2,]    1    1    1    0    1    0    0    0
##  [3,]    1    1    1    0    0    1    0    0
##  [4,]    1    1    1    0    0    0    1    0
##  [5,]    1    1    1    0    0    0    0    1
##  [6,]    1    1    0    1    1    0    0    0
##  [7,]    1    1    0    1    0    1    0    0
##  [8,]    1    1    0    1    0    0    1    0
##  [9,]    1    1    0    1    0    0    0    1
## [10,]    1    1    0    0    1    1    0    0
## [11,]    1    1    0    0    1    0    1    0
## [12,]    1    1    0    0    1    0    0    1
## [13,]    1    1    0    0    0    1    1    0
## [14,]    1    1    0    0    0    1    0    1
## [15,]    1    1    0    0    0    0    1    1
## [16,]    1    0    1    1    1    0    0    0
## [17,]    1    0    1    1    0    1    0    0
## [18,]    1    0    1    1    0    0    1    0
## [19,]    1    0    1    1    0    0    0    1
## [20,]    1    0    1    0    1    1    0    0
## [21,]    1    0    1    0    1    0    1    0
## [22,]    1    0    1    0    1    0    0    1
## [23,]    1    0    1    0    0    1    1    0
## [24,]    1    0    1    0    0    1    0    1
## [25,]    1    0    1    0    0    0    1    1
## [26,]    1    0    0    1    1    1    0    0
## [27,]    1    0    0    1    1    0    1    0
## [28,]    1    0    0    1    1    0    0    1
## [29,]    1    0    0    1    0    1    1    0
## [30,]    1    0    0    1    0    1    0    1
## [31,]    1    0    0    1    0    0    1    1
## [32,]    1    0    0    0    1    1    1    0
## [33,]    1    0    0    0    1    1    0    1
## [34,]    1    0    0    0    1    0    1    1
## [35,]    1    0    0    0    0    1    1    1
## [36,]    0    1    1    1    1    0    0    0
## [37,]    0    1    1    1    0    1    0    0
## [38,]    0    1    1    1    0    0    1    0
## [39,]    0    1    1    1    0    0    0    1
## [40,]    0    1    1    0    1    1    0    0
## [41,]    0    1    1    0    1    0    1    0
## [42,]    0    1    1    0    1    0    0    1
## [43,]    0    1    1    0    0    1    1    0
## [44,]    0    1    1    0    0    1    0    1
## [45,]    0    1    1    0    0    0    1    1
## [46,]    0    1    0    1    1    1    0    0
## [47,]    0    1    0    1    1    0    1    0
## [48,]    0    1    0    1    1    0    0    1
## [49,]    0    1    0    1    0    1    1    0
## [50,]    0    1    0    1    0    1    0    1
## [51,]    0    1    0    1    0    0    1    1
## [52,]    0    1    0    0    1    1    1    0
## [53,]    0    1    0    0    1    1    0    1
## [54,]    0    1    0    0    1    0    1    1
## [55,]    0    1    0    0    0    1    1    1
## [56,]    0    0    1    1    1    1    0    0
## [57,]    0    0    1    1    1    0    1    0
## [58,]    0    0    1    1    1    0    0    1
## [59,]    0    0    1    1    0    1    1    0
## [60,]    0    0    1    1    0    1    0    1
## [61,]    0    0    1    1    0    0    1    1
## [62,]    0    0    1    0    1    1    1    0
## [63,]    0    0    1    0    1    1    0    1
## [64,]    0    0    1    0    1    0    1    1
## [65,]    0    0    1    0    0    1    1    1
## [66,]    0    0    0    1    1    1    1    0
## [67,]    0    0    0    1    1    1    0    1
## [68,]    0    0    0    1    1    0    1    1
## [69,]    0    0    0    1    0    1    1    1
## [70,]    0    0    0    0    1    1    1    1</code></pre>
</div>
<div id="dm-merge" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> 数据合并<a class="anchor" aria-label="anchor" href="#dm-merge"><i class="fas fa-link"></i></a>
</h2>
<p>merge 合并两个数据框</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">authors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  <span class="co">## I(*) : use character columns of names to get sensible sort order</span>
  surname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tukey"</span>, <span class="st">"Venables"</span>, <span class="st">"Tierney"</span>, <span class="st">"Ripley"</span>, <span class="st">"McNeil"</span><span class="op">)</span><span class="op">)</span>,
  nationality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"Australia"</span>, <span class="st">"US"</span>, <span class="st">"UK"</span>, <span class="st">"Australia"</span><span class="op">)</span>,
  deceased <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"yes"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"no"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">authorN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">authors</span>, <span class="op">{</span>
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="va">surname</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">surname</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">books</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"Tukey"</span>, <span class="st">"Venables"</span>, <span class="st">"Tierney"</span>,
    <span class="st">"Ripley"</span>, <span class="st">"Ripley"</span>, <span class="st">"McNeil"</span>, <span class="st">"R Core"</span>
  <span class="op">)</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"Exploratory Data Analysis"</span>,
    <span class="st">"Modern Applied Statistics ..."</span>,
    <span class="st">"LISP-STAT"</span>,
    <span class="st">"Spatial Statistics"</span>, <span class="st">"Stochastic Simulation"</span>,
    <span class="st">"Interactive Data Analysis"</span>,
    <span class="st">"An Introduction to R"</span>
  <span class="op">)</span>,
  other.author <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="cn">NA</span>, <span class="st">"Ripley"</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,
    <span class="st">"Venables &amp; Smith"</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">authors</span></code></pre></div>
<pre><code>##    surname nationality deceased
## 1    Tukey          US      yes
## 2 Venables   Australia       no
## 3  Tierney          US       no
## 4   Ripley          UK       no
## 5   McNeil   Australia       no</code></pre>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">authorN</span></code></pre></div>
<pre><code>##   nationality deceased     name
## 1          US      yes    Tukey
## 2   Australia       no Venables
## 3          US       no  Tierney
## 4          UK       no   Ripley
## 5   Australia       no   McNeil</code></pre>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">books</span></code></pre></div>
<pre><code>##       name                         title     other.author
## 1    Tukey     Exploratory Data Analysis             &lt;NA&gt;
## 2 Venables Modern Applied Statistics ...           Ripley
## 3  Tierney                     LISP-STAT             &lt;NA&gt;
## 4   Ripley            Spatial Statistics             &lt;NA&gt;
## 5   Ripley         Stochastic Simulation             &lt;NA&gt;
## 6   McNeil     Interactive Data Analysis             &lt;NA&gt;
## 7   R Core          An Introduction to R Venables &amp; Smith</code></pre>
<p>默认找到同名的列，然后是同名的行合并，多余的没有匹配到的就丢掉</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">authorN</span>, <span class="va">books</span><span class="op">)</span></code></pre></div>
<pre><code>##       name nationality deceased                         title other.author
## 1   McNeil   Australia       no     Interactive Data Analysis         &lt;NA&gt;
## 2   Ripley          UK       no            Spatial Statistics         &lt;NA&gt;
## 3   Ripley          UK       no         Stochastic Simulation         &lt;NA&gt;
## 4  Tierney          US       no                     LISP-STAT         &lt;NA&gt;
## 5    Tukey          US      yes     Exploratory Data Analysis         &lt;NA&gt;
## 6 Venables   Australia       no Modern Applied Statistics ...       Ripley</code></pre>
<p>还可以指定合并的列，先按照 surname 合并，留下 surname</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">authors</span>, <span class="va">books</span>, by.x <span class="op">=</span> <span class="st">"surname"</span>, by.y <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span></code></pre></div>
<pre><code>##    surname nationality deceased                         title other.author
## 1   McNeil   Australia       no     Interactive Data Analysis         &lt;NA&gt;
## 2   Ripley          UK       no            Spatial Statistics         &lt;NA&gt;
## 3   Ripley          UK       no         Stochastic Simulation         &lt;NA&gt;
## 4  Tierney          US       no                     LISP-STAT         &lt;NA&gt;
## 5    Tukey          US      yes     Exploratory Data Analysis         &lt;NA&gt;
## 6 Venables   Australia       no Modern Applied Statistics ...       Ripley</code></pre>
<p>留下的是 name</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">books</span>, <span class="va">authors</span>, by.x <span class="op">=</span> <span class="st">"name"</span>, by.y <span class="op">=</span> <span class="st">"surname"</span><span class="op">)</span></code></pre></div>
<pre><code>##       name                         title other.author nationality deceased
## 1   McNeil     Interactive Data Analysis         &lt;NA&gt;   Australia       no
## 2   Ripley            Spatial Statistics         &lt;NA&gt;          UK       no
## 3   Ripley         Stochastic Simulation         &lt;NA&gt;          UK       no
## 4  Tierney                     LISP-STAT         &lt;NA&gt;          US       no
## 5    Tukey     Exploratory Data Analysis         &lt;NA&gt;          US      yes
## 6 Venables Modern Applied Statistics ...       Ripley   Australia       no</code></pre>
<p>为了比较清楚地观察几种合并的区别，这里提供对应的动画展示 <a href="https://github.com/gadenbuie/tidyexplain" class="uri">https://github.com/gadenbuie/tidyexplain</a></p>
<p>(inner, outer, left, right, cross) join 共5种合并方式详情请看 <a href="https://stackoverflow.com/questions/1299871" class="uri">https://stackoverflow.com/questions/1299871</a></p>
<p>cbind 和 rbind 分别是按列和行合并数据框</p>
</div>
<div id="dm-duplicated" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> 数据去重<a class="anchor" aria-label="anchor" href="#dm-duplicated"><i class="fas fa-link"></i></a>
</h2>
<p>单个数值型向量去重，此时和 unique 函数作用一样</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">20</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">7</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  3  4  5  6  7  0  1  2
## [26]  3  4  5  6  7  8</code></pre>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## extract unique elements</span>
<span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  6  7  0  8</code></pre>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1]  9 10 11 12 13 14 15 16 17 18 19 20  1  2  3  4  5  6  7  0  8</code></pre>
<p>数据框类型数据中，去除重复的行，这个重复可以是多个变量对应的向量</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
<span class="op">)</span>
<span class="va">df</span></code></pre></div>
<pre><code>##    x y  z
## 1  0 1  1
## 2  0 1  2
## 3  0 1  3
## 4  1 0  4
## 5  0 1  5
## 6  1 0  6
## 7  1 1  7
## 8  1 0  8
## 9  0 0  9
## 10 0 0 10</code></pre>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##   x y z
## 1 0 1 1
## 4 1 0 4
## 7 1 1 7
## 9 0 0 9</code></pre>
</div>
<div id="dm-missing" class="section level2" number="5.9">
<h2>
<span class="header-section-number">5.9</span> 数据缺失<a class="anchor" aria-label="anchor" href="#dm-missing"><i class="fas fa-link"></i></a>
</h2>
<p>缺失数据操作</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"airquality"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></code></pre></div>
<pre><code>##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 5    NA      NA 14.3   56     5   5
## 6    28      NA 14.9   66     5   6</code></pre>
<p>对缺失值的处理默认是 <code>na.action = na.omit</code></p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Ozone 最高的那天</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">airquality</span>, <span class="va">Ozone</span> <span class="op">~</span> <span class="va">Month</span>, <span class="va">max</span><span class="op">)</span></code></pre></div>
<pre><code>##   Month Ozone
## 1     5   115
## 2     6    71
## 3     7   135
## 4     8   168
## 5     9    96</code></pre>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 每月 Ozone, Solar.R, Wind, Temp 平均值</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">airquality</span>, <span class="va">Ozone</span> <span class="op">~</span> <span class="va">Month</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##   Month    Ozone
## 1     5 23.61538
## 2     6 29.44444
## 3     7 59.11538
## 4     8 59.96154
## 5     9 31.44828</code></pre>
<p>缺失值处理</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">DataExplorer</span><span class="op">)</span>
<span class="fu">plot_missing</span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></code></pre></div>
<p>查看包含缺失的记录，不完整的记录</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airquality</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     Ozone Solar.R Wind Temp Month Day
## 5      NA      NA 14.3   56     5   5
## 6      28      NA 14.9   66     5   6
## 10     NA     194  8.6   69     5  10
## 11      7      NA  6.9   74     5  11
## 25     NA      66 16.6   57     5  25
## 26     NA     266 14.9   58     5  26
## 27     NA      NA  8.0   57     5  27
## 32     NA     286  8.6   78     6   1
## 33     NA     287  9.7   74     6   2
## 34     NA     242 16.1   67     6   3
## 35     NA     186  9.2   84     6   4
## 36     NA     220  8.6   85     6   5
## 37     NA     264 14.3   79     6   6
## 39     NA     273  6.9   87     6   8
## 42     NA     259 10.9   93     6  11
## 43     NA     250  9.2   92     6  12
## 45     NA     332 13.8   80     6  14
## 46     NA     322 11.5   79     6  15
## 52     NA     150  6.3   77     6  21
## 53     NA      59  1.7   76     6  22
## 54     NA      91  4.6   76     6  23
## 55     NA     250  6.3   76     6  24
## 56     NA     135  8.0   75     6  25
## 57     NA     127  8.0   78     6  26
## 58     NA      47 10.3   73     6  27
## 59     NA      98 11.5   80     6  28
## 60     NA      31 14.9   77     6  29
## 61     NA     138  8.0   83     6  30
## 65     NA     101 10.9   84     7   4
## 72     NA     139  8.6   82     7  11
## 75     NA     291 14.9   91     7  14
## 83     NA     258  9.7   81     7  22
## 84     NA     295 11.5   82     7  23
## 96     78      NA  6.9   86     8   4
## 97     35      NA  7.4   85     8   5
## 98     66      NA  4.6   87     8   6
## 102    NA     222  8.6   92     8  10
## 103    NA     137 11.5   86     8  11
## 107    NA      64 11.5   79     8  15
## 115    NA     255 12.6   75     8  23
## 119    NA     153  5.7   88     8  27
## 150    NA     145 13.2   77     9  27</code></pre>
<p>Ozone 和 Solar.R 同时包含缺失值的行</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">$</span><span class="va">Solar.R</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##    Ozone Solar.R Wind Temp Month Day
## 5     NA      NA 14.3   56     5   5
## 27    NA      NA  8.0   57     5  27</code></pre>
</div>
<div id="dm-aggregate" class="section level2" number="5.10">
<h2>
<span class="header-section-number">5.10</span> 数据聚合<a class="anchor" aria-label="anchor" href="#dm-aggregate"><i class="fas fa-link"></i></a>
</h2>
<p>分组求和 <a href="https://stackoverflow.com/questions/1660124" class="uri">https://stackoverflow.com/questions/1660124</a></p>
<p>主要是分组统计</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/apropos.html">apropos</a></span><span class="op">(</span><span class="st">"apply"</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "apply"      "dendrapply" "eapply"     "kernapply"  "lapply"    
##  [6] "mapply"     "rapply"     "sapply"     "tapply"     "vapply"</code></pre>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组求和 colSums colMeans max</span>
<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] setosa     versicolor virginica 
## Levels: setosa versicolor virginica</code></pre>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分类求和</span>
<span class="co"># colSums(iris[iris$Species == "setosa", -5])</span>
<span class="co"># colSums(iris[iris$Species == "virginica", -5])</span>
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"versicolor"</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##        296.8        138.5        213.0         66.3</code></pre>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># apply(iris[iris$Species == "setosa", -5], 2, sum)</span>
<span class="co"># apply(iris[iris$Species == "setosa", -5], 2, mean)</span>
<span class="co"># apply(iris[iris$Species == "setosa", -5], 2, min)</span>
<span class="co"># apply(iris[iris$Species == "setosa", -5], 2, max)</span>
<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">quantile</span><span class="op">)</span></code></pre></div>
<pre><code>##      Sepal.Length Sepal.Width Petal.Length Petal.Width
## 0%            4.3       2.300        1.000         0.1
## 25%           4.8       3.200        1.400         0.2
## 50%           5.0       3.400        1.500         0.2
## 75%           5.2       3.675        1.575         0.3
## 100%          5.8       4.400        1.900         0.6</code></pre>
<p>aggregate: Compute Summary Statistics of Data Subsets</p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 按分类变量 Species 分组求和</span>
<span class="co"># aggregate(subset(iris, select = -Species), by = list(iris[, "Species"]), FUN = sum)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>##      Group.1 Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        250.3       171.4         73.1        12.3
## 2 versicolor        296.8       138.5        213.0        66.3
## 3  virginica        329.4       148.7        277.6       101.3</code></pre>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 先确定位置，假设有很多分类变量</span>
<span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="st">"Species"</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span>
<span class="co"># 分组统计</span>
<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="va">ind</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="va">ind</span><span class="op">]</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>##      Group.1 Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        250.3       171.4         73.1        12.3
## 2 versicolor        296.8       138.5        213.0        66.3
## 3  virginica        329.4       148.7        277.6       101.3</code></pre>
<p>按照 Species 划分的类别，分组计算，使用公式表示形式，右边一定是分类变量，否则会报错误或者警告，输出奇怪的结果，请读者尝试运行<code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate(Species ~ Sepal.Length, data = iris, mean)</a></code>。公式法表示分组计算，<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> 左手边可以做加 <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> 减 <code><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></code> 乘 <code><a href="https://rdrr.io/r/base/Arithmetic.html">*</a></code> 除 <code><a href="https://rdrr.io/r/base/Arithmetic.html">/</a></code> 取余 <code><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></code> 等数学运算。下面以数据集 iris 为例，只对 Sepal.Length 按 Species 分组计算</p>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Species</span>, data <span class="op">=</span> <span class="va">iris</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length
## 1     setosa        5.006
## 2 versicolor        5.936
## 3  virginica        6.588</code></pre>
<p>与上述分组统计结果一样的命令，在大数据集上， 与 aggregate 相比，tapply 要快很多，by 是 tapply 的包裹，处理速度差不多。读者可以构造伪随机数据集验证。</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># tapply(iris$Sepal.Length, list(iris$Species), mean)</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="va">Species</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     setosa versicolor  virginica 
##      5.006      5.936      6.588</code></pre>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>## iris$Species: setosa
## [1] 5.006
## ------------------------------------------------------------ 
## iris$Species: versicolor
## [1] 5.936
## ------------------------------------------------------------ 
## iris$Species: virginica
## [1] 6.588</code></pre>
<p>对所有变量按 Species 分组计算</p>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">Species</span>, data <span class="op">=</span> <span class="va">iris</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa        5.006       3.428        1.462       0.246
## 2 versicolor        5.936       2.770        4.260       1.326
## 3  virginica        6.588       2.974        5.552       2.026</code></pre>
<p>对变量 Sepal.Length 和 Sepal.Width 求和后，按 Species 分组计算</p>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Sepal.Width</span> <span class="op">~</span> <span class="va">Species</span>, data <span class="op">=</span> <span class="va">iris</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length + Sepal.Width
## 1     setosa                      8.434
## 2 versicolor                      8.706
## 3  virginica                      9.562</code></pre>
<p>对多个分类变量做分组计算，在数据集 ChickWeight 中 Chick和Diet都是数字编码的分类变量，其中 Chick 是有序的因子变量，Diet 是无序的因子变量，而 Time 是数值型的变量，表示小鸡出生的天数。</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 查看数据</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">ChickWeight</span><span class="op">)</span></code></pre></div>
<pre><code>## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   578 obs. of  4 variables:
##  $ weight: num  42 51 59 64 76 93 106 125 149 171 ...
##  $ Time  : num  0 2 4 6 8 10 12 14 16 18 ...
##  $ Chick : Ord.factor w/ 50 levels "18"&lt;"16"&lt;"15"&lt;..: 15 15 15 15 15 15 15 15 15 15 ...
##  $ Diet  : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "formula")=Class 'formula'  language weight ~ Time | Chick
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "outer")=Class 'formula'  language ~Diet
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time"
##   ..$ y: chr "Body weight"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(days)"
##   ..$ y: chr "(gm)"</code></pre>
<p>查看数据集ChickWeight的前几行</p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ChickWeight</span><span class="op">)</span></code></pre></div>
<pre><code>##   weight Time Chick Diet
## 1     42    0     1    1
## 2     51    2     1    1
## 3     59    4     1    1
## 4     64    6     1    1
## 5     76    8     1    1
## 6     93   10     1    1</code></pre>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">ChickWeight</span><span class="op">)</span></code></pre></div>
<pre><code>## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   578 obs. of  4 variables:
##  $ weight: num  42 51 59 64 76 93 106 125 149 171 ...
##  $ Time  : num  0 2 4 6 8 10 12 14 16 18 ...
##  $ Chick : Ord.factor w/ 50 levels "18"&lt;"16"&lt;"15"&lt;..: 15 15 15 15 15 15 15 15 15 15 ...
##  $ Diet  : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "formula")=Class 'formula'  language weight ~ Time | Chick
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "outer")=Class 'formula'  language ~Diet
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Time"
##   ..$ y: chr "Body weight"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(days)"
##   ..$ y: chr "(gm)"</code></pre>
<p>对于数据集ChickWeight中的有序变量Chick，aggregate 会按照既定顺序返回分组计算的结果</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">Chick</span>, data <span class="op">=</span> <span class="va">ChickWeight</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##    Chick    weight
## 1     18  37.00000
## 2     16  49.71429
## 3     15  60.12500
## 4     13  67.83333
## 5      9  81.16667
## 6     20  78.41667
## 7     10  83.08333
## 8      8  92.00000
## 9     17  92.50000
## 10    19  86.75000
## 11     4  99.33333
## 12     6 113.75000
## 13    11 129.91667
## 14     3 115.83333
## 15     1 111.66667
## 16    12 114.08333
## 17     2 119.91667
## 18     5 126.66667
## 19    14 151.33333
## 20     7 150.00000
## 21    24  66.25000
## 22    30 103.50000
## 23    22 104.25000
## 24    23 111.41667
## 25    27 110.41667
## 26    28 129.91667
## 27    26 131.00000
## 28    25 143.08333
## 29    29 141.83333
## 30    21 184.50000
## 31    33 109.75000
## 32    37 102.50000
## 33    36 134.91667
## 34    31 128.58333
## 35    39 134.25000
## 36    38 142.33333
## 37    32 157.58333
## 38    40 157.58333
## 39    34 168.83333
## 40    35 193.16667
## 41    44 102.10000
## 42    45 119.58333
## 43    43 143.00000
## 44    41 128.41667
## 45    47 127.91667
## 46    49 137.75000
## 47    46 134.08333
## 48    50 147.50000
## 49    42 149.08333
## 50    48 157.66667</code></pre>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">Diet</span>, data <span class="op">=</span> <span class="va">ChickWeight</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##   Diet   weight
## 1    1 102.6455
## 2    2 122.6167
## 3    3 142.9500
## 4    4 135.2627</code></pre>
<p>分类变量没有用数字编码，以 CO2 数据集为例，该数据集描述草植对二氧化碳的吸收情况，Plant 是具有12个水平的有序的因子变量，Type表示植物的源头分别是魁北克(Quebec)和密西西比(Mississippi)，Treatment表示冷却(chilled)和不冷却(nonchilled)两种处理方式，conc表示周围环境中二氧化碳的浓度，uptake表示植物吸收二氧化碳的速率。</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 查看数据集</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">CO2</span><span class="op">)</span></code></pre></div>
<pre><code>##   Plant   Type  Treatment conc uptake
## 1   Qn1 Quebec nonchilled   95   16.0
## 2   Qn1 Quebec nonchilled  175   30.4
## 3   Qn1 Quebec nonchilled  250   34.8
## 4   Qn1 Quebec nonchilled  350   37.2
## 5   Qn1 Quebec nonchilled  500   35.3
## 6   Qn1 Quebec nonchilled  675   39.2</code></pre>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">CO2</span><span class="op">)</span></code></pre></div>
<pre><code>## Classes 'nfnGroupedData', 'nfGroupedData', 'groupedData' and 'data.frame':   84 obs. of  5 variables:
##  $ Plant    : Ord.factor w/ 12 levels "Qn1"&lt;"Qn2"&lt;"Qn3"&lt;..: 1 1 1 1 1 1 1 2 2 2 ...
##  $ Type     : Factor w/ 2 levels "Quebec","Mississippi": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Treatment: Factor w/ 2 levels "nonchilled","chilled": 1 1 1 1 1 1 1 1 1 1 ...
##  $ conc     : num  95 175 250 350 500 675 1000 95 175 250 ...
##  $ uptake   : num  16 30.4 34.8 37.2 35.3 39.2 39.7 13.6 27.3 37.1 ...
##  - attr(*, "formula")=Class 'formula'  language uptake ~ conc | Plant
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "outer")=Class 'formula'  language ~Treatment * Type
##   .. ..- attr(*, ".Environment")=&lt;environment: R_EmptyEnv&gt; 
##  - attr(*, "labels")=List of 2
##   ..$ x: chr "Ambient carbon dioxide concentration"
##   ..$ y: chr "CO2 uptake rate"
##  - attr(*, "units")=List of 2
##   ..$ x: chr "(uL/L)"
##   ..$ y: chr "(umol/m^2 s)"</code></pre>
<p>对单个变量分组统计</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">uptake</span> <span class="op">~</span> <span class="va">Plant</span>, data <span class="op">=</span> <span class="va">CO2</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##    Plant   uptake
## 1    Qn1 33.22857
## 2    Qn2 35.15714
## 3    Qn3 37.61429
## 4    Qc1 29.97143
## 5    Qc3 32.58571
## 6    Qc2 32.70000
## 7    Mn3 24.11429
## 8    Mn2 27.34286
## 9    Mn1 26.40000
## 10   Mc2 12.14286
## 11   Mc3 17.30000
## 12   Mc1 18.00000</code></pre>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">uptake</span> <span class="op">~</span> <span class="va">Type</span>, data <span class="op">=</span> <span class="va">CO2</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##          Type   uptake
## 1      Quebec 33.54286
## 2 Mississippi 20.88333</code></pre>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">uptake</span> <span class="op">~</span> <span class="va">Treatment</span>, data <span class="op">=</span> <span class="va">CO2</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##    Treatment   uptake
## 1 nonchilled 30.64286
## 2    chilled 23.78333</code></pre>
<p>对多个变量分组统计，查看二氧化碳吸收速率uptake随类型Type和处理方式Treatment</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">uptake</span> <span class="op">~</span> <span class="va">Type</span> <span class="op">+</span> <span class="va">Treatment</span>, data <span class="op">=</span> <span class="va">CO2</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##          Type  Treatment   uptake
## 1      Quebec nonchilled 35.33333
## 2 Mississippi nonchilled 25.95238
## 3      Quebec    chilled 31.75238
## 4 Mississippi    chilled 15.81429</code></pre>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">CO2</span><span class="op">$</span><span class="va">uptake</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">CO2</span><span class="op">$</span><span class="va">Type</span>, <span class="va">CO2</span><span class="op">$</span><span class="va">Treatment</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>##             nonchilled  chilled
## Quebec        35.33333 31.75238
## Mississippi   25.95238 15.81429</code></pre>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span><span class="op">(</span><span class="va">CO2</span><span class="op">$</span><span class="va">uptake</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">CO2</span><span class="op">$</span><span class="va">Type</span>, <span class="va">CO2</span><span class="op">$</span><span class="va">Treatment</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>## : Quebec
## : nonchilled
## [1] 35.33333
## ------------------------------------------------------------ 
## : Mississippi
## : nonchilled
## [1] 25.95238
## ------------------------------------------------------------ 
## : Quebec
## : chilled
## [1] 31.75238
## ------------------------------------------------------------ 
## : Mississippi
## : chilled
## [1] 15.81429</code></pre>
<p>在这个例子中 tapply 和 by 的输出结果的表示形式不一样，aggregate 返回一个 data.frame 数据框，tapply 返回一个表格 table，by 返回特殊的数据类型 by。</p>
<p>Function <code>by</code> is an object-oriented wrapper for <code>tapply</code> applied to data frames.</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组求和</span>
<span class="co"># by(iris[, 1], INDICES = list(iris$Species), FUN = sum)</span>
<span class="co"># by(iris[, 2], INDICES = list(iris$Species), FUN = sum)</span>
<span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>, INDICES <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>## : setosa
## [1] 73.1
## ------------------------------------------------------------ 
## : versicolor
## [1] 213
## ------------------------------------------------------------ 
## : virginica
## [1] 277.6</code></pre>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, INDICES <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>## : setosa
## [1] 494.8
## ------------------------------------------------------------ 
## : versicolor
## [1] 648.3
## ------------------------------------------------------------ 
## : virginica
## [1] 755.7</code></pre>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, INDICES <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">summary</span><span class="op">)</span></code></pre></div>
<pre><code>## : setosa
##   Sepal.Length    Sepal.Width     Petal.Length  
##  Min.   :4.300   Min.   :2.300   Min.   :1.000  
##  1st Qu.:4.800   1st Qu.:3.200   1st Qu.:1.400  
##  Median :5.000   Median :3.400   Median :1.500  
##  Mean   :5.006   Mean   :3.428   Mean   :1.462  
##  3rd Qu.:5.200   3rd Qu.:3.675   3rd Qu.:1.575  
##  Max.   :5.800   Max.   :4.400   Max.   :1.900  
## ------------------------------------------------------------ 
## : versicolor
##   Sepal.Length    Sepal.Width     Petal.Length 
##  Min.   :4.900   Min.   :2.000   Min.   :3.00  
##  1st Qu.:5.600   1st Qu.:2.525   1st Qu.:4.00  
##  Median :5.900   Median :2.800   Median :4.35  
##  Mean   :5.936   Mean   :2.770   Mean   :4.26  
##  3rd Qu.:6.300   3rd Qu.:3.000   3rd Qu.:4.60  
##  Max.   :7.000   Max.   :3.400   Max.   :5.10  
## ------------------------------------------------------------ 
## : virginica
##   Sepal.Length    Sepal.Width     Petal.Length  
##  Min.   :4.900   Min.   :2.200   Min.   :4.500  
##  1st Qu.:6.225   1st Qu.:2.800   1st Qu.:5.100  
##  Median :6.500   Median :3.000   Median :5.550  
##  Mean   :6.588   Mean   :2.974   Mean   :5.552  
##  3rd Qu.:6.900   3rd Qu.:3.175   3rd Qu.:5.875  
##  Max.   :7.900   Max.   :3.800   Max.   :6.900</code></pre>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/by.html">by</a></span><span class="op">(</span><span class="va">iris</span>, INDICES <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">summary</span><span class="op">)</span></code></pre></div>
<pre><code>## : setosa
##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.300   Min.   :2.300   Min.   :1.000   Min.   :0.100  
##  1st Qu.:4.800   1st Qu.:3.200   1st Qu.:1.400   1st Qu.:0.200  
##  Median :5.000   Median :3.400   Median :1.500   Median :0.200  
##  Mean   :5.006   Mean   :3.428   Mean   :1.462   Mean   :0.246  
##  3rd Qu.:5.200   3rd Qu.:3.675   3rd Qu.:1.575   3rd Qu.:0.300  
##  Max.   :5.800   Max.   :4.400   Max.   :1.900   Max.   :0.600  
##        Species  
##  setosa    :50  
##  versicolor: 0  
##  virginica : 0  
##                 
##                 
##                 
## ------------------------------------------------------------ 
## : versicolor
##   Sepal.Length    Sepal.Width     Petal.Length   Petal.Width          Species  
##  Min.   :4.900   Min.   :2.000   Min.   :3.00   Min.   :1.000   setosa    : 0  
##  1st Qu.:5.600   1st Qu.:2.525   1st Qu.:4.00   1st Qu.:1.200   versicolor:50  
##  Median :5.900   Median :2.800   Median :4.35   Median :1.300   virginica : 0  
##  Mean   :5.936   Mean   :2.770   Mean   :4.26   Mean   :1.326                  
##  3rd Qu.:6.300   3rd Qu.:3.000   3rd Qu.:4.60   3rd Qu.:1.500                  
##  Max.   :7.000   Max.   :3.400   Max.   :5.10   Max.   :1.800                  
## ------------------------------------------------------------ 
## : virginica
##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.900   Min.   :2.200   Min.   :4.500   Min.   :1.400  
##  1st Qu.:6.225   1st Qu.:2.800   1st Qu.:5.100   1st Qu.:1.800  
##  Median :6.500   Median :3.000   Median :5.550   Median :2.000  
##  Mean   :6.588   Mean   :2.974   Mean   :5.552   Mean   :2.026  
##  3rd Qu.:6.900   3rd Qu.:3.175   3rd Qu.:5.875   3rd Qu.:2.300  
##  Max.   :7.900   Max.   :3.800   Max.   :6.900   Max.   :2.500  
##        Species  
##  setosa    : 0  
##  versicolor: 0  
##  virginica :50  
##                 
##                 
## </code></pre>
<p>Group Averages Over Level Combinations of Factors 分组平均</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">warpbreaks</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    54 obs. of  3 variables:
##  $ breaks : num  26 30 54 25 70 52 51 26 67 18 ...
##  $ wool   : Factor w/ 2 levels "A","B": 1 1 1 1 1 1 1 1 1 1 ...
##  $ tension: Factor w/ 3 levels "L","M","H": 1 1 1 1 1 1 1 1 1 2 ...</code></pre>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">warpbreaks</span><span class="op">)</span></code></pre></div>
<pre><code>##   breaks wool tension
## 1     26    A       L
## 2     30    A       L
## 3     54    A       L
## 4     25    A       L
## 5     70    A       L
## 6     52    A       L</code></pre>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">warpbreaks</span><span class="op">$</span><span class="va">breaks</span>, <span class="va">warpbreaks</span><span class="op">$</span><span class="va">wool</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
##  [9] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
## [17] 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704 31.03704
## [25] 31.03704 31.03704 31.03704 25.25926 25.25926 25.25926 25.25926 25.25926
## [33] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
## [41] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926
## [49] 25.25926 25.25926 25.25926 25.25926 25.25926 25.25926</code></pre>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">warpbreaks</span>, <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">breaks</span>, <span class="va">tension</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, trim <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875
## [10] 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125
## [19] 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625
## [28] 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875 35.6875
## [37] 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125 26.3125
## [46] 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625 21.0625</code></pre>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组求和</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">warpbreaks</span>, <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">breaks</span>, <span class="va">tension</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 655 655 655 655 655 655 655 655 655 475 475 475 475 475 475 475 475 475 390
## [20] 390 390 390 390 390 390 390 390 655 655 655 655 655 655 655 655 655 475 475
## [39] 475 475 475 475 475 475 475 390 390 390 390 390 390 390 390 390</code></pre>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 分组求和</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="va">Species</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   [1] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [13] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [25] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [37] 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3 250.3
##  [49] 250.3 250.3 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [61] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [73] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [85] 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8 296.8
##  [97] 296.8 296.8 296.8 296.8 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [109] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [121] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [133] 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4 329.4
## [145] 329.4 329.4 329.4 329.4 329.4 329.4</code></pre>
</div>
<div id="dm-table" class="section level2" number="5.11">
<h2>
<span class="header-section-number">5.11</span> 表格统计<a class="anchor" aria-label="anchor" href="#dm-table"><i class="fas fa-link"></i></a>
</h2>
<blockquote>
<p>介绍操作表格的 table, addmargins, prop.table, xtabs, margin.table, ftabe 等函数</p>
</blockquote>
<p>table 多个分类变量分组计数统计</p>
<ul>
<li>介绍 warpbreaks 和 airquality 纽约空气质量监测数据集 二维的数据框</li>
<li>UCBAdmissions 1973 年加州大学伯克利分校的院系录取数据集 3维的列联表</li>
<li>Titanic 4维的列联表数据 泰坦尼克号幸存者数据集</li>
</ul>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">warpbreaks</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">wool</span>, <span class="va">tension</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9</code></pre>
<p>以 iris 数据集为例，table 的第一个参数是自己制造的第二个分类变量，原始分类变量是 Species</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Sepal.check <span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">7</span>, <span class="va">Species</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##            Species
## Sepal.check setosa versicolor virginica
##       FALSE     50         50        38
##       TRUE       0          0        12</code></pre>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Sepal.check <span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="va">Species</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##            Species
## Sepal.check setosa versicolor virginica
##       FALSE     50         24         6
##       TRUE       0         26        44</code></pre>
<p>以 airquality 数据集为例，看看月份中臭氧含量比较高的几天</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aiq.tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Oz.high <span class="op">=</span> <span class="va">Ozone</span> <span class="op">&gt;</span> <span class="fl">80</span>, <span class="va">Month</span><span class="op">)</span><span class="op">)</span>
<span class="va">aiq.tab</span></code></pre></div>
<pre><code>##        Month
## Oz.high  5  6  7  8  9
##   FALSE 25  9 20 19 27
##   TRUE   1  0  6  7  2</code></pre>
<p>对表格按行和列求和，即求表格的边际，查看总体情况</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span><span class="va">aiq.tab</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>##        Month
## Oz.high   5   6   7   8   9 Sum
##   FALSE  25   9  20  19  27 100
##   TRUE    1   0   6   7   2  16
##   Sum    26   9  26  26  29 116</code></pre>
<p>臭氧含量超 80 的天数在每个月的占比，<code>addmargins</code> 的第二个参数 1 表示对列求和</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aiq.prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="va">aiq.tab</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">aiq.prop</span></code></pre></div>
<pre><code>##        Month
## Oz.high          5          6          7          8          9
##   FALSE 0.96153846 1.00000000 0.76923077 0.73076923 0.93103448
##   TRUE  0.03846154 0.00000000 0.23076923 0.26923077 0.06896552</code></pre>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aiq.marprop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/addmargins.html">addmargins</a></span><span class="op">(</span><span class="va">aiq.prop</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">aiq.marprop</span></code></pre></div>
<pre><code>##        Month
## Oz.high          5          6          7          8          9
##   FALSE 0.96153846 1.00000000 0.76923077 0.73076923 0.93103448
##   TRUE  0.03846154 0.00000000 0.23076923 0.26923077 0.06896552
##   Sum   1.00000000 1.00000000 1.00000000 1.00000000 1.00000000</code></pre>
<p>转换成百分比，将小数四舍五入转化为百分数，保留两位小数点</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">aiq.marprop</span>, <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>##        Month
## Oz.high      5      6      7      8      9
##   FALSE  96.15 100.00  76.92  73.08  93.10
##   TRUE    3.85   0.00  23.08  26.92   6.90
##   Sum   100.00 100.00 100.00 100.00 100.00</code></pre>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">airquality</span>, panel <span class="op">=</span> <span class="va">panel.smooth</span>, main <span class="op">=</span> <span class="st">"airquality data"</span><span class="op">)</span></code></pre></div>
<p>以 UCBAdmissions 数据集为例，使用 <code>xtabs</code> 函数把数据组织成列联表，先查看数据的内容</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">UCBAdmissions</span></code></pre></div>
<pre><code>## , , Dept = A
## 
##           Gender
## Admit      Male Female
##   Admitted  512     89
##   Rejected  313     19
## 
## , , Dept = B
## 
##           Gender
## Admit      Male Female
##   Admitted  353     17
##   Rejected  207      8
## 
## , , Dept = C
## 
##           Gender
## Admit      Male Female
##   Admitted  120    202
##   Rejected  205    391
## 
## , , Dept = D
## 
##           Gender
## Admit      Male Female
##   Admitted  138    131
##   Rejected  279    244
## 
## , , Dept = E
## 
##           Gender
## Admit      Male Female
##   Admitted   53     94
##   Rejected  138    299
## 
## , , Dept = F
## 
##           Gender
## Admit      Male Female
##   Admitted   22     24
##   Rejected  351    317</code></pre>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">UCBA2DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">UCBAdmissions</span><span class="op">)</span>
<span class="va">UCBA2DF</span></code></pre></div>
<pre><code>##       Admit Gender Dept Freq
## 1  Admitted   Male    A  512
## 2  Rejected   Male    A  313
## 3  Admitted Female    A   89
## 4  Rejected Female    A   19
## 5  Admitted   Male    B  353
## 6  Rejected   Male    B  207
## 7  Admitted Female    B   17
## 8  Rejected Female    B    8
## 9  Admitted   Male    C  120
## 10 Rejected   Male    C  205
## 11 Admitted Female    C  202
## 12 Rejected Female    C  391
## 13 Admitted   Male    D  138
## 14 Rejected   Male    D  279
## 15 Admitted Female    D  131
## 16 Rejected Female    D  244
## 17 Admitted   Male    E   53
## 18 Rejected   Male    E  138
## 19 Admitted Female    E   94
## 20 Rejected Female    E  299
## 21 Admitted   Male    F   22
## 22 Rejected   Male    F  351
## 23 Admitted Female    F   24
## 24 Rejected Female    F  317</code></pre>
<p>接着将 <code>UCBA2DF</code> 数据集转化为表格的形式</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">UCBA2DF.tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html">xtabs</a></span><span class="op">(</span><span class="va">Freq</span> <span class="op">~</span> <span class="va">Gender</span> <span class="op">+</span> <span class="va">Admit</span> <span class="op">+</span> <span class="va">Dept</span>, data <span class="op">=</span> <span class="va">UCBA2DF</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/ftable.html">ftable</a></span><span class="op">(</span><span class="va">UCBA2DF.tab</span><span class="op">)</span></code></pre></div>
<pre><code>##                 Dept   A   B   C   D   E   F
## Gender Admit                                
## Male   Admitted      512 353 120 138  53  22
##        Rejected      313 207 205 279 138 351
## Female Admitted       89  17 202 131  94  24
##        Rejected       19   8 391 244 299 317</code></pre>
<p>将录取性别和院系进行对比</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/marginSums.html">margin.table</a></span><span class="op">(</span><span class="va">UCBA2DF.tab</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>##         Dept
## Gender            A          B          C          D          E          F
##   Male   0.30657748 0.20810108 0.12077295 0.15496098 0.07097733 0.13861018
##   Female 0.05885559 0.01362398 0.32316076 0.20435967 0.21416894 0.18583106</code></pre>
<p>男生倾向于申请院系 A 和 B，女生倾向于申请院系 C 到 F，院系 A 和 B 是最容易录取的。</p>
</div>
<div id="dm-index" class="section level2" number="5.12">
<h2>
<span class="header-section-number">5.12</span> 索引访问<a class="anchor" aria-label="anchor" href="#dm-index"><i class="fas fa-link"></i></a>
</h2>
<p>which 与引用 <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> 性能比较，在区间 <span class="math inline">\([0,1]\)</span> 上生成 10 万个服从均匀分布的随机数，随机抽取其中<span class="math inline">\(\frac{1}{4}\)</span>。</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html">logical</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">i</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
<span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">]</span>, times <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></code></pre></div>
<p><span class="todo">使用 <code>subset</code> 函数与 <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> 比较</span></p>
</div>
<div id="dm-array" class="section level2" number="5.13">
<h2>
<span class="header-section-number">5.13</span> 多维数组<a class="anchor" aria-label="anchor" href="#dm-array"><i class="fas fa-link"></i></a>
</h2>
<p>多维数组的行列是怎么定义的 <code><a href="https://rdrr.io/r/base/array.html">?array</a></code> 轴的概念，画个图表示数组</p>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">27</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## , , 1
## 
##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9
## 
## , , 2
## 
##      [,1] [,2] [,3]
## [1,]   10   13   16
## [2,]   11   14   17
## [3,]   12   15   18
## 
## , , 3
## 
##      [,1] [,2] [,3]
## [1,]   19   22   25
## [2,]   20   23   26
## [3,]   21   24   27</code></pre>
<p>垂直于Z轴的平面去截三维立方体，3 代表 z 轴，得到三个截面（二维矩阵）</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/asplit.html">asplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">27</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9
## 
## [[2]]
##      [,1] [,2] [,3]
## [1,]   10   13   16
## [2,]   11   14   17
## [3,]   12   15   18
## 
## [[3]]
##      [,1] [,2] [,3]
## [1,]   19   22   25
## [2,]   20   23   26
## [3,]   21   24   27</code></pre>
<p>对每个二维矩阵按列求和</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/asplit.html">asplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">27</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="va">apply</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## [1]  6 15 24
## 
## [[2]]
## [1] 33 42 51
## 
## [[3]]
## [1] 60 69 78</code></pre>
<p><code>asplit</code> 和 <code>lapply</code> 组合处理多维数组的<a href="https://www.brodieg.com/2018/11/23/is-your-matrix-running-slow-try-lists">计算问题</a></p>
<p><a href="https://d.cosx.org/d/107493">三维数组的矩阵运算</a> <a href="https://CRAN.R-project.org/package=abind">abind</a> 包提供更多的数组操作，如合并，替换</p>
<p>数组操作 aperm 数组转置 Array Transposition</p>
<p>asplit 数组拆分 其后接 lapply 或者 vapply</p>
<p>apply 数组计算</p>
<p>rray 包 <a href="https://github.com/r-lib/rray" class="uri">https://github.com/r-lib/rray</a></p>
</div>
<div id="dm-others" class="section level2" number="5.14">
<h2>
<span class="header-section-number">5.14</span> 其它操作<a class="anchor" aria-label="anchor" href="#dm-others"><i class="fas fa-link"></i></a>
</h2>
<p>成对的数据操作有 <code>list</code> 与 <code>unlist</code>、<code>stack</code> 与 <code>unstack</code>、<code>class</code> 与 <code>unclass</code>、<code>attach</code> 与 <code>detach</code> 以及 <code>with</code> 和 <code>within</code>，它们在数据操作过程中有时会起到一定的补充作用。</p>
<div id="relist-or-unlist" class="section level3" number="5.14.1">
<h3>
<span class="header-section-number">5.14.1</span> 列表属性<a class="anchor" aria-label="anchor" href="#relist-or-unlist"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 创建列表</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">pairlist</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
<span class="co"># 转化列表</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span>
<span class="co">## S3 method for class 'environment'</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">x</span>, all.names <span class="op">=</span> <span class="cn">FALSE</span>, sorted <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">as.pairlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co"># 检查列表</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.pairlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></code></pre></div>
<p><code>list</code> 函数用来构造、转化和检查 R 列表对象。下面创建一个临时列表对象 tmp ，它包含两个元素 A 和 B，两个元素都是向量，前者是数值型，后者是字符型</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## $A
## [1] 1 2 3
## 
## $B
## [1] "a" "b"</code></pre>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">x</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, use.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><code>unlist</code> 函数将给定的列表对象 <code>x</code> 简化为原子向量 (atomic vector)，我们发现简化之后变成一个字符型向量</p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></code></pre></div>
<pre><code>##  A1  A2  A3  B1  B2 
## "1" "2" "3" "a" "b"</code></pre>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">tmp</span>, use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "1" "2" "3" "a" "b"</code></pre>
<p>unlist 的逆操作是 relist</p>
</div>
<div id="stack-or-unstack" class="section level3" number="5.14.2">
<h3>
<span class="header-section-number">5.14.2</span> 堆叠向量<a class="anchor" aria-label="anchor" href="#stack-or-unstack"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span>
<span class="co">## Default S3 method:</span>
<span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">x</span>, drop <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span>
<span class="co">## S3 method for class 'data.frame'</span>
<span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">select</span>, drop <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/stack.html">unstack</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span>
<span class="co">## Default S3 method:</span>
<span class="fu"><a href="https://rdrr.io/r/utils/stack.html">unstack</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">form</span>, <span class="va">...</span><span class="op">)</span>
<span class="co">## S3 method for class 'data.frame'</span>
<span class="fu"><a href="https://rdrr.io/r/utils/stack.html">unstack</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">form</span>, <span class="va">...</span><span class="op">)</span></code></pre></div>
<p><code>stack</code> 与 <code>unstack</code> 将多个向量堆在一起组成一个向量</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 查看数据集 PlantGrowth</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.frame"</code></pre>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span></code></pre></div>
<pre><code>##   weight group
## 1   4.17  ctrl
## 2   5.58  ctrl
## 3   5.18  ctrl
## 4   6.11  ctrl
## 5   4.50  ctrl
## 6   4.61  ctrl</code></pre>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 检查默认的公式</span>
<span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span> </code></pre></div>
<pre><code>## weight ~ group</code></pre>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 根据公式解除堆叠</span>
<span class="co"># 下面等价于 unstack(PlantGrowth, form = weight ~ group)</span>
<span class="op">(</span><span class="va">pg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/stack.html">unstack</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<pre><code>##    ctrl trt1 trt2
## 1  4.17 4.81 6.31
## 2  5.58 4.17 5.12
## 3  5.18 4.41 5.54
## 4  6.11 3.59 5.50
## 5  4.50 5.87 5.37
## 6  4.61 3.83 5.29
## 7  5.17 6.03 4.92
## 8  4.53 4.89 6.15
## 9  5.33 4.32 5.80
## 10 5.14 4.69 5.26</code></pre>
<p>现在再将变量 pg 堆叠起来，还可以指定要堆叠的列</p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">pg</span><span class="op">)</span></code></pre></div>
<pre><code>##    values  ind
## 1    4.17 ctrl
## 2    5.58 ctrl
## 3    5.18 ctrl
## 4    6.11 ctrl
## 5    4.50 ctrl
## 6    4.61 ctrl
## 7    5.17 ctrl
## 8    4.53 ctrl
## 9    5.33 ctrl
## 10   5.14 ctrl
## 11   4.81 trt1
## 12   4.17 trt1
## 13   4.41 trt1
## 14   3.59 trt1
## 15   5.87 trt1
## 16   3.83 trt1
## 17   6.03 trt1
## 18   4.89 trt1
## 19   4.32 trt1
## 20   4.69 trt1
## 21   6.31 trt2
## 22   5.12 trt2
## 23   5.54 trt2
## 24   5.50 trt2
## 25   5.37 trt2
## 26   5.29 trt2
## 27   4.92 trt2
## 28   6.15 trt2
## 29   5.80 trt2
## 30   5.26 trt2</code></pre>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">pg</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">ctrl</span><span class="op">)</span></code></pre></div>
<pre><code>##    values  ind
## 1    4.81 trt1
## 2    4.17 trt1
## 3    4.41 trt1
## 4    3.59 trt1
## 5    5.87 trt1
## 6    3.83 trt1
## 7    6.03 trt1
## 8    4.89 trt1
## 9    4.32 trt1
## 10   4.69 trt1
## 11   6.31 trt2
## 12   5.12 trt2
## 13   5.54 trt2
## 14   5.50 trt2
## 15   5.37 trt2
## 16   5.29 trt2
## 17   4.92 trt2
## 18   6.15 trt2
## 19   5.80 trt2
## 20   5.26 trt2</code></pre>
<div class="sidebar">
<p>形式上和 reshape 有一些相似之处，数据框可以由长变宽或由宽变长</p>
</div>
</div>
<div id="class-or-unclass" class="section level3" number="5.14.3">
<h3>
<span class="header-section-number">5.14.3</span> 属性转化<a class="anchor" aria-label="anchor" href="#class-or-unclass"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">value</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">what</span>, which <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">oldClass</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">oldClass</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">value</span></code></pre></div>
<p><code>class</code> 和 <code>unclass</code> 函数用来查看、设置类属性和取消类属性，常用于面向对象的编程设计中</p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.frame"</code></pre>
<div class="sourceCode" id="cb315"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "factor"</code></pre>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [75] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3
## [112] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3
## [149] 3 3
## attr(,"levels")
## [1] "setosa"     "versicolor" "virginica"</code></pre>
</div>
<div id="attach-or-detach" class="section level3" number="5.14.4">
<h3>
<span class="header-section-number">5.14.4</span> 绑定环境<a class="anchor" aria-label="anchor" href="#attach-or-detach"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">what</span>,
  pos <span class="op">=</span> <span class="fl">2L</span>, name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span><span class="op">(</span><span class="va">what</span><span class="op">)</span>, backtick <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
  warn.conflicts <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">name</span>,
  pos <span class="op">=</span> <span class="fl">2L</span>, unload <span class="op">=</span> <span class="cn">FALSE</span>, character.only <span class="op">=</span> <span class="cn">FALSE</span>,
  force <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<p><code>attach</code> 和 <code>detach</code> 是否绑定数据框的列名，不推荐操作，推荐使用 <code>with</code></p>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] setosa setosa setosa setosa setosa setosa
## Levels: setosa versicolor virginica</code></pre>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
</div>
<div id="with-or-within" class="section level3" number="5.14.5">
<h3>
<span class="header-section-number">5.14.5</span> 数据环境<a class="anchor" aria-label="anchor" href="#with-or-within"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb323"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">expr</span>, <span class="va">...</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">expr</span>, <span class="va">...</span><span class="op">)</span>
<span class="co">## S3 method for class 'list'</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">expr</span>, keepAttrs <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></code></pre></div>
<dl>
<dt><code>data</code></dt>
<dd>参数 <code>data</code> 用来构造表达式计算的环境。其默认值可以是一个环境，列表，数据框。在 <code>within</code> 函数中 <code>data</code> 参数只能是列表或数据框。
</dd>
<dt><code>expr</code></dt>
<dd>
<p>参数 <code>expr</code> 包含要计算的表达式。在 <code>within</code> 中通常包含一个复合表达式，比如</p>
<div class="sourceCode" id="cb324"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">{</span>
  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">somefun</span><span class="op">(</span><span class="op">)</span>
  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">otherfun</span><span class="op">(</span><span class="op">)</span>
  <span class="va">...</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">unused1</span>, <span class="va">temp</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</dd>
</dl>
<p><code>with</code> 和 <code>within</code> 计算一组表达式，计算的环境是由数据构造的，后者可以修改原始的数据</p>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">mpg</span><span class="op">[</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">8</span> <span class="op">&amp;</span> <span class="va">disp</span> <span class="op">&gt;</span> <span class="fl">350</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 18.7 14.3 10.4 10.4 14.7 19.2 15.8</code></pre>
<p>和下面计算的结果一样，但是更加简洁漂亮</p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span><span class="op">[</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">8</span> <span class="op">&amp;</span> <span class="va">mtcars</span><span class="op">$</span><span class="va">disp</span> <span class="op">&gt;</span> <span class="fl">350</span><span class="op">]</span></code></pre></div>
<pre><code>## [1] 18.7 14.3 10.4 10.4 14.7 19.2 15.8</code></pre>
<p><code>within</code> 函数可以修改原数据环境中的多个变量，比如删除、修改和添加等</p>
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 原数据集 airquality</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></code></pre></div>
<pre><code>##   Ozone Solar.R Wind Temp Month Day
## 1    41     190  7.4   67     5   1
## 2    36     118  8.0   72     5   2
## 3    12     149 12.6   74     5   3
## 4    18     313 11.5   62     5   4
## 5    NA      NA 14.3   56     5   5
## 6    28      NA 14.9   66     5   6</code></pre>
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="op">{</span>
  <span class="va">lOzone</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">)</span> <span class="co"># 取对数</span>
  <span class="va">Month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">month.abb</span><span class="op">[</span><span class="va">Month</span><span class="op">]</span><span class="op">)</span> <span class="co"># 字符串型转因子型</span>
  <span class="va">cTemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">Temp</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span> <span class="op">/</span> <span class="fl">9</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># 从华氏温度到摄氏温度转化</span>
  <span class="va">S.cT</span> <span class="op">&lt;-</span> <span class="va">Solar.R</span> <span class="op">/</span> <span class="va">cTemp</span> <span class="co"># 使用新创建的变量</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">Day</span>, <span class="va">Temp</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co"># 修改后的数据集</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aq</span><span class="op">)</span></code></pre></div>
<pre><code>##   Ozone Solar.R Wind Month      S.cT cTemp   lOzone
## 1    41     190  7.4   May  9.793814  19.4 3.713572
## 2    36     118  8.0   May  5.315315  22.2 3.583519
## 3    12     149 12.6   May  6.394850  23.3 2.484907
## 4    18     313 11.5   May 18.742515  16.7 2.890372
## 5    NA      NA 14.3   May        NA  13.3       NA
## 6    28      NA 14.9   May        NA  18.9 3.332205</code></pre>
<p>下面再举一个复杂的绘图例子，这个例子来自 <code>boxplot</code> 函数</p>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">ToothGrowth</span>, <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">len</span> <span class="op">~</span> <span class="va">dose</span>,
    boxwex <span class="op">=</span> <span class="fl">0.25</span>, at <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">-</span> <span class="fl">0.2</span>,
    subset <span class="op">=</span> <span class="op">(</span><span class="va">supp</span> <span class="op">==</span> <span class="st">"VC"</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"#4285f4"</span>,
    main <span class="op">=</span> <span class="st">"Guinea Pigs' Tooth Growth"</span>,
    xlab <span class="op">=</span> <span class="st">"Vitamin C dose mg"</span>,
    ylab <span class="op">=</span> <span class="st">"tooth length"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">35</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">len</span> <span class="op">~</span> <span class="va">dose</span>,
    add <span class="op">=</span> <span class="cn">TRUE</span>, boxwex <span class="op">=</span> <span class="fl">0.25</span>, at <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">+</span> <span class="fl">0.2</span>,
    subset <span class="op">=</span> <span class="va">supp</span> <span class="op">==</span> <span class="st">"OJ"</span>, col <span class="op">=</span> <span class="st">"#EA4335"</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">9</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ascorbic acid"</span>, <span class="st">"Orange juice"</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#4285f4"</span>, <span class="st">"#EA4335"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="data-manipulation_files/figure-html/subset-in-boxplot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>将 <code>boxplot</code> 函数的 <code>subset</code> 参数单独提出来，调用数据子集选择函数 <code>subset</code> ，这里 <code>with</code> 中只包含一个表达式，所以也可以不用大括号</p>
<div class="sourceCode" id="cb334"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">ToothGrowth</span>, <span class="va">supp</span> <span class="op">==</span> <span class="st">"VC"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">len</span> <span class="op">~</span> <span class="va">dose</span>,
    boxwex <span class="op">=</span> <span class="fl">0.25</span>, at <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">-</span> <span class="fl">0.2</span>,
    col <span class="op">=</span> <span class="st">"#4285f4"</span>, main <span class="op">=</span> <span class="st">"Guinea Pigs' Tooth Growth"</span>,
    xlab <span class="op">=</span> <span class="st">"Vitamin C dose mg"</span>,
    ylab <span class="op">=</span> <span class="st">"tooth length"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">35</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">ToothGrowth</span>, <span class="va">supp</span> <span class="op">==</span> <span class="st">"OJ"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">len</span> <span class="op">~</span> <span class="va">dose</span>,
    add <span class="op">=</span> <span class="cn">TRUE</span>, boxwex <span class="op">=</span> <span class="fl">0.25</span>, at <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">+</span> <span class="fl">0.2</span>,
    col <span class="op">=</span> <span class="st">"#EA4335"</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">9</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ascorbic acid"</span>, <span class="st">"Orange juice"</span><span class="op">)</span>,
  fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#4285f4"</span>, <span class="st">"#EA4335"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="data-manipulation_files/figure-html/subset-out-boxplot-1.png" width="672" style="display: block; margin: auto;"></div>
<p>可以作为数据变换 <code>transform</code> 的一种替代，它也比较像 <strong>dplyr</strong> 包的 <code>mutate</code> 函数</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>,<span class="op">{</span>
  <span class="va">disp.cc</span> <span class="op">&lt;-</span> <span class="va">disp</span> <span class="op">*</span> <span class="fl">2.54</span><span class="op">^</span><span class="fl">3</span>
  <span class="va">disp.l</span> <span class="op">&lt;-</span> <span class="va">disp.cc</span> <span class="op">/</span> <span class="fl">1e3</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>##                    mpg cyl disp   disp.l  disp.cc
## Mazda RX4         21.0   6  160 2.621930 2621.930
## Mazda RX4 Wag     21.0   6  160 2.621930 2621.930
## Datsun 710        22.8   4  108 1.769803 1769.803
## Hornet 4 Drive    21.4   6  258 4.227863 4227.863
## Hornet Sportabout 18.7   8  360 5.899343 5899.343</code></pre>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 只能使用已有的列，刚生成的列不能用</span>
<span class="co"># transform(</span>
<span class="co">#   mtcars[1:5, 1:3],</span>
<span class="co">#   disp.cc = disp * 2.54^3,</span>
<span class="co">#   disp.l = disp.cc / 1e3</span>
<span class="co"># )</span>
<span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span><span class="op">(</span>
  <span class="va">mtcars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>,
  disp.cc <span class="op">=</span> <span class="va">disp</span> <span class="op">*</span> <span class="fl">2.54</span><span class="op">^</span><span class="fl">3</span>
<span class="op">)</span></code></pre></div>
<pre><code>##                    mpg cyl disp  disp.cc
## Mazda RX4         21.0   6  160 2621.930
## Mazda RX4 Wag     21.0   6  160 2621.930
## Datsun 710        22.8   4  108 1769.803
## Hornet 4 Drive    21.4   6  258 4227.863
## Hornet Sportabout 18.7   8  360 5899.343</code></pre>
<p><code>transform</code> 只能使用已有的列，变换中间生成的列不能用，所以相比于 <code>transform</code> 函数， <code>within</code> 显得更为灵活</p>
</div>
</div>
<div id="dm-apply-family" class="section level2" number="5.15">
<h2>
<span class="header-section-number">5.15</span> apply 族<a class="anchor" aria-label="anchor" href="#dm-apply-family"><i class="fas fa-link"></i></a>
</h2>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:apply-functions">表 5.1: </span> apply 函数</caption>
<thead><tr class="header">
<th align="left">函数</th>
<th align="left">输入</th>
<th align="left">输出</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code></td>
<td align="left">矩阵、数据框</td>
<td align="left">向量</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code></td>
<td align="left">向量、列表</td>
<td align="left">列表</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code></td>
<td align="left">向量、列表</td>
<td align="left">向量、矩阵</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/mapply.html">mapply()</a></code></td>
<td align="left">多个向量</td>
<td align="left">列表</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/tapply.html">tapply()</a></code></td>
<td align="left">数据框、数组</td>
<td align="left">向量</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code></td>
<td align="left">列表</td>
<td align="left">矩阵</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/base/eapply.html">eapply()</a></code></td>
<td align="left">列表</td>
<td align="left">列表</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/base/rapply.html">rapply()</a></code></td>
<td align="left">嵌套列表</td>
<td align="left">嵌套列表</td>
</tr>
</tbody>
</table></div>
<p>除此之外，还有 <code><a href="https://rdrr.io/r/stats/dendrapply.html">dendrapply()</a></code> 专门处理层次聚类或分类回归树型结构， 而函数 <code><a href="https://rdrr.io/r/stats/kernapply.html">kernapply()</a></code> 用于时间序列的平滑处理</p>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Reproduce example 10.4.3 from Brockwell and Davis (1991) [@Brockwell_1991_Time]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/spectrum.html">spectrum</a></span><span class="op">(</span><span class="va">sunspot.year</span>, kernel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kernel.html">kernel</a></span><span class="op">(</span><span class="st">"daniell"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">7</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, log <span class="op">=</span> <span class="st">"no"</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:spectrum-sunspot-year"></span>
<img src="data-manipulation_files/figure-html/spectrum-sunspot-year-1.png" alt="太阳黑子的频谱" width="672"><p class="caption">
图 5.4: 太阳黑子的频谱
</p>
</div>
<!-- https://design.tidyverse.org/cs-mapply-pmap.html -->
<p>将函数应用到多个向量，返回一个列表，生成四组服从正态分布 <span class="math inline">\(\mathcal{N}(\mu_i,\sigma_i)\)</span> 的随机数，它们的均值和方差依次是 <span class="math inline">\(\mu_i = \sigma_i = 1 \ldots 4\)</span></p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">means</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>
<span class="va">sds</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="va">rnorm</span>,
  mean <span class="op">=</span> <span class="va">means</span>, sd <span class="op">=</span> <span class="va">sds</span>,
  MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="va">samples</span></code></pre></div>
<pre><code>## [[1]]
##  [1]  1.37697212  1.30154837 -0.09802317 -0.13040590 -1.79653432  1.72057350
##  [7]  1.93912102  0.77062225  2.75913135  1.11736679
## 
## [[2]]
##  [1]  0.2937544  3.8185184  4.3927459  1.2568322  1.7534795  5.6000862
##  [7]  5.4079918 -4.0775292 -2.5779499  2.1166070
## 
## [[3]]
##  [1] 9.523096 6.294548 3.954661 2.780557 5.502806 3.596252 6.893524 5.810155
##  [9] 2.557700 3.331296
## 
## [[4]]
##  [1]  0.7499813  1.0251913  8.3813803 13.7414948  5.5524739  5.1625107
##  [7]  2.8576069  4.3040589  1.7588056  5.7887535</code></pre>
<p>我们借用图<a href="chap-data-manipulation.html#fig:mapply-lapply">5.5</a>来看一下 mapply 的效果，多组随机数生成非常有助于快速模拟。</p>
<div class="sourceCode" id="cb342"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"darkorange"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:mapply-lapply"></span>
<img src="data-manipulation_files/figure-html/mapply-lapply-1.png" alt=" lapply 函数" width="672"><p class="caption">
图 5.5:  lapply 函数
</p>
</div>
<p>分别计算每个样本的平均值</p>
<div class="sourceCode" id="cb343"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">mean</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.8960372 1.7984536 5.0244596 4.9322257</code></pre>
<p>分别计算每个样本的1，2，3 分位点</p>
<div class="sourceCode" id="cb345"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
##       25%       50%       75% 
## 0.1191382 1.2094576 1.6346732 
## 
## [[2]]
##       25%       50%       75% 
## 0.5345238 1.9350433 4.2491890 
## 
## [[3]]
##      25%      50%      75% 
## 3.397535 4.728734 6.173450 
## 
## [[4]]
##      25%      50%      75% 
## 2.033506 4.733285 5.729684</code></pre>
<p>仅用 <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> 函数替换上面的 <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>，我们可以得到一个矩阵，值得注意的是函数 <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> 和 <code><a href="https://rdrr.io/r/stats/fivenum.html">fivenum()</a></code> 算出来的结果有一些差异</p>
<div class="sourceCode" id="cb347"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>##          [,1]      [,2]     [,3]     [,4]
## 25% 0.1191382 0.5345238 3.397535 2.033506
## 50% 1.2094576 1.9350433 4.728734 4.733285
## 75% 1.6346732 4.2491890 6.173450 5.729684</code></pre>
<div class="sourceCode" id="cb349"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">fivenum</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Min. <span class="op">=</span> <span class="fl">0</span>, <span class="st">"1st Qu."</span> <span class="op">=</span> <span class="fl">0</span>, Median <span class="op">=</span> <span class="fl">0</span>, <span class="st">"3rd Qu."</span> <span class="op">=</span> <span class="fl">0</span>, Max. <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##                [,1]       [,2]     [,3]       [,4]
## Min.    -1.79653432 -4.0775292 2.557700  0.7499813
## 1st Qu. -0.09802317  0.2937544 3.331296  1.7588056
## Median   1.20945758  1.9350433 4.728734  4.7332848
## 3rd Qu.  1.72057350  4.3927459 6.294548  5.7887535
## Max.     2.75913135  5.6000862 9.523096 13.7414948</code></pre>
<p>vapply 和 sapply 类似，但是预先指定返回值类型，这样可以更加安全，有时也更快。</p>
<p>以数据集 presidents 为例，它是一个 ts 对象类型的时间序列数据，记录了 1945 年至 1974 年每个季度美国总统的支持率，这组数据中存在缺失值，以 NA 表示。支持率的变化趋势见图 <a href="chap-data-manipulation.html#fig:usa-presidents">5.6</a>。</p>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">presidents</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:usa-presidents"></span>
<img src="data-manipulation_files/figure-html/usa-presidents-1.png" alt="1945-1974美国总统的支持率" width="672"><p class="caption">
图 5.6: 1945-1974美国总统的支持率
</p>
</div>
<p>计算这 30 年每个季度的平均支持率</p>
<div class="sourceCode" id="cb352"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">presidents</span>, <span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">presidents</span><span class="op">)</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>##        1        2        3        4 
## 58.44828 56.43333 57.22222 53.07143</code></pre>
<p><code><a href="https://rdrr.io/r/stats/time.html">cycle()</a></code> 函数计算序列中每个观察值在周期中的位置，presidents 的周期为 4，根据位置划分组，然后分组求平均，也可以化作如下计算步骤，虽然看起来复杂，但是数据操作的过程很清晰，不再看起来像是一个黑箱。</p>
<p>tapply 函数来做分组求和</p>
<div class="sourceCode" id="cb354"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 一个变量分组求和</span>
<span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">warpbreaks</span><span class="op">$</span><span class="va">breaks</span>, <span class="va">warpbreaks</span><span class="op">[</span>, <span class="fl">3</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span></code></pre></div>
<pre><code>## tension
##   L   M   H 
## 655 475 390</code></pre>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 两个变量分组计数</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">warpbreaks</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">wool</span>, <span class="va">tension</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     tension
## wool L M H
##    A 9 9 9
##    B 9 9 9</code></pre>
<div class="sourceCode" id="cb358"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 两个变量分组求和</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">breaks</span> <span class="op">~</span> <span class="va">wool</span> <span class="op">+</span> <span class="va">tension</span>, data <span class="op">=</span> <span class="va">warpbreaks</span>, <span class="va">sum</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span>v.names <span class="op">=</span> <span class="st">"breaks"</span>, idvar <span class="op">=</span> <span class="st">"wool"</span>, timevar <span class="op">=</span> <span class="st">"tension"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>

<span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"(breaks)"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, replacement <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   wool   L   M   H
## 1    A 401 216 221
## 2    B 254 259 169</code></pre>
</div>
<div id="sec-option-with" class="section level2" number="5.16">
<h2>
<span class="header-section-number">5.16</span> with 选项<a class="anchor" aria-label="anchor" href="#sec-option-with"><i class="fas fa-link"></i></a>
</h2>
<p>注意 data.table 与 Base R 不同的地方</p>
<div class="sourceCode" id="cb360"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># https://github.com/Rdatatable/data.table/issues/4513</span>
<span class="co"># https://d.cosx.org/d/421532-datatable-base-r</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb361"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## [1]  TRUE  TRUE FALSE FALSE FALSE</code></pre>
<p>需要使用 <code>with = FALSE</code> 选项</p>
<div class="sourceCode" id="cb363"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span>,
  with <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8</code></pre>
<p>不使用 with 选项，用函数 <code><a href="https://rdrr.io/r/base/get.html">mget()</a></code> 将字符串转变量</p>
<div class="sourceCode" id="cb365"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span>
  <span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/get.html">mget</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8</code></pre>
<p>更加 data.table 风格的方式见</p>
<div class="sourceCode" id="cb367"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span>, <span class="va">.SD</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/patterns.html">patterns</a></span><span class="op">(</span><span class="st">"Sepal"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width
## 1:          5.8         4.0
## 2:          5.7         4.4
## 3:          5.7         3.8</code></pre>
<p>with 还可以这样用，直接修改、添加一列</p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">z</span> <span class="op">&lt;</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></code></pre></div>
<pre><code>##    x y  z
## 7  7 1 50
## 8  8 1 65
## 65 5 7 74
## 14 4 2 20
## 37 7 4 65
## 5  5 1 26</code></pre>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, z <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_contour.html">geom_contour</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:with-op"></span>
<img src="data-manipulation_files/figure-html/with-op-1.png" alt="with 操作" width="672"><p class="caption">
图 5.7: with 操作
</p>
</div>
</div>
<div id="sec-aggregate" class="section level2" number="5.17">
<h2>
<span class="header-section-number">5.17</span> 分组聚合<a class="anchor" aria-label="anchor" href="#sec-aggregate"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="st">"aggregate"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] aggregate.data.frame aggregate.default*   aggregate.formula*  
## [4] aggregate.ts        
## see '?methods' for accessing help and source code</code></pre>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="st">"aggregate.data.frame"</span><span class="op">)</span></code></pre></div>
<pre><code>## function (x, by, FUN, ..., simplify = TRUE, drop = TRUE) 
## NULL</code></pre>
<div class="sourceCode" id="cb376"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="st">"aggregate.ts"</span><span class="op">)</span></code></pre></div>
<pre><code>## function (x, nfrequency = 1, FUN = sum, ndeltat = 1, ts.eps = getOption("ts.eps"), 
##     ...) 
## NULL</code></pre>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># getAnywhere(aggregate.formula)</span></code></pre></div>
<p>按 Species 分组，对 Sepal.Length 中大于平均值的数取平均</p>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Species</span>, <span class="va">iris</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##      Species Sepal.Length
## 1     setosa     5.313636
## 2 versicolor     6.375000
## 3  virginica     7.159091</code></pre>
<div class="sourceCode" id="cb381"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>

<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">z</span>, <span class="va">w</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3</code></pre>
<div class="sourceCode" id="cb383"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">mget</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"z"</span>, <span class="st">"w"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    z w x_sum y_sum
## 1: A a     4     2
## 2: B a     4     4
## 3: C a     4     6
## 4: A b     2     1
## 5: B b     2     2
## 6: C b     2     3</code></pre>
<p>shiny 前端传递字符串向量，借助 <code><a href="https://rdrr.io/r/base/get.html">mget()</a></code> 函数根据选择的变量分组统计计算，只有一个变量可以使用 <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> 传递变量给 data.table</p>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span>
      <span class="fl">6</span>,
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span><span class="st">"input_vars"</span>,
        label <span class="op">=</span> <span class="st">"变量"</span>, <span class="co"># 给筛选框取名</span>
        choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>z <span class="op">=</span> <span class="st">"z"</span>, w <span class="op">=</span> <span class="st">"w"</span><span class="op">)</span>, <span class="co"># 待选的值</span>
        selected <span class="op">=</span> <span class="st">"z"</span>, <span class="co"># 指定默认值</span>
        multiple <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># 允许多选</span>
      <span class="op">)</span>,
      <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">dataTableOutput</a></span><span class="op">(</span><span class="st">"output_table"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>

<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">output</span><span class="op">$</span><span class="va">output_table</span> <span class="op">&lt;-</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">renderDataTable</a></span><span class="op">(</span>
    <span class="op">{</span>
      <span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">mget</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">input_vars</span><span class="op">)</span><span class="op">]</span> |&gt;
        <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>,
    server <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># 执行</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></code></pre></div>
</div>
<div id="sec-merge-two-tables" class="section level2" number="5.18">
<h2>
<span class="header-section-number">5.18</span> 合并操作<a class="anchor" aria-label="anchor" href="#sec-merge-two-tables"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb386"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span>, z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">dat1</span>, z <span class="op">=</span> <span class="va">dat2</span><span class="op">$</span><span class="va">z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">$</span><span class="va">x</span>, <span class="va">dat2</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6</code></pre>
<div class="sourceCode" id="cb388"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">dat2</span><span class="op">)</span></code></pre></div>
<pre><code>##    x y z
## 1  0 1 3
## 2  0 1 3
## 3 10 2 4
## 4 10 2 4
## 5 20 3 5
## 6 20 3 5
## 7 30 4 6
## 8 30 4 6</code></pre>
<p>保留两个数据集中的所有行</p>
</div>
<div id="sec-reshape" class="section level2" number="5.19">
<h2>
<span class="header-section-number">5.19</span> 长宽转换<a class="anchor" aria-label="anchor" href="#sec-reshape"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb390"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/args.html">args</a></span><span class="op">(</span><span class="st">"reshape"</span><span class="op">)</span></code></pre></div>
<pre><code>## function (data, varying = NULL, v.names = NULL, timevar = "time", 
##     idvar = "id", ids = 1L:NROW(data), times = seq_along(varying[[1L]]), 
##     drop = NULL, direction, new.row.names = NULL, sep = ".", 
##     split = if (sep == "") {
##         list(regexp = "[A-Za-z][0-9]", include = TRUE)
##     } else {
##         list(regexp = sep, include = FALSE, fixed = TRUE)
##     }) 
## NULL</code></pre>
<p>PlantGrowth 数据集的重塑操作也可以使用内置的函数 <code><a href="https://rdrr.io/r/stats/reshape.html">reshape()</a></code> 实现</p>
<div class="sourceCode" id="cb392"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PlantGrowth</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">PlantGrowth</span>, idvar <span class="op">=</span> <span class="st">"group"</span>, v.names <span class="op">=</span> <span class="st">"weight"</span>,
  timevar <span class="op">=</span> <span class="st">"id"</span>, direction <span class="op">=</span> <span class="st">"wide"</span>,
  sep <span class="op">=</span> <span class="st">""</span>
<span class="op">)</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">dat</span>,
  caption <span class="op">=</span> <span class="st">"不同生长环境下植物的干重"</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>,
  col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(weight)"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span>,
  align <span class="op">=</span> <span class="st">"c"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:data-frame-PlantGrowth">表 5.2: </span>不同生长环境下植物的干重</caption>
<thead><tr class="header">
<th align="center">group</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
<th align="center">4</th>
<th align="center">5</th>
<th align="center">6</th>
<th align="center">7</th>
<th align="center">8</th>
<th align="center">9</th>
<th align="center">10</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">ctrl</td>
<td align="center">4.17</td>
<td align="center">5.58</td>
<td align="center">5.18</td>
<td align="center">6.11</td>
<td align="center">4.50</td>
<td align="center">4.61</td>
<td align="center">5.17</td>
<td align="center">4.53</td>
<td align="center">5.33</td>
<td align="center">5.14</td>
</tr>
<tr class="even">
<td align="center">trt1</td>
<td align="center">4.81</td>
<td align="center">4.17</td>
<td align="center">4.41</td>
<td align="center">3.59</td>
<td align="center">5.87</td>
<td align="center">3.83</td>
<td align="center">6.03</td>
<td align="center">4.89</td>
<td align="center">4.32</td>
<td align="center">4.69</td>
</tr>
<tr class="odd">
<td align="center">trt2</td>
<td align="center">6.31</td>
<td align="center">5.12</td>
<td align="center">5.54</td>
<td align="center">5.50</td>
<td align="center">5.37</td>
<td align="center">5.29</td>
<td align="center">4.92</td>
<td align="center">6.15</td>
<td align="center">5.80</td>
<td align="center">5.26</td>
</tr>
</tbody>
</table></div>
<p>或者，我们也可以使用 <strong>tidyr</strong> 包提供的 <code>pivot_wider()</code> 函数</p>
<div class="sourceCode" id="cb393"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">PlantGrowth</span>, id_cols <span class="op">=</span> <span class="va">id</span>,
  names_from <span class="op">=</span> <span class="va">group</span>, values_from <span class="op">=</span> <span class="va">weight</span>
<span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
##       id  ctrl  trt1  trt2
##    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     1  4.17  4.81  6.31
##  2     2  5.58  4.17  5.12
##  3     3  5.18  4.41  5.54
##  4     4  6.11  3.59  5.5 
##  5     5  4.5   5.87  5.37
##  6     6  4.61  3.83  5.29
##  7     7  5.17  6.03  4.92
##  8     8  4.53  4.89  6.15
##  9     9  5.33  4.32  5.8 
## 10    10  5.14  4.69  5.26</code></pre>
<p>或者，我们还可以使用 <strong>data.table</strong> 包提供的 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast()</a></code> 函数，用于将长格式的数据框重塑为宽格式的</p>
<div class="sourceCode" id="cb395"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PlantGrowth_DT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">PlantGrowth</span><span class="op">)</span>
<span class="co"># 纵</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">PlantGrowth_DT</span>, <span class="va">id</span> <span class="op">~</span> <span class="va">group</span>, value.var <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></code></pre></div>
<pre><code>##     id ctrl trt1 trt2
##  1:  1 4.17 4.81 6.31
##  2:  2 5.58 4.17 5.12
##  3:  3 5.18 4.41 5.54
##  4:  4 6.11 3.59 5.50
##  5:  5 4.50 5.87 5.37
##  6:  6 4.61 3.83 5.29
##  7:  7 5.17 6.03 4.92
##  8:  8 4.53 4.89 6.15
##  9:  9 5.33 4.32 5.80
## 10: 10 5.14 4.69 5.26</code></pre>
<div class="sourceCode" id="cb397"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 横</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">PlantGrowth_DT</span>, <span class="va">group</span> <span class="op">~</span> <span class="va">id</span>, value.var <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></code></pre></div>
<pre><code>##    group    1    2    3    4    5    6    7    8    9   10
## 1:  ctrl 4.17 5.58 5.18 6.11 4.50 4.61 5.17 4.53 5.33 5.14
## 2:  trt1 4.81 4.17 4.41 3.59 5.87 3.83 6.03 4.89 4.32 4.69
## 3:  trt2 6.31 5.12 5.54 5.50 5.37 5.29 4.92 6.15 5.80 5.26</code></pre>
</div>
<div id="sec-filter-columns" class="section level2" number="5.20">
<h2>
<span class="header-section-number">5.20</span> 对符合条件的列操作<a class="anchor" aria-label="anchor" href="#sec-filter-columns"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb399"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 数值型变量的列的位置</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">is.numeric</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
##            1            2            3            4</code></pre>
<div class="sourceCode" id="cb401"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">is.numeric</span><span class="op">)</span>, with <span class="op">=</span> <span class="cn">F</span><span class="op">]</span><span class="op">[</span><span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">7.5</span><span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:          7.6         3.0          6.6         2.1
## 2:          7.7         3.8          6.7         2.2
## 3:          7.7         2.6          6.9         2.3
## 4:          7.7         2.8          6.7         2.0
## 5:          7.9         3.8          6.4         2.0
## 6:          7.7         3.0          6.1         2.3</code></pre>
<div class="sourceCode" id="cb403"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "data.table" "data.frame"</code></pre>
<p>用 Base R 提供的管道符号 |&gt; 将 data.table 数据操作与 ggplot2 数据可视化连接起来</p>
<div class="sourceCode" id="cb405"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">iris</span> |&gt;
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span> <span class="op">&amp;</span> <span class="va">Sepal.Length</span> <span class="op">&gt;</span> <span class="fl">5.5</span><span class="op">)</span> |&gt;
  <span class="co"># 行过滤</span>
  <span class="co"># subset(select = grep("Sepal", colnames(iris), value = TRUE)) |&gt; # 列过滤</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sepal.Length</span>, y <span class="op">=</span> <span class="va">Sepal.Width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># 绘图</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pipe-dataframe-ggplot2"></span>
<img src="data-manipulation_files/figure-html/pipe-dataframe-ggplot2-1.png" alt="管道连接数据操作和可视化" width="672"><p class="caption">
图 5.8: 管道连接数据操作和可视化
</p>
</div>
</div>
<div id="sec-case-when" class="section level2" number="5.21">
<h2>
<span class="header-section-number">5.21</span> <code>CASE WHEN</code> 和 <code>fcase</code><a class="anchor" aria-label="anchor" href="#sec-case-when"><i class="fas fa-link"></i></a>
</h2>
<p><code>CASE WHEN</code> 是 SQL 中的条件判断语句，<strong>data.table</strong> 中的函数 <code><a href="https://Rdatatable.gitlab.io/data.table/reference/fcase.html">fcase()</a></code> 可与之等价。值得注意的是，<code><a href="https://Rdatatable.gitlab.io/data.table/reference/fcase.html">fcase()</a></code> 需要 <strong>data.table</strong> 版本 1.13.0 及以上。</p>
<div class="sourceCode" id="cb406"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">56.8</span>, <span class="fl">57.2</span>, <span class="fl">46.3</span>, <span class="fl">38.5</span><span class="op">)</span>,
  gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"0"</span>, <span class="st">""</span>, <span class="st">"0"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># 1 表示男，0表示女，空表示未知</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transform.data.table.html">transform</a></span><span class="op">(</span><span class="va">dat</span>, gender_cn <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fcase.html">fcase</a></span><span class="op">(</span>
  <span class="va">gender</span> <span class="op">==</span> <span class="st">"1"</span>, <span class="st">"男"</span>,
  <span class="va">gender</span> <span class="op">==</span> <span class="st">"0"</span>, <span class="st">"女"</span>,
  <span class="va">gender</span> <span class="op">==</span> <span class="st">""</span>, <span class="st">"未知"</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    weights gender gender_cn
## 1:    56.8      1        男
## 2:    57.2      0        女
## 3:    46.3             未知
## 4:    38.5      0        女</code></pre>
</div>
<div id="sec-datatable-in-action" class="section level2" number="5.22">
<h2>
<span class="header-section-number">5.22</span> 数据操作实战<a class="anchor" aria-label="anchor" href="#sec-datatable-in-action"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://tdhock.github.io/">Toby Dylan Hocking</a> 在 useR! 2020 大会上分享的幻灯片 <a href="https://github.com/tdhock/r-devel-emails" class="uri">https://github.com/tdhock/r-devel-emails</a></p>
</div>
<div id="sec-faq-operations" class="section level2" number="5.23">
<h2>
<span class="header-section-number">5.23</span> 高频数据操作<a class="anchor" aria-label="anchor" href="#sec-faq-operations"><i class="fas fa-link"></i></a>
</h2>
<p>以数据集 dat 为例介绍常用的数据操作</p>
<div class="sourceCode" id="cb408"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  num_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, num_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
  group_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">16</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
  group_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">16</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="va">dat</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     1     1       c       B
##  2:     1     2       b       B
##  3:     1     3       a       B
##  4:     1     4       a       C
##  5:     2     1       b       B
##  6:     2     2       b       C
##  7:     2     3       a       B
##  8:     2     4       a       A
##  9:     3     1       b       C
## 10:     3     2       b       B
## 11:     3     3       b       B
## 12:     3     4       a       B
## 13:     4     1       b       C
## 14:     4     2       c       B
## 15:     4     3       b       C
## 16:     4     4       a       C</code></pre>
<div id="subsec-reduce-merge" class="section level3" number="5.23.1">
<h3>
<span class="header-section-number">5.23.1</span> 循环合并<a class="anchor" aria-label="anchor" href="#subsec-reduce-merge"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>问题来源 <a href="https://github.com/Rdatatable/data.table/issues/599">Faster version of Reduce(merge, list(DT1,DT2,DT3,…)) called mergelist (a la rbindlist)</a>
</li>
</ul>
</div>
<div id="subsec-count-by-group" class="section level3" number="5.23.2">
<h3>
<span class="header-section-number">5.23.2</span> 分组计数<a class="anchor" aria-label="anchor" href="#subsec-count-by-group"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb410"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span><span class="op">)</span><span class="op">]</span> <span class="co"># dat[, .N , by = .(group_a)]</span></code></pre></div>
<pre><code>##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6</code></pre>
<div class="sourceCode" id="cb412"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_b</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_b V1
## 1:       B  9
## 2:       C  6
## 3:       A  1</code></pre>
<div class="sourceCode" id="cb414"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span>, <span class="va">group_b</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_a group_b V1
## 1:       c       B  2
## 2:       b       B  4
## 3:       a       B  3
## 4:       a       C  2
## 5:       b       C  4
## 6:       a       A  1</code></pre>
</div>
<div id="subsec-sample-by-group" class="section level3" number="5.23.3">
<h3>
<span class="header-section-number">5.23.3</span> 分组抽样<a class="anchor" aria-label="anchor" href="#subsec-sample-by-group"><i class="fas fa-link"></i></a>
</h3>
<p>以 <code>group_a</code> 为组别， a、 b、 c 分别有 6、 8、 2 条记录</p>
<div class="sourceCode" id="cb416"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 无放回的抽样</span>
<span class="va">dt_sample_1</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.N</span>, size <span class="op">=</span> <span class="fl">2</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">group_a</span><span class="op">]</span>
<span class="co"># 有放回的随机抽样</span>
<span class="va">dt_sample_2</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.N</span>, size <span class="op">=</span> <span class="fl">3</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">group_a</span><span class="op">]</span></code></pre></div>
<p>可能存在该组样本不平衡，有的组的样本量不足你想要的样本量。每个组无放回地抽取 4 个样本，如果该组样本量不足 4，则全部抽取全部样本量。</p>
<div class="sourceCode" id="cb417"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.N</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">4</span>, <span class="va">.N</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">group_a</span><span class="op">]</span></code></pre></div>
<pre><code>##     group_a num_a num_b group_b
##  1:       c     1     1       B
##  2:       c     4     2       B
##  3:       b     3     2       B
##  4:       b     2     2       C
##  5:       b     2     1       B
##  6:       b     3     3       B
##  7:       a     1     3       B
##  8:       a     2     3       B
##  9:       a     2     4       A
## 10:       a     1     4       C</code></pre>
<p>还可以按照指定的比例抽取样本量 <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://stackoverflow.com/questions/18258690/take-randomly-sample-based-on-groups" class="uri"&gt;https://stackoverflow.com/questions/18258690/take-randomly-sample-based-on-groups&lt;/a&gt;&lt;/p&gt;'><sup>9</sup></a></p>
</div>
<div id="subsec-order-by-group" class="section level3" number="5.23.4">
<h3>
<span class="header-section-number">5.23.4</span> 分组排序<a class="anchor" aria-label="anchor" href="#subsec-order-by-group"><i class="fas fa-link"></i></a>
</h3>
<p>data.table 包的分组排序问题 <a href="https://d.cosx.org/d/421650-datatable/3" class="uri">https://d.cosx.org/d/421650-datatable/3</a></p>
<div class="sourceCode" id="cb419"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">num_a</span>, <span class="va">group_a</span>, FUN <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, <span class="op">-</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     4     1       b       C
##  2:     4     2       c       B
##  3:     4     3       b       C
##  4:     4     4       a       C
##  5:     3     1       b       C
##  6:     3     2       b       B
##  7:     3     3       b       B
##  8:     3     4       a       B
##  9:     2     1       b       B
## 10:     2     2       b       C
## 11:     2     3       a       B
## 12:     2     4       a       A
## 13:     1     1       c       B
## 14:     1     2       b       B
## 15:     1     3       a       B
## 16:     1     4       a       C</code></pre>
<div class="sourceCode" id="cb421"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># num_a 降序排列，然后对 group_a 升序排列</span>
<span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">num_a</span>, <span class="va">group_a</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B</code></pre>
<div class="sourceCode" id="cb423"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 简写</span>
<span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">num_a</span>, <span class="va">group_a</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##     num_a num_b group_a group_b
##  1:     4     4       a       C
##  2:     4     1       b       C
##  3:     4     3       b       C
##  4:     4     2       c       B
##  5:     3     4       a       B
##  6:     3     1       b       C
##  7:     3     2       b       B
##  8:     3     3       b       B
##  9:     2     3       a       B
## 10:     2     4       a       A
## 11:     2     1       b       B
## 12:     2     2       b       C
## 13:     1     3       a       B
## 14:     1     4       a       C
## 15:     1     2       b       B
## 16:     1     1       c       B</code></pre>
<p><code><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder()</a></code> 函数直接修改原始数据记录的排序</p>
<div class="sourceCode" id="cb425"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">dat</span>, <span class="op">-</span><span class="va">num_a</span>, <span class="va">group_a</span><span class="op">)</span></code></pre></div>
<p>参考多个列分组排序 <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns" class="uri"&gt;https://stackoverflow.com/questions/1296646/how-to-sort-a-dataframe-by-multiple-columns&lt;/a&gt;&lt;/p&gt;'><sup>10</sup></a></p>
<div class="rmdtip">
<p>如果数据集 dat 包含缺失值，考虑去掉缺失值</p>
<div class="sourceCode" id="cb426"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_a V1
## 1:       c  2
## 2:       b  8
## 3:       a  6</code></pre>
<p>如果数据集 dat 包含重复值，考虑去掉重复值</p>
<div class="sourceCode" id="cb428"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">num_a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_a</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    group_a V1
## 1:       c  2
## 2:       b  4
## 3:       a  4</code></pre>
</div>
<p>按 Species 分组，对 Sepal.Length 降序排列，取 Top 3</p>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">]</span></code></pre></div>
<pre><code>##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3</code></pre>
<p>对 iris 各个列排序</p>
<div class="sourceCode" id="cb432"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="st">"order"</span>, args <span class="op">=</span> <span class="va">dat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">dat</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.6         3.1          1.5         0.2  setosa
## 2:          4.7         3.2          1.3         0.2  setosa
## 3:          4.9         3.0          1.4         0.2  setosa
## 4:          5.0         3.6          1.4         0.2  setosa
## 5:          5.1         3.5          1.4         0.2  setosa
## 6:          5.4         3.9          1.7         0.4  setosa</code></pre>
<p>按 Species 分组，对 Sepal.Length 降序排列，取 Top 3</p>
<div class="sourceCode" id="cb434"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iris</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="va">.SD</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, by<span class="op">=</span><span class="st">"Species"</span><span class="op">]</span></code></pre></div>
<pre><code>##       Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1:  virginica          7.9         3.8          6.4         2.0
## 2:  virginica          7.7         3.8          6.7         2.2
## 3:  virginica          7.7         2.6          6.9         2.3
## 4: versicolor          7.0         3.2          4.7         1.4
## 5: versicolor          6.9         3.1          4.9         1.5
## 6: versicolor          6.8         2.8          4.8         1.4
## 7:     setosa          5.8         4.0          1.2         0.2
## 8:     setosa          5.7         4.4          1.5         0.4
## 9:     setosa          5.7         3.8          1.7         0.3</code></pre>
<p>对 iris 各个列排序，依次对第 5、1、2、3 列升序排列</p>
<div class="sourceCode" id="cb436"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="st">"order"</span>, args <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1:          4.3         3.0          1.1         0.1  setosa
## 2:          4.4         2.9          1.4         0.2  setosa
## 3:          4.4         3.0          1.3         0.2  setosa
## 4:          4.4         3.2          1.3         0.2  setosa
## 5:          4.5         2.3          1.3         0.3  setosa
## 6:          4.6         3.1          1.5         0.2  setosa</code></pre>
<div class="inline-table"><table class="kable_wrapper">
<caption>
<span id="tab:column-order">表 5.3: </span>iris 数据集原顺序（左）和新顺序（右）
</caption>
<tbody><tr>
<td>
<table class="table table-sm">
<thead><tr class="header">
<th align="right">Sepal.Length</th>
<th align="right">Sepal.Width</th>
<th align="right">Petal.Length</th>
<th align="right">Petal.Width</th>
<th align="left">Species</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">5.1</td>
<td align="right">3.5</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.9</td>
<td align="right">3.0</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.7</td>
<td align="right">3.2</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.6</td>
<td align="right">3.1</td>
<td align="right">1.5</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">5.0</td>
<td align="right">3.6</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">5.4</td>
<td align="right">3.9</td>
<td align="right">1.7</td>
<td align="right">0.4</td>
<td align="left">setosa</td>
</tr>
</tbody>
</table>
</td>
<td>
<table class="table table-sm">
<thead><tr class="header">
<th align="right">Sepal.Length</th>
<th align="right">Sepal.Width</th>
<th align="right">Petal.Length</th>
<th align="right">Petal.Width</th>
<th align="left">Species</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">4.3</td>
<td align="right">3.0</td>
<td align="right">1.1</td>
<td align="right">0.1</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.4</td>
<td align="right">2.9</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.4</td>
<td align="right">3.0</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.4</td>
<td align="right">3.2</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.5</td>
<td align="right">2.3</td>
<td align="right">1.3</td>
<td align="right">0.3</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.6</td>
<td align="right">3.1</td>
<td align="right">1.5</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
</tbody>
</table>
</td>
</tr></tbody>
</table></div>
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-data-structure.html"><span class="header-section-number">4</span> 数据结构</a></div>
<div class="next"><a href="chap-data-transportation.html"><span class="header-section-number">6</span> 数据搬运</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-data-manipulation"><span class="header-section-number">5</span> 数据操作</a></li>
<li><a class="nav-link" href="#dm-view"><span class="header-section-number">5.1</span> 查看数据</a></li>
<li><a class="nav-link" href="#dm-subset"><span class="header-section-number">5.2</span> 提取子集</a></li>
<li><a class="nav-link" href="#dm-reshape"><span class="header-section-number">5.3</span> 数据重塑</a></li>
<li><a class="nav-link" href="#dm-transform"><span class="header-section-number">5.4</span> 数据转换</a></li>
<li><a class="nav-link" href="#dm-order"><span class="header-section-number">5.5</span> 按列排序</a></li>
<li><a class="nav-link" href="#dm-split"><span class="header-section-number">5.6</span> 数据拆分</a></li>
<li><a class="nav-link" href="#dm-merge"><span class="header-section-number">5.7</span> 数据合并</a></li>
<li><a class="nav-link" href="#dm-duplicated"><span class="header-section-number">5.8</span> 数据去重</a></li>
<li><a class="nav-link" href="#dm-missing"><span class="header-section-number">5.9</span> 数据缺失</a></li>
<li><a class="nav-link" href="#dm-aggregate"><span class="header-section-number">5.10</span> 数据聚合</a></li>
<li><a class="nav-link" href="#dm-table"><span class="header-section-number">5.11</span> 表格统计</a></li>
<li><a class="nav-link" href="#dm-index"><span class="header-section-number">5.12</span> 索引访问</a></li>
<li><a class="nav-link" href="#dm-array"><span class="header-section-number">5.13</span> 多维数组</a></li>
<li>
<a class="nav-link" href="#dm-others"><span class="header-section-number">5.14</span> 其它操作</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#relist-or-unlist"><span class="header-section-number">5.14.1</span> 列表属性</a></li>
<li><a class="nav-link" href="#stack-or-unstack"><span class="header-section-number">5.14.2</span> 堆叠向量</a></li>
<li><a class="nav-link" href="#class-or-unclass"><span class="header-section-number">5.14.3</span> 属性转化</a></li>
<li><a class="nav-link" href="#attach-or-detach"><span class="header-section-number">5.14.4</span> 绑定环境</a></li>
<li><a class="nav-link" href="#with-or-within"><span class="header-section-number">5.14.5</span> 数据环境</a></li>
</ul>
</li>
<li><a class="nav-link" href="#dm-apply-family"><span class="header-section-number">5.15</span> apply 族</a></li>
<li><a class="nav-link" href="#sec-option-with"><span class="header-section-number">5.16</span> with 选项</a></li>
<li><a class="nav-link" href="#sec-aggregate"><span class="header-section-number">5.17</span> 分组聚合</a></li>
<li><a class="nav-link" href="#sec-merge-two-tables"><span class="header-section-number">5.18</span> 合并操作</a></li>
<li><a class="nav-link" href="#sec-reshape"><span class="header-section-number">5.19</span> 长宽转换</a></li>
<li><a class="nav-link" href="#sec-filter-columns"><span class="header-section-number">5.20</span> 对符合条件的列操作</a></li>
<li><a class="nav-link" href="#sec-case-when"><span class="header-section-number">5.21</span> CASE WHEN 和 fcase</a></li>
<li><a class="nav-link" href="#sec-datatable-in-action"><span class="header-section-number">5.22</span> 数据操作实战</a></li>
<li>
<a class="nav-link" href="#sec-faq-operations"><span class="header-section-number">5.23</span> 高频数据操作</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#subsec-reduce-merge"><span class="header-section-number">5.23.1</span> 循环合并</a></li>
<li><a class="nav-link" href="#subsec-count-by-group"><span class="header-section-number">5.23.2</span> 分组计数</a></li>
<li><a class="nav-link" href="#subsec-sample-by-group"><span class="header-section-number">5.23.3</span> 分组抽样</a></li>
<li><a class="nav-link" href="#subsec-order-by-group"><span class="header-section-number">5.23.4</span> 分组排序</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/masr/blob/master/data-manipulation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/masr/edit/master/data-manipulation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>现代应用统计与 R 语言</strong>" was written by 黄湘云. It was last built on 2021-08-07.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
