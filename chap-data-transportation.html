<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 6 章 数据搬运 | 现代应用统计与 R 语言</title>
<meta name="author" content="黄湘云">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs/header-attrs.js"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><script src="libs/proj4js/proj4.js"></script><link href="libs/highcharts/css/motion.css" rel="stylesheet">
<script src="libs/highcharts/highcharts.js"></script><script src="libs/highcharts/highcharts-3d.js"></script><script src="libs/highcharts/highcharts-more.js"></script><script src="libs/highcharts/modules/stock.js"></script><script src="libs/highcharts/modules/map.js"></script><script src="libs/highcharts/modules/annotations.js"></script><script src="libs/highcharts/modules/data.js"></script><script src="libs/highcharts/modules/drilldown.js"></script><script src="libs/highcharts/modules/item-series.js"></script><script src="libs/highcharts/modules/offline-exporting.js"></script><script src="libs/highcharts/modules/overlapping-datalabels.js"></script><script src="libs/highcharts/modules/exporting.js"></script><script src="libs/highcharts/modules/export-data.js"></script><script src="libs/highcharts/modules/funnel.js"></script><script src="libs/highcharts/modules/heatmap.js"></script><script src="libs/highcharts/modules/treemap.js"></script><script src="libs/highcharts/modules/sankey.js"></script><script src="libs/highcharts/modules/dependency-wheel.js"></script><script src="libs/highcharts/modules/organization.js"></script><script src="libs/highcharts/modules/solid-gauge.js"></script><script src="libs/highcharts/modules/streamgraph.js"></script><script src="libs/highcharts/modules/sunburst.js"></script><script src="libs/highcharts/modules/vector.js"></script><script src="libs/highcharts/modules/wordcloud.js"></script><script src="libs/highcharts/modules/xrange.js"></script><script src="libs/highcharts/modules/tilemap.js"></script><script src="libs/highcharts/modules/venn.js"></script><script src="libs/highcharts/modules/gantt.js"></script><script src="libs/highcharts/modules/timeline.js"></script><script src="libs/highcharts/modules/parallel-coordinates.js"></script><script src="libs/highcharts/modules/bullet.js"></script><script src="libs/highcharts/modules/coloraxis.js"></script><script src="libs/highcharts/modules/dumbbell.js"></script><script src="libs/highcharts/modules/lollipop.js"></script><script src="libs/highcharts/modules/series-label.js"></script><script src="libs/highcharts/plugins/motion.js"></script><script src="libs/highcharts/custom/reset.js"></script><script src="libs/highcharts/modules/boost.js"></script><script src="libs/highchart-binding/highchart.js"></script><script src="libs/es6shim/es6shim.js"></script><script src="libs/es7shim/es7shim.js"></script><script src="libs/graphre/graphre.js"></script><script src="libs/nomnoml/nomnoml.js"></script><script src="libs/nomnoml-binding/nomnoml.js"></script><script src="libs/plotly-locale-zh-CN/zh-cn.js"></script><script src="libs/mathjax/cdn.js"></script><link href="libs/dygraphs/dygraph.css" rel="stylesheet">
<script src="libs/dygraphs/dygraph-combined.js"></script><script src="libs/dygraphs/shapes.js"></script><script src="libs/moment/moment.js"></script><script src="libs/moment-timezone/moment-timezone-with-data.js"></script><script src="libs/moment-fquarter/moment-fquarter.min.js"></script><script src="libs/dygraphs-binding/dygraphs.js"></script><script src="libs/Dygraph.Plugins.Unzoom/unzoom.js"></script><script src="libs/echarts4r/echarts-en.min.js"></script><script src="libs/echarts4r/ecStat.min.js"></script><script src="libs/echarts4r/dataTool.min.js"></script><script src="libs/echarts4r-binding/echarts4r.js"></script><script src="libs/echarts-world/world.js"></script><script src="libs/d3/d3.min.js"></script><script src="libs/forceNetwork-binding/forceNetwork.js"></script><link href="libs/vis/vis.css" rel="stylesheet">
<script src="libs/vis/vis.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="libs/FileSaver/FileSaver.min.js"></script><script src="libs/Blob/Blob.js"></script><script src="libs/canvas-toBlob/canvas-toBlob.js"></script><script src="libs/html2canvas/html2canvas.js"></script><script src="libs/jspdf/jspdf.debug.js"></script><link href="libs/jquery-sparkline/jquery.sparkline.css" rel="stylesheet">
<script src="libs/jquery-sparkline/jquery.sparkline.js"></script><script src="libs/sparkline-binding/sparkline.js"></script><script src="libs/r2d3-render/r2d3-render.js"></script><script src="libs/webcomponents/webcomponents.js"></script><script src="libs/r2d3-binding/r2d3.js"></script><script src="libs/d3v6/d3.min.js"></script><link href="libs/datatables-css/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding/datatables.js"></script><link href="libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core/js/jquery.dataTables.min.js"></script><script src="libs/jszip/jszip.min.js"></script><script src="libs/pdfmake/pdfmake.js"></script><script src="libs/pdfmake/vfs_fonts.js"></script><link href="libs/dt-ext-buttons/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-buttons/js/dataTables.buttons.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.flash.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.html5.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.colVis.min.js"></script><script src="libs/dt-ext-buttons/js/buttons.print.min.js"></script><link href="libs/dt-ext-rowgroup/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="libs/dt-ext-rowgroup/js/dataTables.rowGroup.min.js"></script><script src="libs/kePrint/kePrint.js"></script><link href="libs/lightable/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-54GQKWF7VP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-54GQKWF7VP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">现代应用统计与 R 语言</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">欢迎</a></li>
<li><a class="" href="chap-preface.html"><span class="header-section-number">1</span> 前言</a></li>
<li><a class="" href="chap-notations.html"><span class="header-section-number">2</span> 符号说明</a></li>
<li><a class="" href="chap-file-operations.html"><span class="header-section-number">3</span> 文件操作</a></li>
<li><a class="" href="chap-data-structure.html"><span class="header-section-number">4</span> 数据结构</a></li>
<li><a class="" href="chap-data-manipulation.html"><span class="header-section-number">5</span> 数据操作</a></li>
<li><a class="active" href="chap-data-transportation.html"><span class="header-section-number">6</span> 数据搬运</a></li>
<li><a class="" href="chap-data-visualization.html"><span class="header-section-number">7</span> 数据可视化</a></li>
<li><a class="" href="chap-dynamic-documents.html"><span class="header-section-number">8</span> 动态文档</a></li>
<li><a class="" href="chap-interactive-web-graphics.html"><span class="header-section-number">9</span> 交互图形</a></li>
<li><a class="" href="chap-interactive-data-tables.html"><span class="header-section-number">10</span> 交互表格</a></li>
<li><a class="" href="chap-interactive-shiny-app.html"><span class="header-section-number">11</span> 交互报表</a></li>
<li><a class="" href="chap-string-operations.html"><span class="header-section-number">12</span> 字符串操作</a></li>
<li><a class="" href="chap-regular-expressions.html"><span class="header-section-number">13</span> 正则表达式</a></li>
<li><a class="" href="chap-text-analysis.html"><span class="header-section-number">14</span> 文本分析</a></li>
<li><a class="" href="chap-sampling-distributions.html"><span class="header-section-number">15</span> 抽样分布</a></li>
<li><a class="" href="chap-parameter-estimators.html"><span class="header-section-number">16</span> 参数估计</a></li>
<li><a class="" href="chap-hypothesis-test.html"><span class="header-section-number">17</span> 假设检验</a></li>
<li><a class="" href="chap-power-Analysis.html"><span class="header-section-number">18</span> 功效分析</a></li>
<li><a class="" href="chap-experimental-design.html"><span class="header-section-number">19</span> 试验设计</a></li>
<li><a class="" href="chap-linear-models.html"><span class="header-section-number">20</span> 线性模型</a></li>
<li><a class="" href="chap-generalized-linear-models.html"><span class="header-section-number">21</span> 广义线性模型</a></li>
<li><a class="" href="chap-case-study.html"><span class="header-section-number">22</span> 案例研究</a></li>
<li><a class="" href="chap-data-explorer.html"><span class="header-section-number">23</span> 数据探索</a></li>
<li><a class="" href="chap-survival-analysis.html"><span class="header-section-number">24</span> 生存分析</a></li>
<li><a class="" href="chap-time-series-analysis.html"><span class="header-section-number">25</span> 时序分析</a></li>
<li><a class="" href="chap-spatial-analysis.html"><span class="header-section-number">26</span> 空间分析</a></li>
<li><a class="" href="chap-spatial-modeling.html"><span class="header-section-number">27</span> 空间建模</a></li>
<li><a class="" href="chap-bayesian-models.html"><span class="header-section-number">28</span> 贝叶斯模型</a></li>
<li><a class="" href="chap-gradient-boosting-machine.html"><span class="header-section-number">29</span> 梯度提升机</a></li>
<li><a class="" href="chap-neural-network.html"><span class="header-section-number">30</span> 神经网络</a></li>
<li><a class="" href="chap-matrix-operations.html"><span class="header-section-number">31</span> 矩阵运算</a></li>
<li><a class="" href="chap-symbolic-computation.html"><span class="header-section-number">32</span> 符号计算</a></li>
<li><a class="" href="chap-numerical-optimization.html"><span class="header-section-number">33</span> 数值优化</a></li>
<li class="book-part">附录</li>
<li><a class="" href="chap-linux-command-bash.html"><span class="header-section-number">A</span> 命令行操作</a></li>
<li><a class="" href="chap-other-softwares.html"><span class="header-section-number">B</span> 其它软件</a></li>
<li><a class="" href="chap-mixed-programming.html"><span class="header-section-number">C</span> 混合编程</a></li>
<li><a class="" href="chap-object-oriented-programming.html"><span class="header-section-number">D</span> 面向对象编程</a></li>
<li><a class="" href="references.html">参考文献</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/XiangyunHuang/masr">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-data-transportation" class="section level1" number="6">
<h1>
<span class="header-section-number">第 6 章</span> 数据搬运<a class="anchor" aria-label="anchor" href="#chap-data-transportation"><i class="fas fa-link"></i></a>
</h1>
<p>美团使用的大数据工具有很多，最常用的 Hive、Spark、Kylin、Impala、Presto 等，详见 <a href="https://tech.meituan.com/2018/08/02/mt-r-practice.html" class="uri">https://tech.meituan.com/2018/08/02/mt-r-practice.html</a>。下面主要介绍如何在 R 中连接 MySQL、Presto 和 Spark。</p>
<p><a href="https://github.com/r-spark/sparklyr.flint">sparklyr.flint</a> 支持 Spark 的时间序列库 <a href="https://github.com/twosigma/flint">flint</a>，<a href="https://github.com/rstudio/sparkxgb">sparkxgb</a> 为 Spark 上的 XGBoost 提供 R 接口，<a href="https://github.com/r-spark/sparkwarc">sparkwarc</a> 支持加载 Web ARChive 文件到 Spark 里
<a href="https://github.com/chezou/sparkavro">sparkavro</a> 支持从 Apache Avro (<a href="https://avro.apache.org/" class="uri">https://avro.apache.org/</a>) 读取文件到 Spark 里，<a href="https://github.com/miraisolutions/sparkbq">sparkbq</a> 是一个 sparkly 扩展包，集成 Google BigQuery 服务，<a href="https://github.com/harryprince/geospark">geospark</a> 提供 GeoSpark 库的 R 接口，并且以 sf 的数据操作方式，<a href="https://github.com/h2oai/sparkling-water/tree/master/r">rsparkling</a> H2O Sparkling Water 机器学习库的 R 接口。</p>
<p>Spark 性能优化，参考三篇博文</p>
<ul>
<li><a href="https://tech.meituan.com/2016/03/31/spark-in-meituan.html">Spark在美团的实践</a></li>
<li><a href="https://tech.meituan.com/2016/04/29/spark-tuning-basic.html">Spark性能优化指南——基础篇</a></li>
<li><a href="https://tech.meituan.com/2016/05/12/spark-tuning-pro.html">Spark性能优化指南——高级篇</a></li>
</ul>
<p>其他材料</p>
<ul>
<li>朱俊晖收集的 Spark 资源列表 <a href="https://github.com/harryprince/awesome-sparklyr" class="uri">https://github.com/harryprince/awesome-sparklyr</a>，推荐使用 sparklyr <a href="https://github.com/sparklyr/sparklyr" class="uri">https://github.com/sparklyr/sparklyr</a> 连接 Spark</li>
<li>Spark 与 R 语言 <a href="https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/" class="uri">https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/</a>
</li>
<li>Mastering Spark with R <a href="https://therinspark.com/" class="uri">https://therinspark.com/</a>
</li>
</ul>
<div id="sec-spark-with-r" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> Spark 与 R 语言<a class="anchor" aria-label="anchor" href="#sec-spark-with-r"><i class="fas fa-link"></i></a>
</h2>
<div id="subsec-sparklyr" class="section level3" number="6.1.1">
<h3>
<span class="header-section-number">6.1.1</span> sparklyr<a class="anchor" aria-label="anchor" href="#subsec-sparklyr"><i class="fas fa-link"></i></a>
</h3>
<div class="rmdwarn">
<p>Spark 依赖特定版本的 Java、Hadoop，三者之间的版本应该要相融。</p>
</div>
<p>在 MacOS 上配置 Java 环境，注意 Spark 仅支持 Java 8 至 11，所以安装指定版本的 Java 开发环境</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb149-1"><a href="chap-data-transportation.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装 openjdk 11</span></span>
<span id="cb149-2"><a href="chap-data-transportation.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install openjdk@11</span>
<span id="cb149-3"><a href="chap-data-transportation.html#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 全局设置 JDK 11</span></span>
<span id="cb149-4"><a href="chap-data-transportation.html#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-sfn</span> /usr/local/opt/openjdk@11/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-11.jdk</span>
<span id="cb149-5"><a href="chap-data-transportation.html#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Java 11 JDK 添加到 .zshrc </span></span>
<span id="cb149-6"><a href="chap-data-transportation.html#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CPPFLAGS</span><span class="op">=</span><span class="st">"-I/usr/local/opt/openjdk@11/include"</span></span>
<span id="cb149-7"><a href="chap-data-transportation.html#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">"/usr/local/opt/openjdk@11/bin:</span><span class="va">$PATH</span><span class="st">"</span></span></code></pre></div>
<p>配置 R 环境，让 R 能够识别 Java 环境，再安装 <strong>rJava</strong> 包</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb150-1"><a href="chap-data-transportation.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 配置</span></span>
<span id="cb150-2"><a href="chap-data-transportation.html#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R CMD javareconf</span>
<span id="cb150-3"><a href="chap-data-transportation.html#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 系统软件依赖</span></span>
<span id="cb150-4"><a href="chap-data-transportation.html#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install pcre2</span>
<span id="cb150-5"><a href="chap-data-transportation.html#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装 rJava</span></span>
<span id="cb150-6"><a href="chap-data-transportation.html#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'install.packages("rJava", type="source")'</span></span></code></pre></div>
<p>最后安装 <strong>sparklyr</strong> 包，以及 Spark 环境，可以借助 <code><a href="https://rdrr.io/pkg/sparklyr/man/spark_install.html">spark_install()</a></code> 安装 Spark，比如下面 Spark 3.0 连同 hadoop 2.7 一起安装。</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'sparklyr'</span><span class="op">)</span>
<span class="fu">sparklyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark_install.html">spark_install</a></span><span class="op">(</span>version <span class="op">=</span> <span class="st">'3.0'</span>, hadoop_version <span class="op">=</span> <span class="st">'2.7'</span><span class="op">)</span></code></pre></div>
<p>也可以先手动下载 Spark 软件环境，建议选择就近镜像站点下载，比如在北京选择清华站点
<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz" class="uri">https://mirrors.tuna.tsinghua.edu.cn/apache/spark/spark-3.0.1/spark-3.0.1-bin-hadoop2.7.tgz</a>，此环境自带 R 和 Python 接口。为了供 sparklyr 调用，先设置 <code>SPARK_HOME</code> 环境变量指向 Spark 安装位置，再连接单机版 Spark。</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 排错 https://github.com/sparklyr/sparklyr/issues/2827</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>sparklyr.log.console <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># 连接 Spark </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.rstudio.com/">sparklyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html">spark_connect</a></span><span class="op">(</span>
  master <span class="op">=</span> <span class="st">"local"</span>,
  <span class="co"># config = list(sparklyr.gateway.address = "127.0.0.1"),</span>
  spark_home <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># diamonds 数据集导入 Spark</span>
<span class="va">diamonds_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/copy_to.html">copy_to</a></span><span class="op">(</span><span class="va">sc</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span>, <span class="st">"diamonds"</span><span class="op">)</span></code></pre></div>
<p>做数据的聚合统计，有两种方式。一种是使用用 R 包 dplyr 提供的数据操作语法，下面以按 cut 分组统计钻石的数量为例，说明 dplyr 提供的数据操作方式。</p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co"># 列出数据源下所有的表 tbls</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/src_tbls.html">src_tbls</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span>

<span class="va">diamonds_tbl</span> <span class="op">&lt;-</span> <span class="va">diamonds_tbl</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cut</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>cnt <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">collect</span></code></pre></div>
<p>另一种是使用结构化查询语言 SQL，这自不必说，大多数情况下，使用和一般的 SQL 没什么两样。</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="va">diamonds_preview</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT count(*) as cnt, cut FROM diamonds GROUP BY cut"</span><span class="op">)</span>
<span class="va">diamonds_preview</span></code></pre></div>
<pre><code>##     cnt       cut
## 1 21551     Ideal
## 2 13791   Premium
## 3  4906      Good
## 4  1610      Fair
## 5 12082 Very Good</code></pre>
<div class="columns">
<div class="column" style="width:47.5%;">
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># SQL 中的 AVG 和 R 中的 mean 函数是类似的</span>
<span class="va">diamonds_price</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT AVG(price) as mean_price, cut FROM diamonds GROUP BY cut"</span><span class="op">)</span>
<span class="va">diamonds_price</span></code></pre></div>
<pre><code>##   mean_price       cut
## 1   3457.542     Ideal
## 2   4584.258   Premium
## 3   3928.864      Good
## 4   4358.758      Fair
## 5   3981.760 Very Good</code></pre>
</div>
<div class="column" style="width:5%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div>
<div class="column" style="width:47.5%;">
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">diamonds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>
<span class="va">diamonds</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>mean_price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">price</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cut</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##          cut mean_price
## 1:     Ideal   3457.542
## 2:   Premium   4584.258
## 3:      Good   3928.864
## 4: Very Good   3981.760
## 5:      Fair   4358.758</code></pre>
</div>
</div>
<p>将结果数据用 ggplot2 呈现出来</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">diamonds_preview</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">cnt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="data-transportation_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></div>
<p>diamonds 数据集总共 53940 条数据，下面用 BUCKET 分桶抽样，将原数据随机分成 1000 个桶，取其中的一个桶，由于是随机分桶，所以每次的结果都不一样，解释详见<a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-sampling.html" class="uri">https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-sampling.html</a></p>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT * FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000) LIMIT 6"</span><span class="op">)</span>
<span class="va">diamonds_sample</span></code></pre></div>
<pre><code>##   carat       cut color clarity depth table price    x    y    z
## 1  1.02     Ideal     I      I1  61.7    56  2872 6.44 6.49 3.99
## 2  0.80     Ideal     E     SI2  61.0    55  2978 6.00 6.03 3.67
## 3  0.36     Ideal     H     VS2  62.1    55   568 4.57 4.58 2.84
## 4  1.51      Good     G      I1  64.0    59  3497 7.29 7.17 4.63
## 5  1.00      Good     H     SI2  63.9    55  3878 6.25 6.33 4.02
## 6  0.91 Very Good     H     VS1  62.7    63  3881 6.10 6.03 3.80</code></pre>
<p>将抽样的结果用窗口函数 <code>RANK()</code> 排序，详见 <a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html" class="uri">https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html</a></p>
<p>窗口函数 <a href="https://www.cnblogs.com/ZackSun/p/9713435.html" class="uri">https://www.cnblogs.com/ZackSun/p/9713435.html</a></p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diamonds_rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"
  SELECT cut, price, RANK() OVER (PARTITION BY cut ORDER BY price) AS rank 
  FROM diamonds TABLESAMPLE (BUCKET 1 OUT OF 1000)
  LIMIT 6
"</span><span class="op">)</span>
<span class="va">diamonds_rank</span></code></pre></div>
<pre><code>##    cut price rank
## 1 Fair  2359    1
## 2 Fair  5624    2
## 3 Good   447    1
## 4 Good  1119    2
## 5 Good  2401    3
## 6 Good  2516    4</code></pre>
<p>LATERAL VIEW 把一列拆成多行</p>
<p><a href="https://liam.page/2020/03/09/LATERAL-VIEW-in-Hive-SQL/" class="uri">https://liam.page/2020/03/09/LATERAL-VIEW-in-Hive-SQL/</a>
<a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-lateral-view.html" class="uri">https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-lateral-view.html</a></p>
<p>创建数据集</p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 先删除存在的表 person</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"DROP TABLE IF EXISTS person"</span><span class="op">)</span>
<span class="co"># 创建表 person</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"CREATE TABLE IF NOT EXISTS person (id INT, name STRING, age INT, class INT, address STRING)"</span><span class="op">)</span>
<span class="co"># 插入数据到表 person</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"
INSERT INTO person VALUES
    (100, 'John', 30, 1, 'Street 1'),
    (200, 'Mary', NULL, 1, 'Street 2'),
    (300, 'Mike', 80, 3, 'Street 3'),
    (400, 'Dan', 50, 4, 'Street 4')
"</span><span class="op">)</span></code></pre></div>
<p>查看数据集</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"SELECT * FROM person"</span><span class="op">)</span></code></pre></div>
<pre><code>##    id name age class  address
## 1 100 John  30     1 Street 1
## 2 200 Mary  NA     1 Street 2
## 3 300 Mike  80     3 Street 3
## 4 400  Dan  50     4 Street 4</code></pre>
<p>行列转换 <a href="https://www.cnblogs.com/kimbo/p/6208973.html" class="uri">https://www.cnblogs.com/kimbo/p/6208973.html</a>，LATERAL VIEW 展开</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>,<span class="st">"
SELECT * FROM person
    LATERAL VIEW EXPLODE(ARRAY(30, 60)) tabelName AS c_age
    LATERAL VIEW EXPLODE(ARRAY(40, 80)) AS d_age
LIMIT 6
"</span><span class="op">)</span></code></pre></div>
<pre><code>##    id name age class  address c_age d_age
## 1 100 John  30     1 Street 1    30    40
## 2 100 John  30     1 Street 1    30    80
## 3 100 John  30     1 Street 1    60    40
## 4 100 John  30     1 Street 1    60    80
## 5 200 Mary  NA     1 Street 2    30    40
## 6 200 Mary  NA     1 Street 2    30    80</code></pre>
<p>日期相关的函数 <a href="https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#date-and-timestamp-functions" class="uri">https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#date-and-timestamp-functions</a></p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 今天</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select current_date"</span><span class="op">)</span></code></pre></div>
<pre><code>##   current_date()
## 1     2021-08-07</code></pre>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 昨天</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select date_sub(current_date, 1)"</span><span class="op">)</span></code></pre></div>
<pre><code>##   date_sub(current_date(), 1)
## 1                  2021-08-06</code></pre>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 本月最后一天 current_date 所属月份的最后一天</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select last_day(current_date)"</span><span class="op">)</span></code></pre></div>
<pre><code>##   last_day(current_date())
## 1               2021-08-31</code></pre>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 星期几</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"select dayofweek(current_date)"</span><span class="op">)</span></code></pre></div>
<pre><code>##   dayofweek(current_date())
## 1                         7</code></pre>
<p>最后，使用完记得关闭 Spark 连接</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html">spark_disconnect</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span></code></pre></div>
</div>
<div id="subsec-sparkr" class="section level3" number="6.1.2">
<h3>
<span class="header-section-number">6.1.2</span> SparkR<a class="anchor" aria-label="anchor" href="#subsec-sparkr"><i class="fas fa-link"></i></a>
</h3>
<div class="rmdnote">
<p>考虑到和第<a href="chap-data-transportation.html#subsec-sparklyr">6.1.1</a>节的重合性，以及 sparklyr 的优势，本节代码都不会执行，仅作为补充信息予以描述。完整的介绍见 <a href="https://spark.apache.org/docs/latest/sparkr.html#running-sql-queries-from-sparkr">SparkR 包</a></p>
</div>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>SPARK_HOME <span class="op">=</span> <span class="st">"/opt/spark/spark-3.0.1-bin-hadoop2.7"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SparkR</span>, lib.loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPARK_HOME"</span><span class="op">)</span>, <span class="st">"R"</span>, <span class="st">"lib"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">sparkR.session</span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local[*]"</span>, sparkConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>spark.driver.memory <span class="op">=</span> <span class="st">"2g"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="rmdwarn">
<p><strong>SparkR</strong> 要求 Java 版本满足：大于等于8，而小于12，本地 MacOS 安装高版本，比如 oracle-jdk 16.0.1 会报不兼容的错误。</p>
<pre><code>Spark package found in SPARK_HOME: /opt/spark/spark-3.1.1-bin-hadoop3.2
Error in checkJavaVersion() : 
  Java version, greater than or equal to 8 and less than 12, is required for this package; found version: 16.0.1</code></pre>
</div>
<p><code>sparkConfig</code> 有哪些参数可以传递</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">Property Name</th>
<th align="left">Property group</th>
<th align="left">
<code>spark-submit</code> equivalent</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>spark.master</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--master</code></td>
</tr>
<tr class="even">
<td align="left"><code>spark.kerberos.keytab</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--keytab</code></td>
</tr>
<tr class="odd">
<td align="left"><code>spark.kerberos.principal</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--principal</code></td>
</tr>
<tr class="even">
<td align="left"><code>spark.driver.memory</code></td>
<td align="left">Application Properties</td>
<td align="left"><code>--driver-memory</code></td>
</tr>
<tr class="odd">
<td align="left"><code>spark.driver.extraClassPath</code></td>
<td align="left">Runtime Environment</td>
<td align="left"><code>--driver-class-path</code></td>
</tr>
<tr class="even">
<td align="left"><code>spark.driver.extraJavaOptions</code></td>
<td align="left">Runtime Environment</td>
<td align="left"><code>--driver-java-options</code></td>
</tr>
<tr class="odd">
<td align="left"><code>spark.driver.extraLibraryPath</code></td>
<td align="left">Runtime Environment</td>
<td align="left"><code>--driver-library-path</code></td>
</tr>
</tbody>
</table></div>
<p>将 data.frame 转化为 SparkDataFrame</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faithful_sdf</span> <span class="op">&lt;-</span> <span class="fu">as.DataFrame</span><span class="op">(</span><span class="va">faithful</span><span class="op">)</span></code></pre></div>
<p>SparkDataFrame</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">faithful_sdf</span><span class="op">)</span></code></pre></div>
<p>查看结构</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">faithful_sdf</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="sec-database-with-r" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> 数据库与 R 语言<a class="anchor" aria-label="anchor" href="#sec-database-with-r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/prestodb/presto">Presto</a> 的 R 接口 <a href="https://github.com/prestodb/RPresto" class="uri">https://github.com/prestodb/RPresto</a> 和文档 <a href="https://prestodb.io/docs/current/index.html" class="uri">https://prestodb.io/docs/current/index.html</a>，Presto 数据库</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'RPresto'</span><span class="op">)</span></code></pre></div>
<p>MySQL 为例介绍 odbc 的连接和使用，详见 <a href="https://cosx.org/2020/06/connect-mysql-from-r/">从 R 连接 MySQL</a></p>
<div class="sourceCode" id="cb185"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb185-1"><a href="chap-data-transportation.html#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- !preview conn=DBI::dbConnect(odbc::odbc(),  driver = "MariaDB", database = "demo", </span></span>
<span id="cb185-2"><a href="chap-data-transportation.html#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="co">--                              uid = "root", pwd = "cloud", host = "localhost", port = 3306)</span></span>
<span id="cb185-3"><a href="chap-data-transportation.html#cb185-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-4"><a href="chap-data-transportation.html#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mtcars</span>
<span id="cb185-5"><a href="chap-data-transportation.html#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span></span></code></pre></div>
<p>我的系统已经安装了多款数据库的 ODBC 驱动</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb186-1"><a href="chap-data-transportation.html#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dnf</span> install <span class="at">-y</span> unixODBC unixODBC-devel mariadb mariadb-server mariadb-devel mariadb-connector-odbc</span></code></pre></div>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">odbc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbcListDrivers.html">odbcListDrivers</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code># Driver from the mariadb-connector-odbc package
# Setup from the unixODBC package
[MariaDB]
Description     = ODBC for MariaDB
Driver          = /usr/lib/libmaodbc.so
Driver64        = /usr/lib64/libmaodbc.so
FileUsage       = 1</code></pre>
</div>
<div id="sec-batch-import-csv" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> 批量读取 csv 文件<a class="anchor" aria-label="anchor" href="#sec-batch-import-csv"><i class="fas fa-link"></i></a>
</h2>
<p>iris 数据转化为 data.table 类型，按照 Species 分组拆成单独的 csv 文件，各个文件的文件名用鸢尾花的类别名表示</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 批量分组导出</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fwrite.html">fwrite</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/user_"</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">Species</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>读取文件夹 <code>data/</code> 所有 csv 数据文件</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="va">merged_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"*.csv"</span>, path <span class="op">=</span> <span class="st">"data/"</span><span class="op">)</span>, <span class="va">fread</span> <span class="op">)</span> <span class="op">)</span>
<span class="co"># 或者</span>
<span class="va">merged_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"*.csv"</span>, path <span class="op">=</span> <span class="st">"data/"</span><span class="op">)</span>, <span class="va">fread</span> <span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xdf</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
<span class="va">xdf</span><span class="op">$</span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, origin <span class="op">=</span> <span class="st">"1978-01-01"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/split.html">split</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, <span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">xdf</span><span class="op">$</span><span class="va">study</span>, <span class="va">xdf</span><span class="op">$</span><span class="va">port</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">.x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="op">]</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Filter</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>
  <span class="op">}</span>, <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind.data.frame</span>, <span class="va">.</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="va">xdf</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,
    ts <span class="op">=</span> <span class="fu">anytime</span><span class="fu">::</span><span class="fu">anytime</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">study</span>, <span class="va">port</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>

<span class="va">mtcars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>

<span class="va">mtcars</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">16</span>, width <span class="op">=</span> <span class="fl">69</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 32 × 11
##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
##  2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
##  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
##  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
##  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
##  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
##  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
##  8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
##  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
## 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
## 11  17.8     6  168.   123  3.92  3.44  18.9     1     0     4     4
## 12  16.4     8  276.   180  3.07  4.07  17.4     0     0     3     3
## 13  17.3     8  276.   180  3.07  3.73  17.6     0     0     3     3
## 14  15.2     8  276.   180  3.07  3.78  18       0     0     3     3
## 15  10.4     8  472    205  2.93  5.25  18.0     0     0     3     4
## 16  10.4     8  460    215  3     5.42  17.8     0     0     3     4
## # … with 16 more rows</code></pre>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtcars</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">.</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 32 × 11
##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
## 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
## 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
## 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
## 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
## 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
## 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
## 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
## # … with 24 more rows</code></pre>
</div>
<div id="sec-batch-export-xlsx" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> 批量导出 xlsx 文件<a class="anchor" aria-label="anchor" href="#sec-batch-export-xlsx"><i class="fas fa-link"></i></a>
</h2>
<p>将 R 环境中的数据集导出为 xlsx 表格</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 加载 openxlsx 包</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ycphs.github.io/openxlsx/index.html">openxlsx</a></span><span class="op">)</span>
<span class="co">## 创建空白的工作薄，标题为鸢尾花数据集</span>
<span class="va">wb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/createWorkbook.html">createWorkbook</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"鸢尾花数据集"</span><span class="op">)</span>
<span class="co">## 添加 sheet 页</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/addWorksheet.html">addWorksheet</a></span><span class="op">(</span><span class="va">wb</span>, sheetName <span class="op">=</span> <span class="st">"iris"</span><span class="op">)</span>
<span class="co"># 将数据写进 sheet 页</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/writeData.html">writeData</a></span><span class="op">(</span><span class="va">wb</span>, sheet <span class="op">=</span> <span class="st">"iris"</span>, x <span class="op">=</span> <span class="va">iris</span>, colNames <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># 导出数据到本地</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/saveWorkbook.html">saveWorkbook</a></span><span class="op">(</span><span class="va">wb</span>, file <span class="op">=</span> <span class="st">"iris.xlsx"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ycphs.github.io/openxlsx/index.html">openxlsx</a></span><span class="op">)</span>
<span class="va">xlsxFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"readTest.xlsx"</span>, package <span class="op">=</span> <span class="st">"openxlsx"</span><span class="op">)</span>
<span class="co"># 导入</span>
<span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/read.xlsx.html">read.xlsx</a></span><span class="op">(</span>xlsxFile <span class="op">=</span> <span class="va">xlsxFile</span><span class="op">)</span>
<span class="co"># 导出</span>
<span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/write.xlsx.html">write.xlsx</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">xlsxfile</span><span class="op">)</span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="chap-data-manipulation.html"><span class="header-section-number">5</span> 数据操作</a></div>
<div class="next"><a href="chap-data-visualization.html"><span class="header-section-number">7</span> 数据可视化</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-data-transportation"><span class="header-section-number">6</span> 数据搬运</a></li>
<li>
<a class="nav-link" href="#sec-spark-with-r"><span class="header-section-number">6.1</span> Spark 与 R 语言</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#subsec-sparklyr"><span class="header-section-number">6.1.1</span> sparklyr</a></li>
<li><a class="nav-link" href="#subsec-sparkr"><span class="header-section-number">6.1.2</span> SparkR</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec-database-with-r"><span class="header-section-number">6.2</span> 数据库与 R 语言</a></li>
<li><a class="nav-link" href="#sec-batch-import-csv"><span class="header-section-number">6.3</span> 批量读取 csv 文件</a></li>
<li><a class="nav-link" href="#sec-batch-export-xlsx"><span class="header-section-number">6.4</span> 批量导出 xlsx 文件</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/XiangyunHuang/masr/blob/master/data-transportation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/XiangyunHuang/masr/edit/master/data-transportation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>现代应用统计与 R 语言</strong>" was written by 黄湘云. It was last built on 2021-08-07.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
