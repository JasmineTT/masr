# 数据可视化 {#chap:data-visualization}

```{r}
library(magrittr)
library(ggplot2)
```

- The fragile and perilous art of flipbooking With flipbookr and xaringan <https://evamaerey.github.io/little_flipbooks_library/flipbookr/skeleton>

## 元素 {#sec:elements}

### 标签 {#subsec:axis-label}


```{r usa-quarterly-approval-ratings, fig.showtext=TRUE, fig.cap="美国总统支持率：自1945年第一季度至1974年第四季度"}
data.frame(
  dates = seq.Date(from = as.Date("1945-01-01"), to = as.Date("1974-12-31"), by = "quarter"),
  presidents = as.vector(presidents)
) %>%
  ggplot(aes(x = dates, y = presidents)) +
  geom_line() +
  geom_point(size = 1.5) +
  scale_x_date(date_breaks = "4 year", date_labels = "%Y") +
  labs(
    title = "1945年至1974年美国总统每季度支持率",
    y = "支持率 (%)",
    caption = " 数据源: R 包 datasets "
  ) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn")
```


### 注释 {#subsec:annotation}


[ggtext](https://github.com/wilkelab/ggtext) 包介绍网站 <https://wilkelab.org/ggtext/>

```{r}
library(ggrepel)
set.seed(2020)

dat <- data.frame(
  x = seq(100),
  y = cumsum(rnorm(100))
)

anno_data <- dat %>%
  subset(x %% 25 == 10) %>%
  transform(text = "text")

dat %>%
  ggplot(aes(x, y)) +
  geom_line() +
  geom_label_repel(aes(label = text),
    data = anno_data,
    direction = "y",
    nudge_y = c(-5, 5, 5, 5)
  ) +
  theme_minimal()
```


## 图形 {#sec:figures}

### 瓦片图 {#subsec:tile}

```{r geom-tile,fig.cap="1949-1960年国际航线乘客数量的月度趋势",fig.showtext=TRUE,fig.asp=.8}
expand.grid( months = month.abb, years = 1949:1960) %>% 
  transform(num = as.vector(AirPassengers)) %>% 
  ggplot(aes(x = years, y = months, fill = num)) +
  scale_fill_continuous(type = "viridis") +
  geom_tile(color = "white", size = 0.4) +
  scale_x_continuous(expand = c(0.01, 0.01), breaks = seq(1949, 1960, by = 1), labels = 1949:1960) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn") +
  labs(x = "年", y = "月", fill = "人数")
```


### 函数图 {#subsec:function}

```{r,warning=FALSE}
x <- sort(c(seq(-3, 4, length.out = 201), outer(0:-3, (-1:1)*1e-6, "+")))
plot(x, gamma(x), ylim = c(-20,20), col = "red", type = "l", lwd = 2,
     main = expression(Gamma(x)), xlab = expression(x), ylab = expression(y))
abline(h = 0, v = -3:0, lty = 3, col = "midnightblue")
```

样条函数图

```{r}
xx <- -9:9
plot(xx, sqrt(abs(xx)),  col = "red", xlab = expression(x), ylab = expression(sqrt(abs(x))))
lines(spline(xx, sqrt(abs(xx)), n=101), col = "pink")
```


```{r}
# 稳健估计
x <- sort(rnorm(100))
cH <- 1.35
plot(x, pmin(cH, pmax(-cH, x)), type = "b", main =  "Huber's function", col = "red")
```


```{r}
cut01 <- function(x) pmax(pmin(x, 1), 0)
curve(      x^2 - 1/4, -1.4, 1.5, col = 2, xlab = expression(x), ylab = "", main = expression(x^2 - frac(1,4)))
curve(cut01(x^2 - 1/4), col = "blue", add = TRUE, n = 500)
```

平滑插值

```{r}
# example("smooth", package = "stats", lib.loc = .Library)
presidents[is.na(presidents)] <- 0 # silly
sm <- smooth(presidents)
sm2 <- smooth(presidents, "3RSS")
sm3 <- smooth(presidents, "3R")

plot(presidents, main = "smooth(presidents0, *) :  3R and default 3RS3R")
lines(sm3, col = 3, lwd = 1.5)
lines(sm, col = 2, lwd = 1.25)
```


## 字体 {#sec:fonts}



### 思源字体 {#subsec:showtext}

丘怡轩开发的 [showtext](https://github.com/yixuan/showtext) 包支持丰富的外部字体，支持 Base R 和 ggplot2 图形，图 \@ref(fig:showtext) 嵌入了 5 号思源宋体，图例和坐标轴文本使用 serif 字体，更多详细的使用文档见 @Qiu2015。

```{r font-install,eval=FALSE}
# 安装 showtext 包
install.packages('showtext')
# 思源宋体
showtextdb::font_install(showtextdb::source_han_serif())
# 思源黑体
showtextdb::font_install(showtextdb::source_han_sans())
```

```{r showtext, fig.cap="showtext 包处理图里的中文",fig.showtext=TRUE}
library(ggplot2)
ggplot(iris, aes(Sepal.Length, Sepal.Width)) +
  geom_point(aes(colour = Species)) +
  scale_colour_brewer(palette = "Set1") +
  labs(
    title = "鸢尾花数据的散点图",
    x = "萼片长度", y = "萼片宽度", colour = "鸢尾花类别", 
    caption = "鸢尾花数据集最早见于 Edgar Anderson (1935) "
  ) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn") +
  theme(
    legend.text = element_text(family = "serif", size = 10.54),
    axis.text = element_text(family = "serif", size = 10.54)
    )
```


### 数学字体 {#subsec:fontcm}

Winston Chang 将 Paul Murrell 的 Computer Modern 字体文件打包成 [fontcm](https://github.com/wch/fontcm) 包 [@fontcm]，

```{r}
library(extrafont)
font_addpackage(pkg = "fontcm")
```

查看可被 `pdf()` 图形设备使用的字体列表

```{r}
# 可用的字体
fonts()
```

fontcm 包提供数学字体，`grDevices::embedFonts()` 函数调用 Ghostscript 软件将数学字体嵌入 ggplot2 图形中，达到正确显示数学公式的目的，此方法适用于 pdf 设备保存的图形，对 `cairo_pdf()` 保存的 PDF 格式图形无效。

```{r fontcm, fig.cap = "fontcm 处理数学公式", fig.process=embed_math_fonts, dev = ifelse(knitr::is_html_output(), 'svg', ifelse(knitr::is_latex_output(), 'pdf', 'png')),fig.width=8,fig.height=4}
library(fontcm)
library(ggplot2)
library(extrafont)
library(patchwork)
p <- ggplot(data = data.frame(x = c(1, 5), y = c(1, 5)), aes(x = x, y = y)) +
  geom_point() +
  labs(x = "Made with CM fonts", y = "Made with CM fonts", title = "Made with CM fonts")
# 公式
eq <- "italic(sum(frac(1, n*'!'), n==0, infinity) ==
       lim(bgroup('(', 1 + frac(1, n), ')')^n, n %->% infinity))"
# 默认字体
p1 <- p + annotate("text", x = 3, y = 3, parse = TRUE, label = eq)
# 使用 CM Roman 字体
p2 <- p + annotate("text", x = 3, y = 3, parse = TRUE, label = eq, family = "CM Roman") +
  theme(
    text = element_text(size = 16, family = "CM Roman"),
    axis.title.x = element_text(face = "italic"),
    axis.title.y = element_text(face = "bold")
  )
p1 + p2
```


### TikZ 设备 {#subsec:tikz-device}

与 \@ref(subsec:fontcm) 小节不同，Ralf Stubner 维护的 [**tikzDevice**](https://github.com/daqana/tikzDevice) 包提供了另一种嵌入数学字体的方式，其提供的 `tikzDevice::tikz()` 绘图设备将图形对象转化为 TikZ 代码，调用 LaTeX 引擎编译成 PDF 文档。安装后，先测试一下 LaTeX 编译环境是否正常。

```{r tikz-device}
tikzDevice::tikzTest()
```

确认没有问题后，下面图 \@ref(fig:tikz-regression) 的坐标轴标签，标题，图例等位置都支持数学公式，使用 **tikzDevice** 打造出版级的效果图。更多功能的介绍见 <https://www.daqana.org/tikzDevice/>。

```{r tikz-regression, dev = 'tikz', fig.cap = "线性回归模型", fig.ext='tex', out.width="75%", fig.process=to_png,cache=TRUE,fig.align='center',fig.asp=1,fig.width=4,fig.height=4}
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y,
  main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$",
  sub = "$\\mathcal{N}(\\mathsf{x};\\mu,\\Sigma)$"
)
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright",
  legend = paste0(
    "$y = ",
    round(coef(model)[2], 3),
    "x +",
    round(coef(model)[1], 3),
    "$"
  ),
  bty = "n"
)
```

推荐的全局 LaTeX 环境配置如下：

```{r setup-tinytex,eval=FALSE}
options(
  tinytex.engine = "xelatex",
  tikzDefaultEngine = "xetex",
  tikzDocumentDeclaration = "\\documentclass[UTF8,fontset=adobe]{ctexart}\n",
  tikzXelatexPackages = c(
    "\\usepackage[colorlinks,breaklinks]{hyperref}",
    "\\usepackage{color,times,tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath,amsfonts,mathrsfs,amssymb}"
  )
)
```

设置默认的 LaTeX 编译引擎为 XeLaTeX，相比于 PDFLaTeX，它对中文的兼容性更好，支持多平台下的中文环境，中文字体这里采用了 Adobe 的字体，默认加载了 mathrsfs 宏包支持 `\mathcal`、`\mathscr` 等命令，此外， LaTeX 发行版采用谢益辉自定义的 [TinyTeX](https://yihui.org/tinytex/)。绘制独立的 PDF 图形的过程如下：

```{r,eval=FALSE}
library(tikzDevice)
tf <- file.path(getwd(), "tikz-regression.tex")
tikz(tf, width = 6, height = 5.5, pointsize = 30, standAlone = TRUE)
# 绘图代码
dev.off()
# 编译成 PDF 图形
tinytex::latexmk(file = "tikz-regression.tex")
```


### 漫画字体 {#subsec:xkcd-comic}

下载 XKCD 字体，并刷新系统字体缓存

```bash
mkdir -p ~/.fonts
curl -fLo ~/.fonts/xkcd.ttf http://simonsoftware.se/other/xkcd.ttf
fc-cache -fsv
```

将 XKCD 字体导入到 R 环境，以便后续被 ggplot2 图形设备调用。

```r
R -e 'library(extrafont);font_import(pattern="[X/x]kcd.ttf", prompt = FALSE)'
```

图 \@ref(fig:xkcd-graph) 是一个使用 xkcd 字体的简单例子，更多高级特性请看 **xkcd** 包文档 [@xkcd]

```{r xkcd-graph, fig.cap = "漫画风格的字体方案", dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "cairo_pdf" else "png", out.width="75%"}
library(extrafont)
library(xkcd)
ggplot(aes(mpg, wt), data = mtcars) +
  geom_point() +
  theme_xkcd()
```

## 配色 {#sec:colors}


```{r old-color-palette,fig.show='hold',out.width="45%", fig.subcap=c("terrain.colors 调色板", "heat.colors 调色板", "topo.colors 调色板", "cm.colors 调色板"), fig.cap="R 3.6.0 以前的调色板",fig.ncol = 2}
filled.contour(volcano, nlevels = 10, color.palette = terrain.colors)
filled.contour(volcano, nlevels = 10, color.palette = heat.colors)
filled.contour(volcano, nlevels = 10, color.palette = topo.colors)
filled.contour(volcano, nlevels = 10, color.palette = cm.colors)
```


```{r new-color-palette,fig.show='hold',out.width="45%", fig.subcap=c("Grays 调色板", "YlOrRd 调色板", "Purples 3 调色板", "Viridis 调色板"),fig.cap="R 3.6.0 以后的调色板",fig.ncol = 2}
filled.contour(volcano, nlevels = 10, color.palette = function(n, ...) hcl.colors(n, "Grays", rev = TRUE, ...))
filled.contour(volcano, nlevels = 10, color.palette = function(n, ...) hcl.colors(n, "YlOrRd", rev = TRUE, ...))
filled.contour(volcano, nlevels = 10, color.palette = function(n, ...) hcl.colors(n, "purples", rev = TRUE, ...))
filled.contour(volcano, nlevels = 10, color.palette = function(n, ...) hcl.colors(n, "viridis", rev = FALSE, ...))
```

::: rmdnote
`hcl.colors()` 函数是在 R 3.6.0 引入的，之前的 R 软件版本中没有，同时内置了 110 个调色板，详见 `hcl.pals()`。
:::


### 调色板 {#subsec:color-palettes}

R 预置的灰色有224种，挑出其中的调色板

```{r echo=TRUE}
grep("^gr(a|e)y", grep("gr(a|e)y", colors(), value = TRUE), value = TRUE, invert = TRUE)
```

```{r gray-palettes,fig.cap="灰度调色板"}
gray_colors <- paste0(rep(c("slategray", "darkslategray"), each = 4), seq(4))
barplot(1:8, col = gray_colors, border = NA)
```

gray 与 grey 是一样的，类似 color 和 colour 的关系，可能是美式和英式的差别，且看

```{r,echo=TRUE}
all.equal(col2rgb(paste0("gray", seq(100))), col2rgb(paste0("grey", seq(100))))
```

`gray100` 代表白色，`gray0` 代表黑色，提取灰色调色板，去掉首尾部分是必要的

```{r gray-colors, fig.cap="提取 10 种灰色做调色板"}
barplot(1:8, col = gray.colors(8, start = .3, end = .9), main = "gray.colors function", border = NA)
```



首先选择一组合适的颜色，比如从桃色到梨色，选择6种颜色，以此为基础，可以借助 `grDevices::colorRampPalette()` 函数扩充至想要的数目，用 `graphics::rect()` 函数预览这组颜色配制的调色板

```{r peach-pear-palette,fig.cap="桃色至梨色的渐变",fig.width=8,fig.height=1,collapse=TRUE}
# Colors from https://github.com/johannesbjork/LaCroixColoR
colors_vec <- c("#FF3200", "#E9A17C", "#E9E4A6", "#1BB6AF", "#0076BB", "#172869")
# 代码来自 ?colorspace::rainbow_hcl
pal <- function(n = 20, colors = colors, border = "light gray", ...) {
  colorname <- (grDevices::colorRampPalette(colors))(n)
  plot(0, 0,
    type = "n", xlim = c(0, 1), ylim = c(0, 1),
    axes = FALSE, ...
  )
  rect(0:(n - 1) / n, 0, 1:n / n, 1, col = colorname, border = border)
}
op <- par(mar = rep(0, 4))
pal(n = 20, colors = colors_vec, xlab = "Colors from Peach to Pear", ylab = "")
par(op)
```

`colorRampPalette()` 自制调色板

```{r custom-palettes,fig.cap="colorRampPalette 自制调色板", collapse=TRUE}
create_palette <- function(n = 1000, colors = c("blue", "orangeRed")) {
  color_palette <- colorRampPalette(colors)(n)
  barplot(rep(1, times = n), col = color_palette, border = color_palette, axes = FALSE)
}
op <- par(mfrow = c(3, 1), mar = c(0.1, 0.1, 0.5, 0.1), xaxs = "i", yaxs = "i")
create_palette(n = 1000, colors = c("blue", "orangeRed"))
create_palette(n = 1000, colors = c("darkgreen", "yellow", "orangered"))
create_palette(n = 1000, colors = c("blue", "white", "orangered"))
par(op)
```

```{r rcolorbrewer-palette,fig.height=8,fig.cap="RColorBrewer 调色板"}
op <- par(mar = c(0, 4, 0, 0))
RColorBrewer::display.brewer.all()
par(op)
```


```{r builtin-palettes,fig.height=5.5,fig.width=6,fig.cap="grDevices 调色板 "}
# 代码来自 ?palettes
demo.pal <-
  function(n, border = if (n < 32) "light gray" else NA,
           main = paste("color palettes: alpha = 1,  n=", n),
           ch.col = c(
             "rainbow(n, start=.7, end=.1)", "heat.colors(n)",
             "terrain.colors(n)", "topo.colors(n)",
             "cm.colors(n)", "gray.colors(n, start = 0.3, end = 0.9)"
           )) {
    nt <- length(ch.col)
    i <- 1:n
    j <- n / nt
    d <- j / 6
    dy <- 2 * d
    plot(i, i + d, type = "n", axes = FALSE, ylab = "", xlab = "", main = main)
    for (k in 1:nt) {
      rect(i - .5, (k - 1) * j + dy, i + .4, k * j,
        col = eval(parse(text = ch.col[k])), border = border
      )
      text(2 * j, k * j + dy / 4, ch.col[k])
    }
  }
n <- if (.Device == "postscript") 64 else 16
# Since for screen, larger n may give color allocation problem
op <- par(mar = c(0, 0, 2, 0))
demo.pal(n)
par(op)
```



```{r demo-colors fig.width=8, fig.height=11, fig.align='center', fig.cap="grDevices 调色板", out.width="100%"}
op <- par(mfrow = c(33, 1), mar = c(0, 0, .8, 0))
for (i in seq(32)) {
  pal(n = length((1 + 20 * (i - 1)):(20 * i)), colors()[(1 + 20 * (i - 1)):(20 * i)], main = paste(1 + 20 * (i - 1), "to", 20 * i))
}
pal(n = 17, colors()[641:657], main = "641 to 657")
par(op)
```

```{r colorspace-palette, fig.width=8,fig.height=8,fig.cap="colorspace 调色板", collapse=TRUE}
library(colorspace)
## a few useful diverging HCL palettes
op <- par(mar = c(0,0,2,0), mfrow = c(16, 2))

pal(n = 16, diverge_hcl(16), main = "diverging HCL palettes")
pal(n = 16, diverge_hcl(16, h = c(246, 40), c = 96, l = c(65, 90)))
pal(n = 16, diverge_hcl(16, h = c(130, 43), c = 100, l = c(70, 90)))
pal(n = 16, diverge_hcl(16, h = c(180, 70), c = 70, l = c(90, 95)))

pal(n = 16, diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95)))
pal(n = 16, diverge_hcl(16, h = c(128, 330), c = 98, l = c(65, 90)))
pal(n = 16, diverge_hcl(16, h = c(255, 330), l = c(40, 90)))
pal(n = 16, diverge_hcl(16, c = 100, l = c(50, 90), power = 1))

## sequential palettes
pal(n = 16, sequential_hcl(16), main= "sequential palettes")
pal(n = 16, heat_hcl(16, h = c(0, -100), l = c(75, 40), c = c(40, 80), power = 1))
pal(n = 16, terrain_hcl(16, c = c(65, 0), l = c(45, 95), power = c(1/3, 1.5)))
pal(n = 16, heat_hcl(16, c = c(80, 30), l = c(30, 90), power = c(1/5, 1.5)))

## compare base and colorspace palettes
## (in color and desaturated)
## diverging red-blue colors
pal(n = 16, diverge_hsv(16), main = "diverging red-blue colors")
pal(n = 16, diverge_hcl(16, c = 100, l = c(50, 90)))
pal(n = 16, desaturate(diverge_hsv(16)))
pal(n = 16, desaturate(diverge_hcl(16, c = 100, l = c(50, 90))))

## diverging cyan-magenta colors
pal(n = 16, cm.colors(16), main = "diverging cyan-magenta colors")
pal(n = 16, diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95)))
pal(n = 16, desaturate(cm.colors(16)))
pal(n = 16, desaturate(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95))))

## heat colors
pal(n = 16, heat.colors(16), main = "heat colors")
pal(n = 16, heat_hcl(16))
pal(n = 16, desaturate(heat.colors(16)))
pal(n = 16, desaturate(heat_hcl(16)))

## terrain colors
pal(n = 16, terrain.colors(16), main = "terrain colors")
pal(n = 16, terrain_hcl(16))
pal(n = 16, desaturate(terrain.colors(16)))
pal(n = 16, desaturate(terrain_hcl(16)))

pal(n = 16, rainbow_hcl(16, start = 30, end = 300), main = "dynamic")
pal(n = 16, rainbow_hcl(16, start = 60, end = 240), main = "harmonic")
pal(n = 16, rainbow_hcl(16, start = 270, end = 150), main = "cold")
pal(n = 16, rainbow_hcl(16, start = 90, end = -30), main = "warm")

par(op)
```


除之前提到的 grDevices 包

- [colorspace](http://colorspace.r-forge.r-project.org/) 包 [@R-colorspace] 

- [RColorBrewer](https://CRAN.R-project.org/package=RColorBrewer) 包 [@R-RColorBrewer] <http://colorbrewer2.org/>

- [viridis](https://github.com/sjmgarnier/viridis) 包、

- [dichromat](https://CRAN.R-project.org/package=dichromat) 包

- [colormap](https://github.com/bhaskarvk/colormap) 包基于 node.js 的 colormap 模块提供 44 个预定义的调色板

- [pals](https://github.com/kwstat/pals) 包

- [palr](https://github.com/AustralianAntarcticDivision/palr) 包

- [paletteer](https://github.com/EmilHvitfeldt/paletteer) 包收集了很多 R 包提供的调色板，同时也引入了很多依赖。

- [yarrr](https://github.com/ndphillips/yarrr) 包主要是为书籍 [《YaRrr! The Pirate’s Guide to R》](https://bookdown.org/ndphillips/YaRrr/) <https://github.com/ndphillips/ThePiratesGuideToR> 提供配套资源，兼顾收集了一组[调色板](https://bookdown.org/ndphillips/YaRrr/more-colors.html)。

此外还有 [colorRamps](https://cran.r-project.org/package=colorRamps) 包、[ColorPalette](https://cran.r-project.org/package=ColorPalette) 包、[colortools](https://cran.r-project.org/package=colortools) 包就不一一详细介绍了。



```{r select-color,fig.cap="源起",fig.height=12,collapse=TRUE}
op <- par(mar = c(1, 2, 1, 0), mfrow = c(3, 2))
set.seed(1234)
x <- sample(seq(8), 8, replace = FALSE)
barplot(x, col = palette(), border = "white")
barplot(x, col = heat.colors(8), border = "white")
barplot(x, col = gray.colors(8), border = "white")
barplot(x, col = "lightblue", border = "white")
barplot(x, col = colorspace::sequential_hcl(8), border = "white")
barplot(x, col = colorspace::diverge_hcl(8, h = c(130, 43), c = 100, l = c(70, 90)), border = "white")
par(op)
```


与图 \@ref(fig:geom-tile) 对比，图\@ref(fig:palette-spectral) 的层次更加丰富，识别性更高

```{r palette-spectral,fig.cap="Spectral 调色板",fig.showtext=TRUE,fig.asp=.8}
expand.grid( months = month.abb, years = 1949:1960) %>% 
  transform(num = as.vector(AirPassengers)) %>% 
  ggplot(aes(x = years, y = months, fill = num)) +
  scale_fill_distiller(palette = "Spectral") +
  geom_tile(color = "white", size = 0.4) +
  scale_x_continuous(expand = c(0.01, 0.01), breaks = seq(1949, 1960, by = 1), labels = 1949:1960) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn") +
  labs(x = "年", y = "月", fill = "人数")
```



再举栗子，图 \@ref(fig:faithfuld) 是正负例对比，其中好在哪里呢？这张图要表达美国黄石国家公园的老忠实泉间歇喷发的时间规律，那么好的标准就是层次分明，以突出不同颜色之间的时间差异。这个差异，还要看起来不那么费眼睛，一目了然最好。

```{r faithfuld,fig.cap="美国黄石国家公园的老忠实泉"}
erupt <- ggplot(faithfuld, aes(waiting, eruptions, fill = density)) +
  geom_raster() +
  scale_x_continuous(NULL, expand = c(0, 0)) +
  scale_y_continuous(NULL, expand = c(0, 0)) +
  theme(legend.position = "none")
p1 <- erupt + scale_fill_gradientn(colours = gray.colors(7))
p2 <- erupt + scale_fill_distiller(palette = "Spectral")
p3 <- erupt + scale_fill_gradientn(colours = terrain.colors(7))
p4 <- erupt + scale_fill_continuous(type = 'viridis')
(p1 + p2) / (p3 + p4)
```

RColorBrewer 包 提供了有序 (Sequential) 、定性 (Qualitative) 和发散 (Diverging)  三类调色板，一般来讲，分别适用于连续或有序分类变量、无序分类变量、两类分层对比变量的绘图。再加上强大的 ggplot2 包内置的对颜色处理的函数，如 `scale_alpha_*` 、 `scale_colour_*` 和 `scale_fill_*` 等，详见：

```{r,echo=TRUE}
ls("package:ggplot2", pattern = "scale_col(ou|o)r_")
ls("package:ggplot2", pattern = "scale_fill_")
```



```r
library(ColorPalette)
op <- par(mfrow = c(4, 1), mar = c(0, 0, 2, 0))
pal(generateMonochromaticColors("lightblue", 16), main = "generateMonochromaticColors")
pal(complementColors("lightblue", 16), main = "complementColors")
pal(tetradicColors("lightblue", 16), main = "tetradicColors")
pal(triadicColors("lightblue", 16), main = "triadicColors")
par(op)

library(colorRamps)
op <- par(mfrow = c(6, 1), mar = c(0, 0, 2, 0))
n <- 16
pal(matlab.like(n), main = "matlab.like")
pal(matlab.like2(n), main = "matlab.like2")
pal(blue2green2red(n), main = "blue2green2red")
pal(primary.colors(n), main = "primary.colors")
pal(ygobb(n), main = "ygobb")
pal(rgb.tables(n), main = "rgb.tables")
par(op)

library(viridisLite)
n <- 16
op <- par(mfrow = c(4, 1), mar = c(0, 0, 2, 0))
pal(magma(n, alpha = 1, begin = 0, end = 1))
pal(inferno(n, alpha = 1, begin = 0, end = 1))
pal(plasma(n, alpha = 1, begin = 0, end = 1))
pal(viridis(n, alpha = 1, begin = 0, end = 1))
par(op)

op <- par(mfrow = c(2, 1), mar = c(0, 3, 2, 0))
library(pals)
pals::pal.bands(coolwarm, parula, ocean.haline, cubicl, kovesi.rainbow,
  ocean.phase, brewer.paired(12), stepped,
  main = "Colormap suggestions"
)

# Qualtitative
pals::pal.bands(brewer.accent(8), brewer.dark2(8), brewer.paired(12), brewer.pastel1(9),
  brewer.pastel2(8), brewer.set1(9), brewer.set2(8), brewer.set3(10),
  labels = c(
    "brewer.accent", "brewer.dark2", "brewer.paired", "brewer.pastel1",
    "brewer.pastel2", "brewer.set1", "brewer.set2", "brewer.set3"
  ),
  main = "Brewer qualitative"
)
par(op)

op <- par(mfrow = c(2, 1), mar = c(0, 3, 2, 0))
# Sequential
pals::pal.bands(brewer.blues, brewer.bugn, brewer.bupu, brewer.gnbu, brewer.greens,
  brewer.greys, brewer.oranges, brewer.orrd, brewer.pubu, brewer.pubugn,
  brewer.purd, brewer.purples, brewer.rdpu, brewer.reds, brewer.ylgn,
  brewer.ylgnbu, brewer.ylorbr, brewer.ylorrd,
  main = "Brewer sequential"
)

# Diverging
pals::pal.bands(brewer.brbg, brewer.piyg, brewer.prgn, brewer.puor, brewer.rdbu,
  brewer.rdgy, brewer.rdylbu, brewer.rdylgn, brewer.spectral,
  main = "Brewer diverging"
)
par(op)

colortools::pals()

colortools::wheel(colortools::pals("fish")[1], bg = "white")

yarrr::piratepal(palette = "all")

library(dichromat)
op <- par(mar = c(0, 0, 2, 0), mfrow = c(9, 2))
for (i in seq(17)) {
  pal(colorschemes[[i]], main = names(colorschemes)[i])
}
par(op)

library(colormap)
color_map <- function(colorname, border = "light gray") {
  col <- colormap_pal(colormap = colorname)(25)
  n <- length(col)
  plot(0, 0,
    type = "n", xlim = c(0, 1), ylim = c(0, 1),
    axes = FALSE, xlab = "", ylab = ""
  )
  rect(0:(n - 1) / n, 0, 1:n / n, 1, col = col, border = border)
  text(.5, .5, labels = colorname)
}
op <- par(mfrow = c(22, 2), mar = c(0, 0, 1, 0))
invisible(lapply(unlist(colormaps), color_map))
par(op)
```

### 颜色模式 {#subsec:color-schames}

注意和 LaTeX 宏包 [xcolor](https://www.ctan.org/pkg/xcolor) 的联系

```{r color-exchange,echo=TRUE}
col2rgb("lightblue") # color to  RGB
scales::col2hcl("lightblue") # color to HCL
# palr::col2hex("lightblue") # color to HEX
# colortools::col2HSV("lightblue") # color to HSV

rgb(173, 216, 230, maxColorValue = 255) # RGB to HEX
colorspace::hex2RGB("#ADD8E6") # HEX to RGB
rgb(.678, .847, .902, maxColorValue = 1) # RGB to HEX
rgb2hsv(173, 216, 230, maxColorValue = 255) # RGB to HSV
```


## 交互图形 {#sec:interactive-graphics}

- plotly

```{r,eval=FALSE}
library(plotly)
plot_ly(diamonds, x = ~clarity, y = ~price, color = ~clarity, colors = "Set1") %>%
  add_boxplot() %>%
  config(toImageButtonOptions = list(
    format = "svg", filename = "plot"
  ), displaylogo = FALSE, locale = "zh-CN")
```
